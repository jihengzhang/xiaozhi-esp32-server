# xiaozhi-esp32-server & MR-MCP-Server å®Œæ•´ç³»ç»Ÿè®¾è®¡è¯´æ˜

**åˆ›å»ºæ—¥æœŸ**: 2026å¹´1æœˆ17æ—¥  
**ç‰ˆæœ¬**: 1.0  
**ç›®æ ‡**: æ„å»ºä¸€ä¸ªé›†æˆè¯­éŸ³äº¤äº’ã€æ„å›¾è¯†åˆ«ã€MCPå·¥å…·è°ƒç”¨çš„å®Œæ•´æœ¬åœ°æ™ºèƒ½ç³»ç»Ÿ

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è§ˆ

æœ¬æ–‡æ¡£åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š
1. **ç¬¬ä¸€éƒ¨åˆ†** - xiaozhi-esp32-server ç°æœ‰ç³»ç»Ÿåˆ†æ
2. **ç¬¬äºŒéƒ¨åˆ†** - MR-MCP-Server æ–°ç³»ç»Ÿçš„å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šxiaozhi-esp32-server ç³»ç»Ÿåˆ†æ

## 1.1 ç³»ç»Ÿæ¦‚è¿°

`xiaozhi-esp32-server` æ˜¯ä¸º ESP32 ç¡¬ä»¶è®¾å¤‡ (`xiaozhi-esp32`) æä¾›çš„åç«¯æœåŠ¡ç³»ç»Ÿã€‚ESP32 ç«¯æ˜¯ä¸€ä¸ªåŸºäºç¡¬ä»¶çš„è¯­éŸ³åŠ©æ‰‹ï¼Œè€ŒæœåŠ¡å™¨ç«¯æä¾›äº‘ç«¯çš„ AI èƒ½åŠ›ã€‚ä¸¤ç«¯é€šè¿‡ **MQTT æˆ– WebSocket** åè®®è¿›è¡Œé€šä¿¡ã€‚

### ç³»ç»Ÿç‰¹ç‚¹
- ğŸ™ï¸ **å®Œå…¨æœ¬åœ°åŒ–** - æ‰€æœ‰é€šä¿¡åŸºäºå±€åŸŸç½‘ï¼ˆMQTT/WebSocketï¼‰
- ğŸ§  **äº‘ç«¯æ™ºèƒ½** - ç¦»çº¿æ¨¡å‹ + åœ¨çº¿å¤§æ¨¡å‹åŒå¼•æ“
- ğŸ”§ **MCP å·¥å…·æ”¯æŒ** - çµæ´»çš„å·¥å…·è°ƒç”¨æ¡†æ¶
- ğŸµ **é«˜è´¨é‡éŸ³é¢‘** - æ”¯æŒ Opus ç¼–ç ã€æœ¬åœ° VAD/ASR
- ğŸ“± **å¤šè®¾å¤‡æ”¯æŒ** - å¯åŒæ—¶è¿æ¥å¤šä¸ª ESP32 è®¾å¤‡

## 1.2 ç¡¬ä»¶ç«¯æ¶æ„ (ESP32)

ESP32 ç¡¬ä»¶ç«¯çš„æ ¸å¿ƒæµç¨‹ï¼š

```
éº¦å…‹é£è¾“å…¥
    â†“
AudioService (éŸ³é¢‘é‡‡é›†ã€ç¼–ç ã€VADã€å”¤é†’è¯æ£€æµ‹)
    â†“
æœ¬åœ°è¯†åˆ« (Multinet v7 ç¦»çº¿å‘½ä»¤è¯†åˆ«)
    â”œâ”€ æ£€æµ‹åˆ°å”¤é†’è¯ â†’ æ‰“å¼€éŸ³é¢‘é€šé“
    â”œâ”€ æ£€æµ‹åˆ°é€€å‡ºå‘½ä»¤ â†’ åœæ­¢ç›‘å¬
    â””â”€ ä¸åŒ¹é… â†’ ç»§ç»­ç­‰å¾…
    â†“
Protocol (MQTT/WebSocket)
    â†“
æœåŠ¡å™¨ç«¯å¤„ç†
    â†“
è¿”å›ç»“æœ (STT/TTS/Tool)
    â†“
æ’­æ”¾æ‰¬å£°å™¨
    â†“
æ›´æ–°å±å¹•æ˜¾ç¤º
```

**ç¡¬ä»¶ç«¯ä¸»è¦èƒ½åŠ›ï¼š**
- âœ… æœ¬åœ°éŸ³é¢‘é‡‡é›†å’Œç¼–ç ï¼ˆOpusï¼‰
- âœ… æœ¬åœ°VADè¯­éŸ³æ´»åŠ¨æ£€æµ‹
- âœ… æœ¬åœ°å”¤é†’è¯è¯†åˆ«ï¼ˆMultinet v7ï¼‰
- âœ… æœ¬åœ°ç®€å•å‘½ä»¤æ‰§è¡Œï¼ˆå¦‚ "ok exit"ï¼‰
- âœ… ä¸æœåŠ¡å™¨é€šä¿¡è·å– AI å¤„ç†ç»“æœ

## 1.3 ç³»ç»Ÿæ¡†å›¾ä¸æ•°æ®æµ

### 1.3.1 ç½‘ç»œæ‹“æ‰‘ç»“æ„ (Network Topology)

```mermaid
graph TB
    subgraph ESP32["ğŸ™ï¸ ESP32 ç¡¬ä»¶è®¾å¤‡<br/>(192.168.x.x)"]
        Mic["ğŸ¤ éº¦å…‹é£"]
        Speaker["ğŸ”Š æ‰¬å£°å™¨"]
        Screen["ğŸ“± å±å¹•"]
        Button["ğŸ”˜ æŒ‰é”®"]
        Audio["AudioService<br/>(VAD/å”¤é†’è¯)"]
        Protocol["Protocol Layer<br/>(WebSocket/MQTT)"]
        
        Mic --> Audio
        Audio --> Protocol
        Protocol --> Speaker
        Protocol --> Screen
        Button --> Protocol
    end
    
    subgraph Network["ğŸŒ å±€åŸŸç½‘é€šä¿¡"]
        WS["WebSocket<br/>Port: 8000"]
        MQTT["MQTT Broker<br/>Port: 1883"]
    end
    
    subgraph Server["ğŸ–¥ï¸ æœåŠ¡å™¨<br/>(192.168.1.13)"]
        Intake["ğŸ“¥ Audio Intake<br/>æ¥æ”¶/ç¼“å†²"]
        VAD["ğŸ” VADæ¨¡å—<br/>SileroVAD"]
        ASR["ğŸ—£ï¸ ASRæ¨¡å—<br/>FunASR"]
        LLM["ğŸ§  LLMæ¨¡å—<br/>DoubaoLLM"]
        MCP["ğŸ”§ MCPå¼•æ“<br/>å·¥å…·è°ƒç”¨"]
        TTS["ğŸµ TTSæ¨¡å—<br/>CosyVoice"]
        
        Intake --> VAD
        VAD --> ASR
        ASR --> LLM
        LLM --> MCP
        MCP --> TTS
        TTS --> Intake
    end
    
    Protocol -->|ä¸Šè¡Œ: OpuséŸ³é¢‘| WS
    WS --> Intake
    Intake -->|äº‹ä»¶å‘å¸ƒ| MQTT
    MQTT -->|äº‹ä»¶è®¢é˜…| LLM
    MQTT -->|äº‹ä»¶è®¢é˜…| MCP
    MQTT -->|äº‹ä»¶è®¢é˜…| TTS
    TTS -->|ä¸‹è¡Œ: OpuséŸ³é¢‘| WS
    WS --> Protocol
    
    style ESP32 fill:#e1f5ff
    style Server fill:#f3e5f5
    style Network fill:#fff3e0
```

### 1.3.2 éŸ³é¢‘æ•°æ®æµ (Speech Path)

```mermaid
graph LR
    subgraph Capture["ğŸ¤ æ•è·"]
        A["éº¦å…‹é£<br/>16kHz PCM"]
    end
    
    subgraph LocalProc["ğŸ“± æœ¬åœ°å¤„ç†<br/>ESP32"]
        B["VADæ£€æµ‹<br/>è¯­éŸ³æ®µ"]
        C["Opusç¼–ç <br/>128kbps"]
    end
    
    subgraph Transport["ğŸŒ ç½‘ç»œä¼ è¾“"]
        D["WebSocket<br/>Port 8000"]
    end
    
    subgraph ServerProc["ğŸ–¥ï¸ æœåŠ¡å™¨å¤„ç†"]
        E["Audio Intake<br/>ç¼“å†²ç®¡ç†"]
        F["VADæ¨¡å—<br/>è¯­éŸ³æ´»åŠ¨æ£€æµ‹"]
        G["ASRæ¨¡å—<br/>FunASRè¯†åˆ«"]
    end
    
    subgraph Response["ğŸ’¬ ç”Ÿæˆå›å¤"]
        H["LLMå¤„ç†<br/>ç†è§£æ„å›¾"]
        I["MCPæ‰§è¡Œ<br/>å·¥å…·è°ƒç”¨"]
        J["TTSåˆæˆ<br/>è¯­éŸ³ç”Ÿæˆ"]
        K["Opusç¼–ç <br/>128kbps"]
    end
    
    subgraph Playback["ğŸ”Š æ’­æ”¾"]
        L["æ‰¬å£°å™¨<br/>è¾“å‡º"]
    end
    
    A -->|å®æ—¶é‡‡é›†| B
    B -->|å‹ç¼©ç¼–ç | C
    C -->|WebSocketå‘é€| D
    D -->|æ¥æ”¶| E
    E -->|MQTTäº‹ä»¶| F
    F -->|MQTTäº‹ä»¶| G
    
    G -->|è¯†åˆ«æ–‡æœ¬| H
    H -->|å·¥å…·è¯·æ±‚| I
    I -->|ç”Ÿæˆæ–‡æœ¬| J
    J -->|ç¼–ç å‹ç¼©| K
    K -->|WebSocketè¿”å›| D
    D -->|æ¥æ”¶| L
    
    style Capture fill:#c8e6c9
    style LocalProc fill:#bbdefb
    style Transport fill:#ffe0b2
    style ServerProc fill:#f8bbd0
    style Response fill:#d1c4e9
    style Playback fill:#c8e6c9
```

### 1.3.3 æ§åˆ¶æ•°æ®æµ (Control Path)

```mermaid
graph TD
    subgraph User["ğŸ‘¤ ç”¨æˆ·äº¤äº’"]
        A["è¯´è¯<br/>è§¦å‘VAD"]
        B["æŒ‰é”®<br/>äº‹ä»¶"]
        C["å”¤é†’è¯<br/>Multinet"]
    end
    
    subgraph Local["ğŸ“± ESP32<br/>æœ¬åœ°å¤„ç†"]
        D["æ‰“å¼€éŸ³é¢‘<br/>é€šé“"]
        E["ç¼–ç Opus<br/>éŸ³é¢‘"]
    end
    
    subgraph WS["ğŸŒ WebSocket<br/>é€šä¿¡"]
        F["JSONæ¶ˆæ¯<br/>Port 8000"]
    end
    
    subgraph ServerAI["ğŸ–¥ï¸ æœåŠ¡å™¨å¤„ç†"]
        G["ASRè¯†åˆ«<br/>è·å–æ–‡æœ¬"]
        H["LLMåˆ†æ<br/>ç†è§£æ„å›¾"]
        I{"éœ€è¦å·¥å…·<br/>è°ƒç”¨?"}
    end
    
    subgraph MCPExec["ğŸ”§ MCPå·¥å…·æ‰§è¡Œ"]
        J["æŸ¥è¯¢å·¥å…·<br/>åˆ—è¡¨"]
        K["å‚æ•°éªŒè¯<br/>è½¬æ¢"]
        L["æ‰§è¡Œå·¥å…·"]
        M["è¿”å›ç»“æœ"]
    end
    
    subgraph Feedback["ğŸ“¤ è¿”å›ESP32"]
        N["JSONæ ¼å¼<br/>WebSocket"]
        O["å±å¹•æ›´æ–°"]
        P["éŸ³é¢‘æ’­æ”¾"]
    end
    
    A --> D
    B --> F
    C --> D
    D --> E
    E --> F
    F --> G
    G --> H
    H --> I
    I -->|æ˜¯| J
    I -->|å¦| N
    J --> K
    K --> L
    L --> M
    M --> N
    N --> O
    N --> P
    
    style User fill:#fff9c4
    style Local fill:#bbdefb
    style ServerAI fill:#f8bbd0
    style MCPExec fill:#d1c4e9
    style Feedback fill:#c8e6c9
```

### 1.3.4 MQTTäº‹ä»¶æ€»çº¿ (Internal Message Bus)

```mermaid
graph TB
    subgraph MQTT["ğŸšŒ MQTT Broker<br/>Port 1883<br/>äº‹ä»¶æ€»çº¿"]
        subgraph Audio["Audioä¸»é¢˜"]
            A1["xiaozhi/audio/intake"]
            A2["xiaozhi/audio/vad/start"]
            A3["xiaozhi/audio/vad/end"]
        end
        
        subgraph ASRTopic["ASRä¸»é¢˜"]
            B1["xiaozhi/asr/interim"]
            B2["xiaozhi/asr/final"]
        end
        
        subgraph Intent["Intentä¸»é¢˜"]
            C1["xiaozhi/intent/detected"]
            C2["xiaozhi/intent/confidence"]
        end
        
        subgraph MCPTopic["MCPä¸»é¢˜"]
            D1["xiaozhi/mcp/tool/list"]
            D2["xiaozhi/mcp/tool/call"]
            D3["xiaozhi/mcp/tool/result"]
        end
        
        subgraph TTSTopic["TTSä¸»é¢˜"]
            E1["xiaozhi/tts/generated"]
            E2["xiaozhi/tts/ready"]
        end
    end
    
    subgraph Publishers["ğŸ“¤ å‘å¸ƒè€…"]
        P1["Audio Intake"]
        P2["VADæ¨¡å—"]
        P3["ASRæ¨¡å—"]
        P4["LLMæ¨¡å—"]
        P5["MCPæ¨¡å—"]
        P6["TTSæ¨¡å—"]
    end
    
    subgraph Subscribers["ğŸ“¥ è®¢é˜…è€…"]
        S1["ASRè®¢é˜…<br/>Audioäº‹ä»¶"]
        S2["LLMè®¢é˜…<br/>ASRç»“æœ"]
        S3["MCPè®¢é˜…<br/>æ„å›¾"]
        S4["TTSè®¢é˜…<br/>æ„å›¾"]
        S5["æ—¥å¿—ç³»ç»Ÿ<br/>è®¢é˜…å…¨éƒ¨"]
    end
    
    P1 --> A1
    P2 --> A2
    P2 --> A3
    P3 --> B1
    P3 --> B2
    P4 --> C1
    P4 --> C2
    P5 --> D1
    P5 --> D2
    P5 --> D3
    P6 --> E1
    P6 --> E2
    
    A1 --> S1
    B2 --> S2
    C1 --> S3
    C1 --> S4
    A1 --> S5
    B1 --> S5
    B2 --> S5
    C1 --> S5
    D1 --> S5
    D2 --> S5
    D3 --> S5
    E1 --> S5
    E2 --> S5
    
    style MQTT fill:#fff3e0
    style Publishers fill:#c8e6c9
    style Subscribers fill:#f8bbd0
```

### 1.3.5 å®Œæ•´çš„å¯¹è¯äº¤äº’æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User as ğŸ‘¤ ç”¨æˆ·
    participant ESP32 as ğŸ“± ESP32
    participant WS as ğŸŒ WebSocket
    participant Server as ğŸ–¥ï¸ æœåŠ¡å™¨
    participant MQTT as ğŸšŒ MQTT
    participant LLM as ğŸ§  LLM
    participant MCP as ğŸ”§ MCP
    participant TTS as ğŸµ TTS
    
    User->>ESP32: è¯´è¯"å¤©æ°”æ€ä¹ˆæ ·"
    ESP32->>ESP32: VADæ£€æµ‹è¯­éŸ³
    ESP32->>ESP32: Opusç¼–ç éŸ³é¢‘
    
    ESP32->>WS: å‘é€OpuséŸ³é¢‘æµ
    WS->>Server: è½¬å‘åˆ°Audio Intake
    Server->>Server: ç¼“å†²ç®¡ç†
    
    Server->>MQTT: å‘å¸ƒaudio/intake
    MQTT->>Server: ASRè®¢é˜…æ¥æ”¶
    Server->>Server: FunASRè¯†åˆ«
    Server->>MQTT: å‘å¸ƒasr/final<br/>"å¤©æ°”æ€ä¹ˆæ ·"
    
    MQTT->>LLM: LLMè®¢é˜…æ¥æ”¶
    LLM->>LLM: ç†è§£æ„å›¾â†’get_weather
    LLM->>MQTT: å‘å¸ƒintent/detected
    
    MQTT->>MCP: MCPè®¢é˜…æ¥æ”¶
    MCP->>MCP: æ‰§è¡Œget_weather()
    MCP->>MQTT: å‘å¸ƒtool/result<br/>"åŒ—äº¬æ™´å¤©5Â°C"
    
    MQTT->>LLM: LLMè®¢é˜…ç»“æœ
    LLM->>LLM: ç”Ÿæˆå›å¤æ–‡æœ¬
    
    MQTT->>TTS: TTSè®¢é˜…æ¥æ”¶
    TTS->>TTS: CosyVoiceåˆæˆ
    TTS->>MQTT: å‘å¸ƒtts/ready
    
    MQTT->>Server: è·å–TTSéŸ³é¢‘
    Server->>WS: è¿”å›éŸ³é¢‘æµ
    WS->>ESP32: æ¥æ”¶OpuséŸ³é¢‘
    
    ESP32->>ESP32: Opusè§£ç PCM
    ESP32->>User: ğŸ”Š æ’­æ”¾è¯­éŸ³<br/>"ä»Šå¤©åŒ—äº¬æ™´å¤©..."
    ESP32->>ESP32: å±å¹•æ˜¾ç¤ºæ–‡æœ¬
```

## 1.4 æœåŠ¡å™¨ç«¯æ¶æ„ (xiaozhi-esp32-server)

æœåŠ¡å™¨ç«¯æ˜¯ Python å®ç°çš„å¾®æœåŠ¡ç³»ç»Ÿï¼Œè´Ÿè´£æ¥æ”¶æ¥è‡ª ESP32 çš„éŸ³é¢‘ï¼Œè¿›è¡Œå¤„ç†ï¼Œå¹¶è¿”å›ç»“æœã€‚

### æ ¸å¿ƒæœåŠ¡æµç¨‹

```
ESP32 è®¾å¤‡ (WebSocket/MQTT)
    â†“
WebSocket/MQTT æœåŠ¡å™¨ (Port: 8000)
    â”‚
    â”œâ”€ Audio Intake æœåŠ¡
    â”‚   â”œâ”€ æ¥æ”¶ Opus ç¼–ç éŸ³é¢‘
    â”‚   â””â”€ ç¼“å†²ç®¡ç†
    â”‚
    â”œâ”€ VAD æœåŠ¡ (è¯­éŸ³æ´»åŠ¨æ£€æµ‹)
    â”‚   â”œâ”€ æ£€æµ‹è¯­éŸ³å¼€å§‹/ç»“æŸ
    â”‚   â””â”€ äº‹ä»¶å‘å¸ƒåˆ° MQTT
    â”‚
    â”œâ”€ ASR æœåŠ¡ (è¯­éŸ³è¯†åˆ«)
    â”‚   â”œâ”€ FunASR å¼•æ“
    â”‚   â””â”€ å®æ—¶è½¬å†™
    â”‚
    â”œâ”€ LLM æœåŠ¡ (æ„å›¾è¯†åˆ«)
    â”‚   â”œâ”€ DoubaoLLM æˆ–å…¶ä»–
    â”‚   â””â”€ ä¸Šä¸‹æ–‡ç®¡ç†
    â”‚
    â”œâ”€ MCP æœåŠ¡ (å·¥å…·è°ƒç”¨)
    â”‚   â”œâ”€ å·¥å…·å®šä¹‰åŠ è½½
    â”‚   â””â”€ å·¥å…·æ‰§è¡Œå’Œè¿”å›
    â”‚
    â””â”€ TTS æœåŠ¡ (æ–‡æœ¬è½¬è¯­éŸ³)
        â”œâ”€ æ–‡æœ¬åˆæˆ
        â””â”€ Opus ç¼–ç è¿”å›
        
    â†“
è¿”å›åˆ° ESP32 (éŸ³é¢‘/æ–‡æœ¬/æŒ‡ä»¤)
```

### é€šä¿¡åè®®

**ESP32 â†’ æœåŠ¡å™¨ï¼š**
- åŸå§‹ Opus ç¼–ç éŸ³é¢‘æµ
- éŸ³é¢‘å¸§å…ƒæ•°æ®ï¼ˆé‡‡æ ·ç‡ã€é€šé“æ•°ç­‰ï¼‰

**æœåŠ¡å™¨ â†’ ESP32ï¼š**
```json
{
    "type": "stt",          // è¯­éŸ³è½¬æ–‡æœ¬ç»“æœ
    "text": "ä½ å¥½",
    "is_final": true
}
```

```json
{
    "type": "tts",          // TTS éŸ³é¢‘è¿”å›
    "data": "base64_encoded_opus_data"
}
```

```json
{
    "type": "tool",         // MCP å·¥å…·è°ƒç”¨ç»“æœ
    "tool_name": "get_weather",
    "result": "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ¸©åº¦ 5Â°C"
}
```

```json
{
    "type": "system",       // ç³»ç»Ÿå‘½ä»¤
    "command": "reboot"
}
```

## 1.4 æœåŠ¡å™¨ç«¯æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. WebSocket/MQTT æœåŠ¡å™¨

```yaml
æœåŠ¡: audio_intake (FastAPI + WebSocket)
åœ°å€: ws://192.168.1.13:8000/xiaozhi/v1/
åŠŸèƒ½:
  - æ¥æ”¶æ¥è‡ªå¤šä¸ª ESP32 è®¾å¤‡çš„éŸ³é¢‘æµ
  - ç¼“å†²ç®¡ç†å’Œæµæ§åˆ¶
  - å°†éŸ³é¢‘åˆ†å‘åˆ° VAD/ASR å¤„ç†ç®¡é“
```

### 2. VAD æœåŠ¡ (è¯­éŸ³æ´»åŠ¨æ£€æµ‹)

```yaml
æœåŠ¡: VAD (Voice Activity Detection)
æ¨¡å‹: SileroVAD (æœ¬åœ°ç¦»çº¿)
åŠŸèƒ½:
  - æ£€æµ‹éŸ³é¢‘ä¸­æ˜¯å¦åŒ…å«è¯­éŸ³
  - æ£€æµ‹è¯­éŸ³å¼€å§‹å’Œç»“æŸç‚¹
  - å‘å¸ƒ MQTT äº‹ä»¶: mr-mcp/audio/vad/start, mr-mcp/audio/vad/end
```

### 3. ASR æœåŠ¡ (è¯­éŸ³è¯†åˆ«)

```yaml
æœåŠ¡: ASR (Automatic Speech Recognition)
æ¨¡å‹: FunASR (æœ¬åœ°ç¦»çº¿)
åŠŸèƒ½:
  - å°†éŸ³é¢‘è½¬æ¢ä¸ºæ–‡æœ¬
  - æ”¯æŒå®æ—¶è½¬å†™ï¼ˆæµå¼è¯†åˆ«ï¼‰
  - è¿”å›è¯†åˆ«ç»“æœåˆ° WebSocket å®¢æˆ·ç«¯
  ç‰ˆæœ¬: FunASR 1.2.7
```

### 4. LLM æœåŠ¡ (å¤§è¯­è¨€æ¨¡å‹)

```yaml
æœåŠ¡: LLM (å¤§æ¨¡å‹)
æ”¯æŒ: DoubaoLLM, OpenAI GPT, æœ¬åœ° Ollama ç­‰
åŠŸèƒ½:
  - ç†è§£ç”¨æˆ·æ„å›¾
  - ç”Ÿæˆå›å¤æ–‡æœ¬
  - è°ƒç”¨ MCP å·¥å…·
  - ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆå¤šè½®å¯¹è¯ï¼‰
```

### 5. MCP å·¥å…·æœåŠ¡

```yaml
æœåŠ¡: MCP (Model Context Protocol)
åŠŸèƒ½:
  - å·¥å…·å®šä¹‰å’Œæ³¨å†Œ
  - ä» LLM æ¥æ”¶å·¥å…·è°ƒç”¨è¯·æ±‚
  - æ‰§è¡Œæœ¬åœ°å·¥å…·æˆ–è°ƒç”¨å¤–éƒ¨ API
  - è¿”å›æ‰§è¡Œç»“æœ
ç¤ºä¾‹å·¥å…·:
  - è·å–å¤©æ°” (get_weather)
  - æ’­æ”¾éŸ³ä¹ (play_music)
  - æ§åˆ¶å®¶ç”µ (smart_home_control)
  - è·å–æ–°é—» (get_news)
```

### 6. TTS æœåŠ¡ (æ–‡æœ¬è½¬è¯­éŸ³)

```yaml
æœåŠ¡: TTS (Text-To-Speech)
å¼•æ“: CosyVoice æˆ–å…¶ä»–
åŠŸèƒ½:
  - å°†æ–‡æœ¬è½¬æ¢ä¸ºè¯­éŸ³
  - Opus ç¼–ç è¾“å‡º
  - æ”¯æŒå¤šç§éŸ³è‰²å’Œè¯­è¨€
  - è¿”å›éŸ³é¢‘åˆ° ESP32
```

## 1.5 äº‹ä»¶é©±åŠ¨æ¶æ„ (MQTT)

æœåŠ¡å™¨å†…éƒ¨ä½¿ç”¨ **MQTT** ä½œä¸ºäº‹ä»¶æ€»çº¿ï¼Œå„æœåŠ¡é€šè¿‡å‘å¸ƒ/è®¢é˜…è¿›è¡Œé€šä¿¡ï¼š

```
ä¸»é¢˜ç»“æ„: xiaozhi/<device_id>/<module>/<event>

ä¾‹å¦‚:
xiaozhi/device_001/audio/vad/start      - VAD æ£€æµ‹åˆ°è¯­éŸ³å¼€å§‹
xiaozhi/device_001/audio/vad/end        - VAD æ£€æµ‹åˆ°è¯­éŸ³ç»“æŸ
xiaozhi/device_001/asr/interim          - ASR ä¸­é—´è¯†åˆ«ç»“æœ
xiaozhi/device_001/asr/final            - ASR æœ€ç»ˆè¯†åˆ«ç»“æœ
xiaozhi/device_001/intent/detected      - æ„å›¾è¯†åˆ«å®Œæˆ
xiaozhi/device_001/mcp/tool_call        - MCP å·¥å…·è°ƒç”¨è¯·æ±‚
xiaozhi/device_001/tts/ready            - TTS éŸ³é¢‘ç”Ÿæˆå®Œæˆ
```

## 1.6 é¡¹ç›®æ–‡ä»¶ç»“æ„

```
xiaozhi-esp32-server/
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ xiaozhi-server/          # Python æœåŠ¡å™¨å®ç°
â”‚   â”‚   â”œâ”€â”€ app.py               # ä¸»åº”ç”¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ requirements.txt     # ä¾èµ–
â”‚   â”‚   â”œâ”€â”€ config.yaml          # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”‚   â”œâ”€â”€ providers/       # æœåŠ¡æä¾›è€…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ asr/        # ASR (FunASR)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ vad/        # VAD (SileroVAD)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tts/        # TTS
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ llm/        # LLM (DoubaoLLM/OpenAI)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ mcp/        # MCP å·¥å…·æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â””â”€â”€ handlers/       # æ¶ˆæ¯å¤„ç†
â”‚   â”‚   â””â”€â”€ websocket_server.py  # WebSocket æœåŠ¡
â”‚   â”‚
â”‚   â””â”€â”€ esp/
â”‚       â””â”€â”€ xiaozhi-esp32/       # ESP32 å›ºä»¶ä»£ç 
â”‚           â”œâ”€â”€ main/           # åº”ç”¨é€»è¾‘
â”‚           â”‚   â”œâ”€â”€ application.cc   # ä¸»çŠ¶æ€æœº
â”‚           â”‚   â”œâ”€â”€ protocol/        # MQTT/WebSocket åè®®
â”‚           â”‚   â”œâ”€â”€ audio_service.cc # éŸ³é¢‘é‡‡é›†
â”‚           â”‚   â””â”€â”€ mcp_server.cc    # MCP å·¥å…·æœåŠ¡
â”‚           â”œâ”€â”€ components/      # ç¡¬ä»¶é©±åŠ¨
â”‚           â””â”€â”€ boards/         # æ¿å¡æ”¯æŒ
â”‚
â”œâ”€â”€ docker-compose.yml           # å®¹å™¨ç¼–æ’
â”œâ”€â”€ Dockerfile-server            # æœåŠ¡å™¨é•œåƒ
â””â”€â”€ docs/
    â”œâ”€â”€ Deployment.md            # éƒ¨ç½²æŒ‡å—
    â””â”€â”€ mcp-endpoint-integration.md
```

## 1.7 éƒ¨ç½²æ–¹å¼

### éƒ¨ç½²æ–¹å¼ 1ï¼šDocker å®¹å™¨

```bash
# ä¸€é”®å¯åŠ¨æœåŠ¡å™¨
docker compose up -d

# éªŒè¯æœåŠ¡
curl http://localhost:8003/xiaozhi/ota/
```

**æœåŠ¡åœ°å€ï¼š**
- WebSocket: `ws://192.168.1.13:8000/xiaozhi/v1/`
- HTTP (OTA/Vision): `http://192.168.1.13:8003/xiaozhi/ota/`

### éƒ¨ç½²æ–¹å¼ 2ï¼šæœ¬åœ°æºç è¿è¡Œ

```bash
# åˆ›å»º conda ç¯å¢ƒ
conda create -n xiaozhi-esp32-server python=3.10 -y
conda activate xiaozhi-esp32-server
conda install libopus ffmpeg -y

# å®‰è£…ä¾èµ–
cd main/xiaozhi-server
pip install -r requirements.txt

# é…ç½®æ–‡ä»¶
# ç¼–è¾‘ data/.config.yaml (æˆ– config.yaml)

# è¿è¡ŒæœåŠ¡å™¨
python app.py
```

## 1.8 å…³é”®é…ç½®è¯´æ˜

### config.yaml æ ¸å¿ƒé…ç½®é¡¹

```yaml
# LLM é…ç½®ï¼ˆå¿…é¡»é…ç½® API Keyï¼‰
llm:
  provider: doubao        # æ”¯æŒ: doubao, openai, ollama, local
  api_key: "your-api-key"
  model: "gpt-4"

# ASR é…ç½®
asr:
  provider: funasr       # FunASR ç¦»çº¿è¯†åˆ«
  model_path: models/SenseVoiceSmall/model.pt
  
# VAD é…ç½®
vad:
  provider: silero       # SileroVAD ç¦»çº¿æ£€æµ‹
  
# TTS é…ç½®
tts:
  provider: cosyvoice    # CosyVoice æˆ–å…¶ä»–
  
# WebSocket é…ç½®
websocket:
  host: 0.0.0.0
  port: 8000
  path: /xiaozhi/v1/
```

## 1.9 å…¸å‹å¯¹è¯æµç¨‹

```
ESP32 ç”¨æˆ·è¯´è¯:
  "å¤©æ°”æ€ä¹ˆæ ·"
    â†“
[ESP32] æœ¬åœ° VAD æ£€æµ‹åˆ°è¯­éŸ³ â†’ æ‰“å¼€éŸ³é¢‘é€šé“
    â†“
[ESP32] æœ¬åœ° Multinet æ£€æµ‹åˆ°å”¤é†’è¯ "å°æ™º"
    â†“
[ESP32] å‘é€éŸ³é¢‘åˆ°æœåŠ¡å™¨ (WebSocket/MQTT)
    â†“
[æœåŠ¡å™¨] Audio Intake æ¥æ”¶éŸ³é¢‘
    â†“
[æœåŠ¡å™¨] VAD æ£€æµ‹è¯­éŸ³æ®µè½
    â†“
[æœåŠ¡å™¨] ASR (FunASR) è¯†åˆ«: "å¤©æ°”æ€ä¹ˆæ ·"
    â†“
[æœåŠ¡å™¨] LLM (DoubaoLLM) ç†è§£æ„å›¾ â†’ è°ƒç”¨ MCP å·¥å…·
    â†“
[æœåŠ¡å™¨] MCP å·¥å…·æ‰§è¡Œ: get_weather()
    â†“
[æœåŠ¡å™¨] è·å–ç»“æœ: "åŒ—äº¬ä»Šå¤©æ™´å¤© 5Â°C"
    â†“
[æœåŠ¡å™¨] LLM ç”Ÿæˆè‡ªç„¶è¯­è¨€å›å¤
    â†“
[æœåŠ¡å™¨] TTS (CosyVoice) ç”Ÿæˆè¯­éŸ³
    â†“
[æœåŠ¡å™¨] è¿”å›è¯­éŸ³åˆ° ESP32 (WebSocket/MQTT)
    â†“
[ESP32] æ’­æ”¾è¯­éŸ³åˆ°æ‰¬å£°å™¨
    â†“
å¯¹è¯å®Œæˆï¼Œå›åˆ°å¾…æœºçŠ¶æ€
```

---

# ç¬¬äºŒéƒ¨åˆ†ï¼šMR-MCP-Server è¯¦ç»†è®¾è®¡

## 2.1 è®¾è®¡ç›®æ ‡ä¸åŸåˆ™

### è®¾è®¡ç›®æ ‡
1. âœ… **è¿œç¨‹éŸ³é¢‘è¾“å…¥** - Streamlit Web UI é€šè¿‡ Opus ç¼–ç ä¼ è¾“éŸ³é¢‘
2. âœ… **å†…éƒ¨é€šä¿¡** - åŸºäº Socket/MQTT æ¶æ„çš„æœåŠ¡é—´é€šä¿¡
3. âœ… **å®æ—¶å¤„ç†** - å¤šçº¿ç¨‹å¹¶å‘å¤„ç†è¯­éŸ³æµ
4. âœ… **MCPå·¥å…·é›†æˆ** - çµæ´»çš„å·¥å…·è°ƒç”¨æ¡†æ¶
5. âœ… **æœ¬åœ°éƒ¨ç½²** - å®Œå…¨åŸºäºå±€åŸŸç½‘ï¼Œæ— äº’è”ç½‘ä¾èµ–
6. âœ… **çŠ¶æ€ç®¡ç†** - åˆ†å¸ƒå¼çŠ¶æ€åŒæ­¥

### è®¾è®¡åŸåˆ™
- **æ¨¡å—åŒ–** - å„æœåŠ¡ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
- **äº‹ä»¶é©±åŠ¨** - åŸºäºMQTTçš„æ¾è€¦åˆæ¶æ„
- **é«˜å¯ç”¨** - è‡ªåŠ¨æ¢å¤å’Œé‡è¯•æœºåˆ¶
- **æ˜“æ‰©å±•** - å·¥å…·æ¡†æ¶ç®€åŒ–æ·»åŠ æ–°åŠŸèƒ½
- **å¯è§‚æµ‹** - å®Œæ•´çš„æ—¥å¿—å’Œç›‘æ§

## 2.2 ç³»ç»Ÿçº§æ¶æ„æ¡†å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚ (User Client 192.168.0.10)"
        Browser["ğŸŒ Streamlit Web UI"]
        Opus["ğŸ™ï¸ Opusç¼–ç å™¨<br/>è´¨é‡: 128kbps<br/>é‡‡æ ·ç‡: 16kHz"]
    end
    
    subgraph "ç½‘ç»œä¼ è¾“å±‚"
        WS["ğŸ”Œ WebSocket<br/>éŸ³é¢‘æµé€šé“<br/>ws://192.168.1.13:8000"]
        MQTT["ğŸ“¡ MQTT Broker<br/>äº‹ä»¶æ€»çº¿<br/>192.168.1.13:1883"]
    end
    
    subgraph "æœåŠ¡å¤„ç†å±‚ (192.168.1.13)"
        Intake["ğŸ“¥ éŸ³é¢‘IntakeæœåŠ¡<br/>- Opusè§£ç <br/>- ç¼“å†²ç®¡ç†<br/>- æµæ§åˆ¶"]
        
        VAD["ğŸ” VADæœåŠ¡<br/>- è¯­éŸ³æ£€æµ‹<br/>- ç«¯ç‚¹æ£€æµ‹<br/>- äº‹ä»¶å‘å¸ƒ"]
        
        ASR["ğŸ—£ï¸ ASRæœåŠ¡<br/>- FunASRå¼•æ“<br/>- å®æ—¶è½¬å†™<br/>- ç½®ä¿¡åº¦è¯„ä¼°"]
        
        Intent["ğŸ§  æ„å›¾è¯†åˆ«æœåŠ¡<br/>- å¤§æ¨¡å‹æ¨ç†<br/>- ä¸Šä¸‹æ–‡ç®¡ç†<br/>- æ§½ä½å¡«å……"]
        
        MCP["ğŸ”§ MCPæ‰§è¡Œå¼•æ“<br/>- å·¥å…·è·¯ç”±<br/>- å‚æ•°éªŒè¯<br/>- å¼‚å¸¸å¤„ç†"]
        
        Reply["âœï¸ å›å¤ç”Ÿæˆ<br/>- æ–‡æœ¬ç”Ÿæˆ<br/>- æ ¼å¼åŒ–<br/>- ä¸Šä¸‹æ–‡æ•´åˆ"]
        
        TTS["ğŸµ TTSæœåŠ¡<br/>- CosyVoiceåˆæˆ<br/>- Opusç¼–ç <br/>- æƒ…æ„Ÿå¤„ç†"]
    end
    
    subgraph "å­˜å‚¨å±‚"
        History["ğŸ’¾ å¯¹è¯å†å²<br/>MongoDB<br/>- ç”¨æˆ·ä¼šè¯<br/>- ä¸Šä¸‹æ–‡è®°å½•"]
        Cache["âš¡ ç¼“å­˜å±‚<br/>Redis<br/>- ä¼šè¯çŠ¶æ€<br/>- é¢‘ç¹æŸ¥è¯¢"]
        Config["âš™ï¸ é…ç½®ä¸­å¿ƒ<br/>JSON/YAML<br/>- MCPå®šä¹‰<br/>- å·¥å…·å‚æ•°"]
    end
    
    Browser -->|"Opusç¼–ç <br/>WebSocket"| WS
    WS --> Intake
    
    Intake -->|"PCMéŸ³é¢‘"| VAD
    VAD -->|"è¯­éŸ³äº‹ä»¶"| MQTT
    
    VAD -->|"éŸ³é¢‘æ®µ"| ASR
    ASR -->|"æ–‡æœ¬"| MQTT
    
    ASR -->|"è¯†åˆ«æ–‡æœ¬"| Intent
    Intent -->|"æ„å›¾"| MQTT
    Intent <-->|"è¯»å†™"| History
    Intent <-->|"æŸ¥è¯¢"| Cache
    
    Intent -->|"MCPè¯·æ±‚"| MCP
    MCP -->|"æ“ä½œç»“æœ"| Reply
    MCP <-->|"å·¥å…·å®šä¹‰"| Config
    
    Reply -->|"ç”Ÿæˆæ–‡æœ¬"| TTS
    TTS -->|"è¯­éŸ³æ•°æ®<br/>WebSocket"| WS
    WS -->|"Opusç¼–ç "| Browser
```


## 2.3 Opus éŸ³é¢‘ç¼–ç è§„èŒƒ

### ç¼–ç å‚æ•°

```yaml
opus_config:
  é‡‡æ ·ç‡: 16kHz           # è¯­éŸ³ä¼˜åŒ–é¢‘ç‡
  æ¯”ç‰¹ç‡: 128kbps        # å¹³è¡¡è´¨é‡å’Œå¸¦å®½
  å£°é“: 1               # å•å£°é“ (Mono)
  å¸§æ—¶é•¿: 60ms          # 960æ ·æœ¬ @ 16kHz
  å¤æ‚åº¦: 10            # æœ€é«˜è´¨é‡
  VBR: true            # å¯å˜æ¯”ç‰¹ç‡
  bandwidth: wideband  # 16kHzå¸¦å®½

æ€§èƒ½æŒ‡æ ‡:
  ç¼–ç å»¶è¿Ÿ: < 10ms
  ä¼ è¾“å»¶è¿Ÿ: < 50ms
  æ€»å¾€è¿”å»¶è¿Ÿ: < 100ms
  
ç½‘ç»œä¼˜åŠ¿:
  2åˆ†é’ŸéŸ³é¢‘æ•°æ®: â‰ˆ 1.92 MB
  1å°æ—¶è¿ç»­éŸ³é¢‘: â‰ˆ 57.6 MB
  å®æ—¶å¸¦å®½æ¶ˆè€—: â‰ˆ 128 kbps
```

## 2.4 é€šä¿¡åè®®è®¾è®¡

### WebSocket éŸ³é¢‘å¸§æ ¼å¼

**å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ (éŸ³é¢‘ä¸Šä¼ )**:
```json
{
    "type": "audio",
    "frame_type": "audio",
    "session_id": "uuid-string",
    "timestamp": 1705420225.123,
    "sequence": 1234,
    "codec": "opus",
    "sample_rate": 16000,
    "channels": 1,
    "data": "base64_encoded_opus_data"
}
```

**æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ (å®æ—¶å­—å¹•)**:
```json
{
    "type": "transcript",
    "session_id": "uuid-string",
    "timestamp": 1705420225.234,
    "text": "ä½ å¥½ï¼Œè¿™æ˜¯è¯†åˆ«ç»“æœ",
    "is_final": false,
    "confidence": 0.92
}
```

### MQTT äº‹ä»¶æ€»çº¿è®¾è®¡

**ä¸»é¢˜ç»“æ„** (å‰ç¼€: `mr-mcp/`):

```
mr-mcp/
â”œâ”€â”€ audio/
â”‚   â”œâ”€â”€ intake/chunk       # éŸ³é¢‘chunkäº‹ä»¶
â”‚   â”œâ”€â”€ vad/start          # VADè¯­éŸ³å¼€å§‹
â”‚   â””â”€â”€ vad/end            # VADè¯­éŸ³ç»“æŸ
â”œâ”€â”€ asr/
â”‚   â”œâ”€â”€ interim            # ASRä¸­é—´è¯†åˆ«ç»“æœ
â”‚   â””â”€â”€ final              # ASRæœ€ç»ˆè¯†åˆ«ç»“æœ
â”œâ”€â”€ intent/
â”‚   â”œâ”€â”€ detected           # æ„å›¾æ£€æµ‹å®Œæˆ
â”‚   â””â”€â”€ error              # æ„å›¾è¯†åˆ«é”™è¯¯
â”œâ”€â”€ mcp/
â”‚   â”œâ”€â”€ tool/call          # MCPå·¥å…·è°ƒç”¨è¯·æ±‚
â”‚   â”œâ”€â”€ tool/result        # MCPå·¥å…·æ‰§è¡Œç»“æœ
â”‚   â””â”€â”€ tool/error         # MCPå·¥å…·æ‰§è¡Œé”™è¯¯
â””â”€â”€ tts/
    â””â”€â”€ ready              # TTSåˆæˆå®Œæˆ
```

## 2.5 é¡¹ç›®ä»£ç ç»“æ„è§„åˆ’

```
mr-mcp-server/
â”œâ”€â”€ README.md
â”œâ”€â”€ è®¾è®¡è¯´æ˜.md (æœ¬æ–‡æ¡£)
â”‚
â”œâ”€â”€ client/                          # Streamlitå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ app.py                      # ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ audio_manager.py            # éŸ³é¢‘é‡‡é›†+Opusç¼–ç 
â”‚   â”œâ”€â”€ websocket_client.py         # WebSocketå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ ui_components.py            # UIç»„ä»¶
â”‚   â”œâ”€â”€ session_state.py            # ä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ config.yaml
â”‚   â””â”€â”€ requirements.txt
â”‚
â”œâ”€â”€ services/                        # å¾®æœåŠ¡å®ç°
â”‚   â”œâ”€â”€ audio_intake/
â”‚   â”‚   â”œâ”€â”€ server.py               # WebSocketæœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ opus_decoder.py         # Opusè§£ç å™¨
â”‚   â”‚   â”œâ”€â”€ buffer_manager.py       # ç¼“å†²ç®¡ç†
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”‚
â”‚   â”œâ”€â”€ vad/
â”‚   â”‚   â”œâ”€â”€ service.py              # VADä¸»æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ detector.py             # VADæ£€æµ‹å™¨
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”‚
â”‚   â”œâ”€â”€ asr/
â”‚   â”‚   â”œâ”€â”€ service.py              # ASRä¸»æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ recognizer.py           # è¯†åˆ«å™¨
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”‚
â”‚   â”œâ”€â”€ intent/
â”‚   â”‚   â”œâ”€â”€ service.py              # ä¸»æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ context_manager.py      # ä¸Šä¸‹æ–‡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ llm_client.py           # LLMè°ƒç”¨
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”‚
â”‚   â”œâ”€â”€ mcp/
â”‚   â”‚   â”œâ”€â”€ service.py              # ä¸»æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ engine.py               # æ‰§è¡Œå¼•æ“
â”‚   â”‚   â”œâ”€â”€ tool_loader.py          # å·¥å…·åŠ è½½
â”‚   â”‚   â”œâ”€â”€ tools/                  # å·¥å…·å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ base.py             # åŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ reminder.py         # æé†’å·¥å…·
â”‚   â”‚   â”‚   â””â”€â”€ messaging.py        # æ¶ˆæ¯å·¥å…·
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”‚
â”‚   â””â”€â”€ tts/
â”‚       â”œâ”€â”€ service.py              # TTSä¸»æœåŠ¡
â”‚       â”œâ”€â”€ synthesizer.py          # åˆæˆå™¨
â”‚       â””â”€â”€ config.py
â”‚
â”œâ”€â”€ shared/                          # å…±äº«æ¨¡å—
â”‚   â”œâ”€â”€ mqtt_bus.py                 # MQTTäº‹ä»¶æ€»çº¿
â”‚   â”œâ”€â”€ models.py                   # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ constants.py                # å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ logger.py                   # æ—¥å¿—é…ç½®
â”‚
â”œâ”€â”€ config/                          # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ config.yaml                 # ä¸»é…ç½®
â”‚   â”œâ”€â”€ tools_definition.json       # MCPå·¥å…·å®šä¹‰
â”‚   â””â”€â”€ prompts.yaml                # LLM Prompts
â”‚
â”œâ”€â”€ docker/
â”‚   â””â”€â”€ docker-compose.yml          # æœåŠ¡ç¼–æ’
â”‚
â””â”€â”€ tests/                           # æµ‹è¯•
    â”œâ”€â”€ test_audio.py
    â”œâ”€â”€ test_websocket.py
    â””â”€â”€ test_mqtt.py
```

## 2.6 å®ç°è·¯çº¿å›¾ (10å‘¨)

### Phase 1: åŸºç¡€æ¡†æ¶ (ç¬¬1-2å‘¨)
**ç›®æ ‡**: å»ºç«‹é¡¹ç›®åŸºç¡€æ¶æ„å’Œé€šä¿¡æœºåˆ¶

- [x] é¡¹ç›®åˆå§‹åŒ–å’Œç›®å½•ç»“æ„
- [ ] WebSocketæœåŠ¡å™¨å®ç° + Opusç¼–è§£ç åº“é›†æˆ
- [ ] MQTT Brokeréƒ¨ç½²å’Œäº‹ä»¶æ€»çº¿å®ç°
- [ ] åŸºæœ¬çš„Streamlitå®¢æˆ·ç«¯æ¡†æ¶
- [ ] Docker ComposeåŸºç¡€é…ç½®
- [ ] **éªŒè¯**: éŸ³é¢‘å®æ—¶ä¼ è¾“æˆåŠŸ

### Phase 2: æ ¸å¿ƒéŸ³é¢‘æœåŠ¡ (ç¬¬3-4å‘¨)
**ç›®æ ‡**: å®ç°éŸ³é¢‘é‡‡é›†ã€å¤„ç†ã€è¯†åˆ«çš„å®Œæ•´é“¾è·¯

- [ ] Audio IntakeæœåŠ¡ï¼ˆOpusè§£ç ã€ç¼“å†²ï¼‰
- [ ] VADæœåŠ¡é›†æˆï¼ˆå®æ—¶è¯­éŸ³æ£€æµ‹ï¼‰
- [ ] ASRæœåŠ¡é›†æˆï¼ˆFunASRå¼•æ“ï¼‰
- [ ] å®æ—¶å­—å¹•æ¨é€åˆ°å®¢æˆ·ç«¯
- [ ] MQTTäº‹ä»¶æµè”è°ƒ
- [ ] **éªŒè¯**: éŸ³é¢‘è¯†åˆ«å…¨æµç¨‹å¯ç”¨

### Phase 3: æ™ºèƒ½å¤„ç†å±‚ (ç¬¬5-6å‘¨)
**ç›®æ ‡**: å®ç°æ„å›¾è¯†åˆ«å’Œå¯¹è¯ç®¡ç†

- [ ] æ„å›¾è¯†åˆ«æœåŠ¡ï¼ˆå¤§æ¨¡å‹æ¨ç†ï¼‰
- [ ] å¯¹è¯å†å²ç®¡ç†ï¼ˆMongoDBï¼‰
- [ ] å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡æ”¯æŒ
- [ ] Redisç¼“å­˜å±‚é›†æˆ
- [ ] Promptä¼˜åŒ–å’Œæµ‹è¯•
- [ ] **éªŒè¯**: æ„å›¾è¯†åˆ«å‡†ç¡®ç‡>85%

### Phase 4: MCPå·¥å…·é›†æˆ (ç¬¬7-8å‘¨)
**ç›®æ ‡**: å®ç°MCPæ‰§è¡Œå¼•æ“å’Œå·¥å…·ç®¡ç†

- [ ] MCPæ‰§è¡Œå¼•æ“æ ¸å¿ƒå®ç°
- [ ] å·¥å…·åŠ¨æ€åŠ è½½æ¡†æ¶
- [ ] å‚æ•°éªŒè¯å’Œè½¬æ¢
- [ ] å¼‚å¸¸å¤„ç†å’Œé‡è¯•é€»è¾‘
- [ ] 3-5ä¸ªç¤ºä¾‹å·¥å…·å®ç°
- [ ] **éªŒè¯**: å·¥å…·è°ƒç”¨æˆåŠŸç‡>95%

### Phase 5: ä¼˜åŒ–å’Œå®Œå–„ (ç¬¬9-10å‘¨)
**ç›®æ ‡**: æ€§èƒ½ä¼˜åŒ–ã€æ–‡æ¡£ã€éƒ¨ç½²

- [ ] ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å†²åŒºè°ƒä¼˜ã€æ¨¡å‹åŠ é€Ÿï¼‰
- [ ] é”™è¯¯æ¢å¤æœºåˆ¶å®Œå–„
- [ ] ç³»ç»Ÿç›‘æ§å’Œæ—¥å¿—é…ç½®
- [ ] å®Œæ•´çš„å¼€å‘å’Œéƒ¨ç½²æ–‡æ¡£
- [ ] é›†æˆæµ‹è¯•å’Œå‹åŠ›æµ‹è¯•
- [ ] **éªŒè¯**: ç³»ç»Ÿå¯é è¿è¡Œ>99%

## 2.7 å…³é”®æŠ€æœ¯è¦ç‚¹

### Opusç¼–ç å…³é”®å‚æ•°

```python
import opuslib

# å®¢æˆ·ç«¯ç¼–ç å™¨é…ç½®
encoder = opuslib.Encoder(
    16000,                      # é‡‡æ ·ç‡ 16kHz
    1,                          # å•å£°é“
    opuslib.APPLICATION_VOIP    # VoIPåº”ç”¨
)
encoder.bitrate = 128000        # 128 kbps
encoder.bandwidth = opuslib.BANDWIDTH_WIDEBAND
encoder.complexity = 10         # æœ€é«˜è´¨é‡
encoder.use_vbr = True         # å¯å˜æ¯”ç‰¹ç‡
encoder.vbr_constraint = False

# æœåŠ¡ç«¯è§£ç å™¨é…ç½®
decoder = opuslib.Decoder(16000, 1)
```

### MQTTäº‹ä»¶é©±åŠ¨æ¡†æ¶

```python
from shared.mqtt_bus import get_mqtt_bus, init_mqtt_bus

# åˆå§‹åŒ–MQTTæ€»çº¿
mqtt_bus = init_mqtt_bus()

# è®¢é˜…äº‹ä»¶
async def handle_vad_start(payload):
    print(f"VAD detected speech start: {payload}")

mqtt_bus.subscribe("mr-mcp/audio/vad/start", handle_vad_start)

# å‘å¸ƒäº‹ä»¶
mqtt_bus.publish("mr-mcp/audio/vad/start", {
    "session_id": "uuid",
    "timestamp": 1705420225.123,
    "audio_level": 0.65
})
```

---

## æ–‡æ¡£ä¿¡æ¯

**ä½œè€…**: Jiheng Zhang  
**é‚®ç®±**: jiheng.zhang@gehealthcare.com  
**SSO ID**: 212597558  
**ç‰ˆæƒ**: Â© 2026 GE Healthcare. All rights reserved.  
**æœ€åä¿®æ”¹**: 2026-01-17

---

---

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¿«é€Ÿå…¥é—¨æŒ‡å—

## 3.1 30ç§’å¿«é€Ÿå¼€å§‹

```bash
# 1. æ¿€æ´»ç¯å¢ƒ
conda activate audio_env

# 2. è¿›å…¥é¡¹ç›®
cd /home/tester/AI_Tools/mr-mcp-server

# 3. åˆå§‹åŒ–é¡¹ç›®
bash setup.sh

# 4. å¯åŠ¨æœåŠ¡ï¼ˆæ–°ç»ˆç«¯ï¼‰
bash scripts/start_audio_intake.sh &
bash scripts/start_streamlit.sh

# 5. æ‰“å¼€æµè§ˆå™¨
# http://localhost:8501
```

## 3.2 Condaç¯å¢ƒé…ç½®

### æŸ¥çœ‹æ‰€æœ‰ Conda ç¯å¢ƒ

```bash
# æŸ¥çœ‹æ‰€æœ‰ conda ç¯å¢ƒ
conda env list

# é¢„æœŸè¾“å‡ºï¼š
# base                  /home/tester/miniconda3
# audio_env          *  /home/tester/miniconda3/envs/audio_env
```

### æ¿€æ´»ç¯å¢ƒ

**æ–¹å¼1ï¼šç›´æ¥æ¿€æ´»ï¼ˆæ¨èï¼‰**

```bash
# æ¿€æ´» audio_env ç¯å¢ƒ
conda activate audio_env

# éªŒè¯æ¿€æ´»ï¼ˆæç¤ºç¬¦ä¼šæ˜¾ç¤º (audio_env)ï¼‰
# (audio_env) $ 
```

**æ–¹å¼2ï¼šåœ¨è„šæœ¬ä¸­æ¿€æ´»**

```bash
#!/bin/bash
eval "$(conda shell.bash hook)"
conda activate audio_env

# åç»­å‘½ä»¤è‡ªåŠ¨åœ¨ audio_env ä¸­è¿è¡Œ
python --version
```

### ç¯å¢ƒä¿¡æ¯

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate audio_env

# æŸ¥çœ‹ Python ç‰ˆæœ¬
python --version

# æŸ¥çœ‹ pip ç‰ˆæœ¬
pip --version

# æŸ¥çœ‹æ‰€æœ‰å·²å®‰è£…çš„åŒ…
pip list

# æŸ¥çœ‹ç¯å¢ƒè·¯å¾„
python -c "import sys; print(sys.prefix)"
```

### é¢„æœŸè¾“å‡º

```
(audio_env) $ python --version
Python 3.10.x

(audio_env) $ pip --version
pip x.x.x from /home/tester/miniconda3/envs/audio_env/lib/python3.10/site-packages/pip ...

(audio_env) $ python -c "import sys; print(sys.prefix)"
/home/tester/miniconda3/envs/audio_env
```

### åŒ…ç®¡ç†

**æŸ¥çœ‹å·²å®‰è£…åŒ…**

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate audio_env

# æ˜¾ç¤ºæ‰€æœ‰åŒ…
pip list

# æ˜¾ç¤ºç‰¹å®šåŒ…çš„ç‰ˆæœ¬
pip show fastapi
pip show uvicorn
```

**å®‰è£…æ–°åŒ…**

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate audio_env

# é€šè¿‡ conda å®‰è£…
conda install package_name

# é€šè¿‡ pip å®‰è£…
pip install package_name

# å®‰è£…æŒ‡å®šç‰ˆæœ¬
pip install package_name==1.0.0
```

**æ›´æ–°åŒ…**

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate audio_env

# æ›´æ–° pip
pip install --upgrade pip

# æ›´æ–°ç‰¹å®šåŒ…
pip install --upgrade package_name

# ä» requirements.txt æ›´æ–°æ‰€æœ‰åŒ…
pip install -r requirements.txt --upgrade
```

---

# ç¬¬å››éƒ¨åˆ†ï¼šStreamlitå®¢æˆ·ç«¯æ–‡æ¡£

## 4.1 å®¢æˆ·ç«¯æ¦‚è¿°

è¯¥å®¢æˆ·ç«¯æä¾›ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„ Web ç•Œé¢ï¼Œæ”¯æŒï¼š
- ğŸ¤ å®æ—¶éŸ³é¢‘é‡‡é›†ï¼ˆé€šè¿‡éº¦å…‹é£ï¼‰
- ğŸ”Š Opus é«˜æ•ˆç¼–ç ï¼ˆ128kbpsï¼Œ16kHzï¼‰
- ğŸ’¬ WebSocket å®æ—¶ä¼ è¾“åˆ°æœåŠ¡å™¨
- ğŸ“Š å®æ—¶éŸ³é‡ç›‘æ§
- ğŸ’­ å¯¹è¯å†å²æ˜¾ç¤º
- ğŸ”Œ è‡ªåŠ¨è¿æ¥ç®¡ç†

## 4.2 å®‰è£…å’Œå¯åŠ¨

### å®‰è£…ä¾èµ–

```bash
# å®‰è£… Python ä¾èµ–
pip install -r client/requirements.txt

# æˆ–ä½¿ç”¨ conda
conda install --file client/requirements.txt
```

**æ³¨æ„**: æŸäº›ä¾èµ–ï¼ˆpyaudio, opuslibï¼‰å¯èƒ½éœ€è¦ç³»ç»Ÿåº“æ”¯æŒï¼š

```bash
# Ubuntu/Debian
sudo apt-get install python3-dev portaudio19-dev libopus-dev

# macOS
brew install portaudio opus

# Windows
# ä½¿ç”¨é¢„ç¼–è¯‘çš„ wheelsï¼ˆpip ä¼šè‡ªåŠ¨ä¸‹è½½ï¼‰
```

### å¯åŠ¨æœåŠ¡å™¨

ç¡®ä¿ WebSocket æœåŠ¡å™¨å·²å¯åŠ¨ï¼š

```bash
# ç»ˆç«¯ 1: å¯åŠ¨ MQTT broker
sudo systemctl start mosquitto

# ç»ˆç«¯ 2: å¯åŠ¨ WebSocket éŸ³é¢‘æœåŠ¡å™¨
./scripts/start_audio_intake.sh

# è¾“å‡ºåº”æ˜¾ç¤º:
# INFO     - Server started: ws://0.0.0.0:8000/ws/audio
```

### å¯åŠ¨ Streamlit å®¢æˆ·ç«¯

```bash
# ç»ˆç«¯ 3: å¯åŠ¨ Streamlit åº”ç”¨
./scripts/start_streamlit.sh

# æˆ–ç›´æ¥ä½¿ç”¨ streamlit å‘½ä»¤
streamlit run client/app.py
```

åº”ç”¨å°†åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œé€šå¸¸æ˜¯ `http://localhost:8501`

## 4.3 ä½¿ç”¨æŒ‡å—

### åŸºæœ¬æµç¨‹

1. **è¿æ¥**: ç‚¹å‡» "ğŸ”Œ è¿æ¥" æŒ‰é’®è¿æ¥åˆ° WebSocket æœåŠ¡å™¨
2. **å½•éŸ³**: ç‚¹å‡» "ğŸ¤ å¼€å§‹å½•éŸ³" å¼€å§‹é‡‡é›†éŸ³é¢‘
3. **è¯´è¯**: å¯¹ç€éº¦å…‹é£è¯´è¯
4. **åœæ­¢**: ç‚¹å‡» "â¹ åœæ­¢å½•éŸ³" ç»“æŸæœ¬è½®äº¤äº’
5. **æŸ¥çœ‹ç»“æœ**: åœ¨å¯¹è¯æ¡†ä¸­æŸ¥çœ‹è½¬å½•å’Œå“åº”

### ç•Œé¢ç»„ä»¶

#### æ§åˆ¶é¢æ¿
- **ğŸ”Œ è¿æ¥**: è¿æ¥/æ–­å¼€ WebSocket æœåŠ¡å™¨
- **ğŸ¤ å¼€å§‹å½•éŸ³**: å¯åŠ¨éŸ³é¢‘é‡‡é›†æµ
- **â¹ åœæ­¢å½•éŸ³**: ç»“æŸéŸ³é¢‘ä¼ è¾“

#### å®æ—¶ç›‘æ§ï¼ˆå³ä¾§è¾¹æ ï¼‰
- **è¿æ¥çŠ¶æ€**: æ˜¾ç¤ºæœåŠ¡å™¨è¿æ¥çŠ¶æ€
- **å½•éŸ³çŠ¶æ€**: æ˜¾ç¤ºå½“å‰æ˜¯å¦åœ¨å½•éŸ³
- **éŸ³é‡æ°´å¹³**: å®æ—¶éŸ³é¢‘çº§åˆ«æŒ‡ç¤º
- **ç»Ÿè®¡ä¿¡æ¯**: 
  - å·²å‘é€å¸§æ•°
  - å·²æ¥æ”¶å¸§æ•°
  - è¿æ¥æ—¶é•¿
  - ä¼šè¯ ID

#### å¯¹è¯åŒºåŸŸï¼ˆå·¦ä¾§ä¸»åŒºåŸŸï¼‰
- **ğŸ’¬ å¯¹è¯**: æ˜¾ç¤ºå®Œæ•´çš„å¯¹è¯å†å²
- **ğŸ“ å®æ—¶è½¬å½•**: æ˜¾ç¤ºå®æ—¶è½¬å½•æ–‡æœ¬
- **ğŸ“Š å¯¹è¯**: æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯å’ŒåŠ©æ‰‹å“åº”

### è®¾ç½®é¢æ¿

ç‚¹å‡»å·¦ä¾§è¾¹æ çš„ "âš™ï¸ è®¾ç½®" å±•å¼€é«˜çº§é€‰é¡¹ï¼š

- **Server URI**: WebSocket æœåŠ¡å™¨åœ°å€
  - é»˜è®¤: `ws://localhost:8000/ws/audio`
  - ç¤ºä¾‹: `ws://192.168.1.100:8000/ws/audio`
- **Auto Reconnect**: è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡æ–°è¿æ¥
- **Debug Mode**: å¯ç”¨è°ƒè¯•æ—¥å¿—è¾“å‡º

## 4.4 é…ç½®

### ç¯å¢ƒå˜é‡

```bash
# WebSocket æœåŠ¡å™¨åœ°å€
export WEBSOCKET_SERVER=ws://localhost:8000/ws/audio

# è°ƒè¯•æ¨¡å¼
export DEBUG_MODE=true

# å¯åŠ¨å®¢æˆ·ç«¯
./scripts/start_streamlit.sh
```

### éŸ³é¢‘å‚æ•° (client/config.py)

```python
sample_rate: int = 16000        # é‡‡æ ·ç‡ (Hz)
chunk_duration_ms: int = 60     # æ¯ä¸ªå—çš„æŒç»­æ—¶é—´ (ms)
bitrate: int = 128000           # Opus æ¯”ç‰¹ç‡ (bps)
```

ä¿®æ”¹è¿™äº›å€¼éœ€è¦é‡å¯åº”ç”¨ã€‚

## 4.5 WebSocket é€šè®¯åè®®

### å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨

#### å¯åŠ¨æµ (START Frame)
```json
{
  "type": "audio",
  "frame_type": "start",
  "session_id": "uuid-string",
  "timestamp": 1705420225.123
}
```

#### éŸ³é¢‘å¸§ (AUDIO Frame)
```json
{
  "type": "audio",
  "frame_type": "audio",
  "session_id": "uuid-string",
  "timestamp": 1705420225.123,
  "sequence": 1,
  "codec": "opus",
  "sample_rate": 16000,
  "channels": 1,
  "data": "hex_encoded_opus_bytes"
}
```

#### ç»“æŸæµ (END Frame)
```json
{
  "type": "audio",
  "frame_type": "end",
  "session_id": "uuid-string",
  "timestamp": 1705420225.123
}
```

### æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯

#### çŠ¶æ€æ¶ˆæ¯
```json
{
  "type": "status",
  "session_id": "uuid-string",
  "message": "Audio received",
  "frames_received": 10
}
```

#### è½¬å½•ç»“æœ
```json
{
  "type": "transcript",
  "session_id": "uuid-string",
  "text": "ä½ å¥½",
  "is_final": false,
  "confidence": 0.95
}
```

#### æœ€ç»ˆç»“æœ
```json
{
  "type": "result",
  "session_id": "uuid-string",
  "text": "è¯†åˆ«å®Œæˆçš„æ–‡æœ¬",
  "is_final": true
}
```

---

# ç¬¬äº”éƒ¨åˆ†ï¼šDockeréƒ¨ç½²æŒ‡å—

## 5.1 å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Docker 20.10+
- Docker Compose 2.0+
- 4GB+ å†…å­˜
- 100MB ç£ç›˜ç©ºé—´

### ä¸€é”®å¯åŠ¨

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/tester/AI_Tools/mr-mcp-server

# ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
./docker-up.sh

# æˆ–ä½¿ç”¨ docker-compose å‘½ä»¤
docker-compose up -d
```

### è®¿é—®æœåŠ¡

- **Streamlit å®¢æˆ·ç«¯**: http://localhost:8501
- **WebSocket æœåŠ¡å™¨**: ws://localhost:8000/ws/audio
- **MQTT Broker**: mqtt://localhost:1883

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f audio-server
docker-compose logs -f streamlit-client
docker-compose logs -f mqtt
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢ä½†ä¿ç•™å®¹å™¨
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
./docker-down.sh

# æˆ–ä½¿ç”¨ docker-compose
docker-compose down
```

## 5.2 Dockeræ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Docker Compose                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  MQTT Broker   â”‚  â”‚ WebSocket      â”‚  â”‚  Streamlit     â”‚ â”‚
â”‚  â”‚                â”‚  â”‚ Server         â”‚  â”‚  Client        â”‚ â”‚
â”‚  â”‚ mosquitto:1883 â”‚  â”‚ :8000/ws/audio â”‚  â”‚  :8501         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                    â†“                    â†“           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ mosquitto_data â”‚  â”‚     logs       â”‚  â”‚     logs       â”‚ â”‚
â”‚  â”‚ mosquitto_logs â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                               â”‚
â”‚            Network: mr-mcp-network (bridge)                 â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5.3 Docker Compose é…ç½®è¯¦è§£

### docker-compose.yml æ–‡ä»¶ç»“æ„

```yaml
services:
  mqtt:              # MQTT æ¶ˆæ¯ä»£ç†
    image: eclipse-mosquitto:latest
    ports: ["1883:1883", "9001:9001"]
    
  audio-server:      # WebSocket éŸ³é¢‘æœåŠ¡å™¨
    build: Dockerfile.audio-server
    ports: ["8000:8000"]
    depends_on: [mqtt]
    
  streamlit-client:  # Streamlit å‰ç«¯å®¢æˆ·ç«¯
    build: Dockerfile.streamlit-client
    ports: ["8501:8501"]
    depends_on: [audio-server]

networks:
  mr-mcp-network:    # è‡ªå®šä¹‰ç½‘ç»œ
    driver: bridge

volumes:
  mosquitto_data:    # MQTT æ•°æ®å·
  mosquitto_logs:    # MQTT æ—¥å¿—å·
```

### ç¯å¢ƒå˜é‡

#### audio-server (WebSocket æœåŠ¡å™¨)

```bash
MQTT_HOST=mqtt                      # MQTT ä¸»æœºåï¼ˆå®¹å™¨ç½‘ç»œå†…ï¼‰
MQTT_PORT=1883                      # MQTT ç«¯å£
MQTT_USER=guest                     # MQTT ç”¨æˆ·å
MQTT_PASSWORD=guest                 # MQTT å¯†ç 
LOG_LEVEL=INFO                      # æ—¥å¿—çº§åˆ«
WEBSOCKET_PORT=8000                 # WebSocket ç«¯å£
WEBSOCKET_HOST=0.0.0.0              # WebSocket ç›‘å¬åœ°å€
```

#### streamlit-client (Streamlit å®¢æˆ·ç«¯)

```bash
WEBSOCKET_SERVER=ws://audio-server:8000/ws/audio  # WebSocket æœåŠ¡å™¨åœ°å€
DEBUG_MODE=false                    # è°ƒè¯•æ¨¡å¼
STREAMLIT_SERVER_PORT=8501          # Streamlit ç«¯å£
STREAMLIT_SERVER_ADDRESS=0.0.0.0    # Streamlit ç›‘å¬åœ°å€
```

## 5.4 ç®¡ç†è„šæœ¬

### ./docker.sh - å®Œæ•´ç®¡ç†å·¥å…·

```bash
# å¯åŠ¨æœåŠ¡
./docker.sh up

# åœæ­¢æœåŠ¡
./docker.sh down

# é‡å¯æœåŠ¡
./docker.sh restart

# æŸ¥çœ‹æ—¥å¿—
./docker.sh logs        # æ‰€æœ‰æœåŠ¡
./docker.sh logs-mqtt   # MQTT
./docker.sh logs-audio  # WebSocket æœåŠ¡å™¨
./docker.sh logs-client # Streamlit å®¢æˆ·ç«¯

# æŸ¥çœ‹çŠ¶æ€
./docker.sh status

# æ„å»ºé•œåƒ
./docker.sh build
./docker.sh rebuild     # ä¸ç¼“å­˜é‡æ–°æ„å»º

# æ¸…ç†
./docker.sh clean

# å¼€å¯ Shell
./docker.sh shell-mqtt
./docker.sh shell-audio
./docker.sh shell-client

# å¸®åŠ©
./docker.sh help
```

### ./docker-up.sh - å¿«é€Ÿå¯åŠ¨

ä¸€é”®å¯åŠ¨ï¼Œè‡ªåŠ¨æ„å»ºå’Œå¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚

### ./docker-down.sh - å¿«é€Ÿåœæ­¢

åœæ­¢æ‰€æœ‰æœåŠ¡ï¼Œå¯é€‰åˆ é™¤å·ã€‚

## 5.5 å¸¸è§æ“ä½œ

### æŸ¥çœ‹æ—¥å¿—å¹¶å®æ—¶è·Ÿè¸ª

```bash
# æ‰€æœ‰æœåŠ¡
docker-compose logs -f

# ç‰¹å®šæœåŠ¡
docker-compose logs -f audio-server
docker-compose logs -f streamlit-client

# æœ€å 100 è¡Œ
docker-compose logs --tail=100

# ç‰¹å®šæ—¶é—´èŒƒå›´
docker-compose logs --since 10m
```

### è¿›å…¥å®¹å™¨ Shell

```bash
# WebSocket æœåŠ¡å™¨
docker exec -it mr-mcp-server-audio-server-1 /bin/bash

# Streamlit å®¢æˆ·ç«¯
docker exec -it mr-mcp-server-streamlit-client-1 /bin/bash

# MQTT Broker
docker exec -it mr-mcp-server-mqtt-1 /bin/sh
```

### é‡å¯ç‰¹å®šæœåŠ¡

```bash
# é‡å¯éŸ³é¢‘æœåŠ¡å™¨
docker-compose restart audio-server

# é‡å¯ Streamlit
docker-compose restart streamlit-client
```

---

## æ€»ç»“ä¸å»ºè®®

### ç³»ç»Ÿç‰¹ç‚¹æ€»ç»“

âœ… **å®Œå…¨æœ¬åœ°åŒ–** - æ‰€æœ‰é€šä¿¡åŸºäºå±€åŸŸç½‘  
âœ… **æ¨¡å—åŒ–æ¶æ„** - å„æœåŠ¡ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•  
âœ… **äº‹ä»¶é©±åŠ¨è®¾è®¡** - MQTTäº‹ä»¶æ€»çº¿è§£è€¦æœåŠ¡  
âœ… **å¤šè½®å¯¹è¯æ”¯æŒ** - å®Œæ•´çš„ä¸Šä¸‹æ–‡ç®¡ç†  
âœ… **çµæ´»çš„å·¥å…·æ¡†æ¶** - æ˜“äºæ·»åŠ æ–°å·¥å…·  
âœ… **é«˜è´¨é‡éŸ³é¢‘** - Opusç¼–ç ä¿è¯ä¼ è¾“æ•ˆç‡  

### åç»­æ¨èæ­¥éª¤

1. **ç¡®è®¤è®¾è®¡** - æ ¹æ®æ­¤æ–‡æ¡£ç¡®è®¤ç³»ç»Ÿéœ€æ±‚æ˜¯å¦å®Œæ•´
2. **ç»†åŒ–æ¥å£** - åœ¨å®æ–½å‰ç»†åŒ–å„æ¨¡å—çš„APIå®šä¹‰
3. **åŸå‹å¼€å‘** - Phase 1-2å®ç°åŸºç¡€æ¡†æ¶ï¼ŒéªŒè¯å¯è¡Œæ€§
4. **è¿­ä»£ä¼˜åŒ–** - æ ¹æ®å®é™…è¿è¡Œæƒ…å†µä¼˜åŒ–å‚æ•°å’Œæ€§èƒ½
5. **æ–‡æ¡£å®Œå–„** - æŒç»­æ›´æ–°å¼€å‘å’Œéƒ¨ç½²æ–‡æ¡£

---

**æ–‡æ¡£å®Œæˆæ—¥æœŸ**: 2026å¹´1æœˆ17æ—¥  
**ç‰ˆæœ¬**: 1.0  
**ä¸‹ä¸€æ­¥**: å¼€å§‹Phase 1å®ç°
