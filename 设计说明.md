# xiaozhi-esp32-server & MR-MCP-Server å®Œæ•´ç³»ç»Ÿè®¾è®¡è¯´æ˜

**åˆ›å»ºæ—¥æœŸ**: 2026å¹´1æœˆ17æ—¥  
**ç‰ˆæœ¬**: 1.0  
**ç›®æ ‡**: æ„å»ºä¸€ä¸ªé›†æˆè¯­éŸ³äº¤äº’ã€æ„å›¾è¯†åˆ«ã€MCPå·¥å…·è°ƒç”¨çš„å®Œæ•´æœ¬åœ°æ™ºèƒ½ç³»ç»Ÿ

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è§ˆ

æœ¬æ–‡æ¡£åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š
1. **ç¬¬ä¸€éƒ¨åˆ†** - xiaozhi-esp32-server ç°æœ‰ç³»ç»Ÿåˆ†æ
2. **ç¬¬äºŒéƒ¨åˆ†** - MR-MCP-Server æ–°ç³»ç»Ÿçš„å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šxiaozhi-esp32-server ç³»ç»Ÿåˆ†æ

## 1.1 ç³»ç»Ÿæ¦‚è¿°

`xiaozhi-esp32-server` æ˜¯ä¸º ESP32 ç¡¬ä»¶è®¾å¤‡ (`xiaozhi-esp32`) æä¾›çš„åç«¯æœåŠ¡ç³»ç»Ÿã€‚ESP32 ç«¯æ˜¯ä¸€ä¸ªåŸºäºç¡¬ä»¶çš„è¯­éŸ³åŠ©æ‰‹ï¼Œè€ŒæœåŠ¡å™¨ç«¯æä¾›äº‘ç«¯çš„ AI èƒ½åŠ›ã€‚ä¸¤ç«¯é€šè¿‡ **MQTT æˆ– WebSocket** åè®®è¿›è¡Œé€šä¿¡ã€‚

### ç³»ç»Ÿç‰¹ç‚¹
- ğŸ™ï¸ **å®Œå…¨æœ¬åœ°åŒ–** - æ‰€æœ‰é€šä¿¡åŸºäºå±€åŸŸç½‘ï¼ˆMQTT/WebSocketï¼‰
- ğŸ§  **äº‘ç«¯æ™ºèƒ½** - ç¦»çº¿æ¨¡å‹ + åœ¨çº¿å¤§æ¨¡å‹åŒå¼•æ“
- ğŸ”§ **MCP å·¥å…·æ”¯æŒ** - çµæ´»çš„å·¥å…·è°ƒç”¨æ¡†æ¶
- ğŸµ **é«˜è´¨é‡éŸ³é¢‘** - æ”¯æŒ Opus ç¼–ç ã€æœ¬åœ° VAD/ASR
- ğŸ“± **å¤šè®¾å¤‡æ”¯æŒ** - å¯åŒæ—¶è¿æ¥å¤šä¸ª ESP32 è®¾å¤‡

## 1.2 ç¡¬ä»¶ç«¯æ¶æ„ (ESP32)

ESP32 ç¡¬ä»¶ç«¯çš„æ ¸å¿ƒæµç¨‹ï¼š

```
éº¦å…‹é£è¾“å…¥
    â†“
AudioService (éŸ³é¢‘é‡‡é›†ã€ç¼–ç ã€VADã€å”¤é†’è¯æ£€æµ‹)
    â†“
æœ¬åœ°è¯†åˆ« (Multinet v7 ç¦»çº¿å‘½ä»¤è¯†åˆ«)
    â”œâ”€ æ£€æµ‹åˆ°å”¤é†’è¯ â†’ æ‰“å¼€éŸ³é¢‘é€šé“
    â”œâ”€ æ£€æµ‹åˆ°é€€å‡ºå‘½ä»¤ â†’ åœæ­¢ç›‘å¬
    â””â”€ ä¸åŒ¹é… â†’ ç»§ç»­ç­‰å¾…
    â†“
Protocol (MQTT/WebSocket)
    â†“
æœåŠ¡å™¨ç«¯å¤„ç†
    â†“
è¿”å›ç»“æœ (STT/TTS/Tool)
    â†“
æ’­æ”¾æ‰¬å£°å™¨
    â†“
æ›´æ–°å±å¹•æ˜¾ç¤º
```

**ç¡¬ä»¶ç«¯ä¸»è¦èƒ½åŠ›ï¼š**
- âœ… æœ¬åœ°éŸ³é¢‘é‡‡é›†å’Œç¼–ç ï¼ˆOpusï¼‰
- âœ… æœ¬åœ°VADè¯­éŸ³æ´»åŠ¨æ£€æµ‹
- âœ… æœ¬åœ°å”¤é†’è¯è¯†åˆ«ï¼ˆMultinet v7ï¼‰
- âœ… æœ¬åœ°ç®€å•å‘½ä»¤æ‰§è¡Œï¼ˆå¦‚ "ok exit"ï¼‰
- âœ… ä¸æœåŠ¡å™¨é€šä¿¡è·å– AI å¤„ç†ç»“æœ

## 1.3 ç³»ç»Ÿæ¡†å›¾ä¸æ•°æ®æµ

### 1.3.1 ç½‘ç»œæ‹“æ‰‘ç»“æ„ (Network Topology)

```mermaid
graph TB
    subgraph ESP32["ğŸ™ï¸ ESP32 ç¡¬ä»¶è®¾å¤‡<br/>(192.168.x.x)"]
        Mic["ğŸ¤ éº¦å…‹é£"]
        Speaker["ğŸ”Š æ‰¬å£°å™¨"]
        Screen["ğŸ“± å±å¹•"]
        Button["ğŸ”˜ æŒ‰é”®"]
        Audio["AudioService<br/>(VAD/å”¤é†’è¯)"]
        Protocol["Protocol Layer<br/>(WebSocket/MQTT)"]
        
        Mic --> Audio
        Audio --> Protocol
        Protocol --> Speaker
        Protocol --> Screen
        Button --> Protocol
    end
    
    subgraph Network["ğŸŒ å±€åŸŸç½‘é€šä¿¡"]
        WS["WebSocket<br/>Port: 8000"]
        MQTT["MQTT Broker<br/>Port: 1883"]
    end
    
    subgraph Server["ğŸ–¥ï¸ æœåŠ¡å™¨<br/>(192.168.1.13)"]
        Intake["ğŸ“¥ Audio Intake<br/>æ¥æ”¶/ç¼“å†²"]
        VAD["ğŸ” VADæ¨¡å—<br/>SileroVAD"]
        ASR["ğŸ—£ï¸ ASRæ¨¡å—<br/>FunASR"]
        LLM["ğŸ§  LLMæ¨¡å—<br/>DoubaoLLM"]
        MCP["ğŸ”§ MCPå¼•æ“<br/>å·¥å…·è°ƒç”¨"]
        TTS["ğŸµ TTSæ¨¡å—<br/>CosyVoice"]
        
        Intake --> VAD
        VAD --> ASR
        ASR --> LLM
        LLM --> MCP
        MCP --> TTS
        TTS --> Intake
    end
    
    Protocol -->|ä¸Šè¡Œ: OpuséŸ³é¢‘| WS
    WS --> Intake
    Intake -->|äº‹ä»¶å‘å¸ƒ| MQTT
    MQTT -->|äº‹ä»¶è®¢é˜…| LLM
    MQTT -->|äº‹ä»¶è®¢é˜…| MCP
    MQTT -->|äº‹ä»¶è®¢é˜…| TTS
    TTS -->|ä¸‹è¡Œ: OpuséŸ³é¢‘| WS
    WS --> Protocol
    
    style ESP32 fill:#e1f5ff
    style Server fill:#f3e5f5
    style Network fill:#fff3e0
```

### 1.3.2 éŸ³é¢‘æ•°æ®æµ (Speech Path)

```mermaid
graph LR
    subgraph Capture["ğŸ¤ æ•è·"]
        A["éº¦å…‹é£<br/>16kHz PCM"]
    end
    
    subgraph LocalProc["ğŸ“± æœ¬åœ°å¤„ç†<br/>ESP32"]
        B["VADæ£€æµ‹<br/>è¯­éŸ³æ®µ"]
        C["Opusç¼–ç <br/>128kbps"]
    end
    
    subgraph Transport["ğŸŒ ç½‘ç»œä¼ è¾“"]
        D["WebSocket<br/>Port 8000"]
    end
    
    subgraph ServerProc["ğŸ–¥ï¸ æœåŠ¡å™¨å¤„ç†"]
        E["Audio Intake<br/>ç¼“å†²ç®¡ç†"]
        F["VADæ¨¡å—<br/>è¯­éŸ³æ´»åŠ¨æ£€æµ‹"]
        G["ASRæ¨¡å—<br/>FunASRè¯†åˆ«"]
    end
    
    subgraph Response["ğŸ’¬ ç”Ÿæˆå›å¤"]
        H["LLMå¤„ç†<br/>ç†è§£æ„å›¾"]
        I["MCPæ‰§è¡Œ<br/>å·¥å…·è°ƒç”¨"]
        J["TTSåˆæˆ<br/>è¯­éŸ³ç”Ÿæˆ"]
        K["Opusç¼–ç <br/>128kbps"]
    end
    
    subgraph Playback["ğŸ”Š æ’­æ”¾"]
        L["æ‰¬å£°å™¨<br/>è¾“å‡º"]
    end
    
    A -->|å®æ—¶é‡‡é›†| B
    B -->|å‹ç¼©ç¼–ç | C
    C -->|WebSocketå‘é€| D
    D -->|æ¥æ”¶| E
    E -->|MQTTäº‹ä»¶| F
    F -->|MQTTäº‹ä»¶| G
    
    G -->|è¯†åˆ«æ–‡æœ¬| H
    H -->|å·¥å…·è¯·æ±‚| I
    I -->|ç”Ÿæˆæ–‡æœ¬| J
    J -->|ç¼–ç å‹ç¼©| K
    K -->|WebSocketè¿”å›| D
    D -->|æ¥æ”¶| L
    
    style Capture fill:#c8e6c9
    style LocalProc fill:#bbdefb
    style Transport fill:#ffe0b2
    style ServerProc fill:#f8bbd0
    style Response fill:#d1c4e9
    style Playback fill:#c8e6c9
```

### 1.3.3 æ§åˆ¶æ•°æ®æµ (Control Path)

```mermaid
graph TD
    subgraph User["ğŸ‘¤ ç”¨æˆ·äº¤äº’"]
        A["è¯´è¯<br/>è§¦å‘VAD"]
        B["æŒ‰é”®<br/>äº‹ä»¶"]
        C["å”¤é†’è¯<br/>Multinet"]
    end
    
    subgraph Local["ğŸ“± ESP32<br/>æœ¬åœ°å¤„ç†"]
        D["æ‰“å¼€éŸ³é¢‘<br/>é€šé“"]
        E["ç¼–ç Opus<br/>éŸ³é¢‘"]
    end
    
    subgraph WS["ğŸŒ WebSocket<br/>é€šä¿¡"]
        F["JSONæ¶ˆæ¯<br/>Port 8000"]
    end
    
    subgraph ServerAI["ğŸ–¥ï¸ æœåŠ¡å™¨å¤„ç†"]
        G["ASRè¯†åˆ«<br/>è·å–æ–‡æœ¬"]
        H["LLMåˆ†æ<br/>ç†è§£æ„å›¾"]
        I{"éœ€è¦å·¥å…·<br/>è°ƒç”¨?"}
    end
    
    subgraph MCPExec["ğŸ”§ MCPå·¥å…·æ‰§è¡Œ"]
        J["æŸ¥è¯¢å·¥å…·<br/>åˆ—è¡¨"]
        K["å‚æ•°éªŒè¯<br/>è½¬æ¢"]
        L["æ‰§è¡Œå·¥å…·"]
        M["è¿”å›ç»“æœ"]
    end
    
    subgraph Feedback["ğŸ“¤ è¿”å›ESP32"]
        N["JSONæ ¼å¼<br/>WebSocket"]
        O["å±å¹•æ›´æ–°"]
        P["éŸ³é¢‘æ’­æ”¾"]
    end
    
    A --> D
    B --> F
    C --> D
    D --> E
    E --> F
    F --> G
    G --> H
    H --> I
    I -->|æ˜¯| J
    I -->|å¦| N
    J --> K
    K --> L
    L --> M
    M --> N
    N --> O
    N --> P
    
    style User fill:#fff9c4
    style Local fill:#bbdefb
    style ServerAI fill:#f8bbd0
    style MCPExec fill:#d1c4e9
    style Feedback fill:#c8e6c9
```

### 1.3.4 MQTTäº‹ä»¶æ€»çº¿ (Internal Message Bus)

```mermaid
graph TB
    subgraph MQTT["ğŸšŒ MQTT Broker<br/>Port 1883<br/>äº‹ä»¶æ€»çº¿"]
        subgraph Audio["Audioä¸»é¢˜"]
            A1["xiaozhi/audio/intake"]
            A2["xiaozhi/audio/vad/start"]
            A3["xiaozhi/audio/vad/end"]
        end
        
        subgraph ASRTopic["ASRä¸»é¢˜"]
            B1["xiaozhi/asr/interim"]
            B2["xiaozhi/asr/final"]
        end
        
        subgraph Intent["Intentä¸»é¢˜"]
            C1["xiaozhi/intent/detected"]
            C2["xiaozhi/intent/confidence"]
        end
        
        subgraph MCPTopic["MCPä¸»é¢˜"]
            D1["xiaozhi/mcp/tool/list"]
            D2["xiaozhi/mcp/tool/call"]
            D3["xiaozhi/mcp/tool/result"]
        end
        
        subgraph TTSTopic["TTSä¸»é¢˜"]
            E1["xiaozhi/tts/generated"]
            E2["xiaozhi/tts/ready"]
        end
    end
    
    subgraph Publishers["ğŸ“¤ å‘å¸ƒè€…"]
        P1["Audio Intake"]
        P2["VADæ¨¡å—"]
        P3["ASRæ¨¡å—"]
        P4["LLMæ¨¡å—"]
        P5["MCPæ¨¡å—"]
        P6["TTSæ¨¡å—"]
    end
    
    subgraph Subscribers["ğŸ“¥ è®¢é˜…è€…"]
        S1["ASRè®¢é˜…<br/>Audioäº‹ä»¶"]
        S2["LLMè®¢é˜…<br/>ASRç»“æœ"]
        S3["MCPè®¢é˜…<br/>æ„å›¾"]
        S4["TTSè®¢é˜…<br/>æ„å›¾"]
        S5["æ—¥å¿—ç³»ç»Ÿ<br/>è®¢é˜…å…¨éƒ¨"]
    end
    
    P1 --> A1
    P2 --> A2
    P2 --> A3
    P3 --> B1
    P3 --> B2
    P4 --> C1
    P4 --> C2
    P5 --> D1
    P5 --> D2
    P5 --> D3
    P6 --> E1
    P6 --> E2
    
    A1 --> S1
    B2 --> S2
    C1 --> S3
    C1 --> S4
    A1 --> S5
    B1 --> S5
    B2 --> S5
    C1 --> S5
    D1 --> S5
    D2 --> S5
    D3 --> S5
    E1 --> S5
    E2 --> S5
    
    style MQTT fill:#fff3e0
    style Publishers fill:#c8e6c9
    style Subscribers fill:#f8bbd0
```

### 1.3.5 å®Œæ•´çš„å¯¹è¯äº¤äº’æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User as ğŸ‘¤ ç”¨æˆ·
    participant ESP32 as ğŸ“± ESP32
    participant WS as ğŸŒ WebSocket
    participant Server as ğŸ–¥ï¸ æœåŠ¡å™¨
    participant MQTT as ğŸšŒ MQTT
    participant LLM as ğŸ§  LLM
    participant MCP as ğŸ”§ MCP
    participant TTS as ğŸµ TTS
    
    User->>ESP32: è¯´è¯"å¤©æ°”æ€ä¹ˆæ ·"
    ESP32->>ESP32: VADæ£€æµ‹è¯­éŸ³
    ESP32->>ESP32: Opusç¼–ç éŸ³é¢‘
    
    ESP32->>WS: å‘é€OpuséŸ³é¢‘æµ
    WS->>Server: è½¬å‘åˆ°Audio Intake
    Server->>Server: ç¼“å†²ç®¡ç†
    
    Server->>MQTT: å‘å¸ƒaudio/intake
    MQTT->>Server: ASRè®¢é˜…æ¥æ”¶
    Server->>Server: FunASRè¯†åˆ«
    Server->>MQTT: å‘å¸ƒasr/final<br/>"å¤©æ°”æ€ä¹ˆæ ·"
    
    MQTT->>LLM: LLMè®¢é˜…æ¥æ”¶
    LLM->>LLM: ç†è§£æ„å›¾â†’get_weather
    LLM->>MQTT: å‘å¸ƒintent/detected
    
    MQTT->>MCP: MCPè®¢é˜…æ¥æ”¶
    MCP->>MCP: æ‰§è¡Œget_weather()
    MCP->>MQTT: å‘å¸ƒtool/result<br/>"åŒ—äº¬æ™´å¤©5Â°C"
    
    MQTT->>LLM: LLMè®¢é˜…ç»“æœ
    LLM->>LLM: ç”Ÿæˆå›å¤æ–‡æœ¬
    
    MQTT->>TTS: TTSè®¢é˜…æ¥æ”¶
    TTS->>TTS: CosyVoiceåˆæˆ
    TTS->>MQTT: å‘å¸ƒtts/ready
    
    MQTT->>Server: è·å–TTSéŸ³é¢‘
    Server->>WS: è¿”å›éŸ³é¢‘æµ
    WS->>ESP32: æ¥æ”¶OpuséŸ³é¢‘
    
    ESP32->>ESP32: Opusè§£ç PCM
    ESP32->>User: ğŸ”Š æ’­æ”¾è¯­éŸ³<br/>"ä»Šå¤©åŒ—äº¬æ™´å¤©..."
    ESP32->>ESP32: å±å¹•æ˜¾ç¤ºæ–‡æœ¬
```

## 1.4 æœåŠ¡å™¨ç«¯æ¶æ„ (xiaozhi-esp32-server)

æœåŠ¡å™¨ç«¯æ˜¯ Python å®ç°çš„å¾®æœåŠ¡ç³»ç»Ÿï¼Œè´Ÿè´£æ¥æ”¶æ¥è‡ª ESP32 çš„éŸ³é¢‘ï¼Œè¿›è¡Œå¤„ç†ï¼Œå¹¶è¿”å›ç»“æœã€‚

### æ ¸å¿ƒæœåŠ¡æµç¨‹

```
ESP32 è®¾å¤‡ (WebSocket/MQTT)
    â†“
WebSocket/MQTT æœåŠ¡å™¨ (Port: 8000)
    â”‚
    â”œâ”€ Audio Intake æœåŠ¡
    â”‚   â”œâ”€ æ¥æ”¶ Opus ç¼–ç éŸ³é¢‘
    â”‚   â””â”€ ç¼“å†²ç®¡ç†
    â”‚
    â”œâ”€ VAD æœåŠ¡ (è¯­éŸ³æ´»åŠ¨æ£€æµ‹)
    â”‚   â”œâ”€ æ£€æµ‹è¯­éŸ³å¼€å§‹/ç»“æŸ
    â”‚   â””â”€ äº‹ä»¶å‘å¸ƒåˆ° MQTT
    â”‚
    â”œâ”€ ASR æœåŠ¡ (è¯­éŸ³è¯†åˆ«)
    â”‚   â”œâ”€ FunASR å¼•æ“
    â”‚   â””â”€ å®æ—¶è½¬å†™
    â”‚
    â”œâ”€ LLM æœåŠ¡ (æ„å›¾è¯†åˆ«)
    â”‚   â”œâ”€ DoubaoLLM æˆ–å…¶ä»–
    â”‚   â””â”€ ä¸Šä¸‹æ–‡ç®¡ç†
    â”‚
    â”œâ”€ MCP æœåŠ¡ (å·¥å…·è°ƒç”¨)
    â”‚   â”œâ”€ å·¥å…·å®šä¹‰åŠ è½½
    â”‚   â””â”€ å·¥å…·æ‰§è¡Œå’Œè¿”å›
    â”‚
    â””â”€ TTS æœåŠ¡ (æ–‡æœ¬è½¬è¯­éŸ³)
        â”œâ”€ æ–‡æœ¬åˆæˆ
        â””â”€ Opus ç¼–ç è¿”å›
        
    â†“
è¿”å›åˆ° ESP32 (éŸ³é¢‘/æ–‡æœ¬/æŒ‡ä»¤)
```

### é€šä¿¡åè®®

**ESP32 â†’ æœåŠ¡å™¨ï¼š**
- åŸå§‹ Opus ç¼–ç éŸ³é¢‘æµ
- éŸ³é¢‘å¸§å…ƒæ•°æ®ï¼ˆé‡‡æ ·ç‡ã€é€šé“æ•°ç­‰ï¼‰

**æœåŠ¡å™¨ â†’ ESP32ï¼š**
```json
{
    "type": "stt",          // è¯­éŸ³è½¬æ–‡æœ¬ç»“æœ
    "text": "ä½ å¥½",
    "is_final": true
}
```

```json
{
    "type": "tts",          // TTS éŸ³é¢‘è¿”å›
    "data": "base64_encoded_opus_data"
}
```

```json
{
    "type": "tool",         // MCP å·¥å…·è°ƒç”¨ç»“æœ
    "tool_name": "get_weather",
    "result": "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ¸©åº¦ 5Â°C"
}
```

```json
{
    "type": "system",       // ç³»ç»Ÿå‘½ä»¤
    "command": "reboot"
}
```

## 1.4 æœåŠ¡å™¨ç«¯æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. WebSocket/MQTT æœåŠ¡å™¨

```yaml
æœåŠ¡: audio_intake (FastAPI + WebSocket)
åœ°å€: ws://192.168.1.13:8000/xiaozhi/v1/
åŠŸèƒ½:
  - æ¥æ”¶æ¥è‡ªå¤šä¸ª ESP32 è®¾å¤‡çš„éŸ³é¢‘æµ
  - ç¼“å†²ç®¡ç†å’Œæµæ§åˆ¶
  - å°†éŸ³é¢‘åˆ†å‘åˆ° VAD/ASR å¤„ç†ç®¡é“
```

### 2. VAD æœåŠ¡ (è¯­éŸ³æ´»åŠ¨æ£€æµ‹)

```yaml
æœåŠ¡: VAD (Voice Activity Detection)
æ¨¡å‹: SileroVAD (æœ¬åœ°ç¦»çº¿)
åŠŸèƒ½:
  - æ£€æµ‹éŸ³é¢‘ä¸­æ˜¯å¦åŒ…å«è¯­éŸ³
  - æ£€æµ‹è¯­éŸ³å¼€å§‹å’Œç»“æŸç‚¹
  - å‘å¸ƒ MQTT äº‹ä»¶: mr-mcp/audio/vad/start, mr-mcp/audio/vad/end
```

### 3. ASR æœåŠ¡ (è¯­éŸ³è¯†åˆ«)

```yaml
æœåŠ¡: ASR (Automatic Speech Recognition)
æ¨¡å‹: FunASR (æœ¬åœ°ç¦»çº¿)
åŠŸèƒ½:
  - å°†éŸ³é¢‘è½¬æ¢ä¸ºæ–‡æœ¬
  - æ”¯æŒå®æ—¶è½¬å†™ï¼ˆæµå¼è¯†åˆ«ï¼‰
  - è¿”å›è¯†åˆ«ç»“æœåˆ° WebSocket å®¢æˆ·ç«¯
  ç‰ˆæœ¬: FunASR 1.2.7
```

### 4. LLM æœåŠ¡ (å¤§è¯­è¨€æ¨¡å‹)

```yaml
æœåŠ¡: LLM (å¤§æ¨¡å‹)
æ”¯æŒ: DoubaoLLM, OpenAI GPT, æœ¬åœ° Ollama ç­‰
åŠŸèƒ½:
  - ç†è§£ç”¨æˆ·æ„å›¾
  - ç”Ÿæˆå›å¤æ–‡æœ¬
  - è°ƒç”¨ MCP å·¥å…·
  - ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆå¤šè½®å¯¹è¯ï¼‰
```

### 5. MCP å·¥å…·æœåŠ¡

```yaml
æœåŠ¡: MCP (Model Context Protocol)
åŠŸèƒ½:
  - å·¥å…·å®šä¹‰å’Œæ³¨å†Œ
  - ä» LLM æ¥æ”¶å·¥å…·è°ƒç”¨è¯·æ±‚
  - æ‰§è¡Œæœ¬åœ°å·¥å…·æˆ–è°ƒç”¨å¤–éƒ¨ API
  - è¿”å›æ‰§è¡Œç»“æœ
ç¤ºä¾‹å·¥å…·:
  - è·å–å¤©æ°” (get_weather)
  - æ’­æ”¾éŸ³ä¹ (play_music)
  - æ§åˆ¶å®¶ç”µ (smart_home_control)
  - è·å–æ–°é—» (get_news)
```

### 6. TTS æœåŠ¡ (æ–‡æœ¬è½¬è¯­éŸ³)

```yaml
æœåŠ¡: TTS (Text-To-Speech)
å¼•æ“: CosyVoice æˆ–å…¶ä»–
åŠŸèƒ½:
  - å°†æ–‡æœ¬è½¬æ¢ä¸ºè¯­éŸ³
  - Opus ç¼–ç è¾“å‡º
  - æ”¯æŒå¤šç§éŸ³è‰²å’Œè¯­è¨€
  - è¿”å›éŸ³é¢‘åˆ° ESP32
```

## 1.5 äº‹ä»¶é©±åŠ¨æ¶æ„ (MQTT)

æœåŠ¡å™¨å†…éƒ¨ä½¿ç”¨ **MQTT** ä½œä¸ºäº‹ä»¶æ€»çº¿ï¼Œå„æœåŠ¡é€šè¿‡å‘å¸ƒ/è®¢é˜…è¿›è¡Œé€šä¿¡ï¼š

```
ä¸»é¢˜ç»“æ„: xiaozhi/<device_id>/<module>/<event>

ä¾‹å¦‚:
xiaozhi/device_001/audio/vad/start      - VAD æ£€æµ‹åˆ°è¯­éŸ³å¼€å§‹
xiaozhi/device_001/audio/vad/end        - VAD æ£€æµ‹åˆ°è¯­éŸ³ç»“æŸ
xiaozhi/device_001/asr/interim          - ASR ä¸­é—´è¯†åˆ«ç»“æœ
xiaozhi/device_001/asr/final            - ASR æœ€ç»ˆè¯†åˆ«ç»“æœ
xiaozhi/device_001/intent/detected      - æ„å›¾è¯†åˆ«å®Œæˆ
xiaozhi/device_001/mcp/tool_call        - MCP å·¥å…·è°ƒç”¨è¯·æ±‚
xiaozhi/device_001/tts/ready            - TTS éŸ³é¢‘ç”Ÿæˆå®Œæˆ
```

## 1.6 é¡¹ç›®æ–‡ä»¶ç»“æ„

```
xiaozhi-esp32-server/
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ xiaozhi-server/          # Python æœåŠ¡å™¨å®ç°
â”‚   â”‚   â”œâ”€â”€ app.py               # ä¸»åº”ç”¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ requirements.txt     # ä¾èµ–
â”‚   â”‚   â”œâ”€â”€ config.yaml          # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”‚   â”œâ”€â”€ providers/       # æœåŠ¡æä¾›è€…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ asr/        # ASR (FunASR)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ vad/        # VAD (SileroVAD)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tts/        # TTS
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ llm/        # LLM (DoubaoLLM/OpenAI)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ mcp/        # MCP å·¥å…·æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â””â”€â”€ handlers/       # æ¶ˆæ¯å¤„ç†
â”‚   â”‚   â””â”€â”€ websocket_server.py  # WebSocket æœåŠ¡
â”‚   â”‚
â”‚   â””â”€â”€ esp/
â”‚       â””â”€â”€ xiaozhi-esp32/       # ESP32 å›ºä»¶ä»£ç 
â”‚           â”œâ”€â”€ main/           # åº”ç”¨é€»è¾‘
â”‚           â”‚   â”œâ”€â”€ application.cc   # ä¸»çŠ¶æ€æœº
â”‚           â”‚   â”œâ”€â”€ protocol/        # MQTT/WebSocket åè®®
â”‚           â”‚   â”œâ”€â”€ audio_service.cc # éŸ³é¢‘é‡‡é›†
â”‚           â”‚   â””â”€â”€ mcp_server.cc    # MCP å·¥å…·æœåŠ¡
â”‚           â”œâ”€â”€ components/      # ç¡¬ä»¶é©±åŠ¨
â”‚           â””â”€â”€ boards/         # æ¿å¡æ”¯æŒ
â”‚
â”œâ”€â”€ docker-compose.yml           # å®¹å™¨ç¼–æ’
â”œâ”€â”€ Dockerfile-server            # æœåŠ¡å™¨é•œåƒ
â””â”€â”€ docs/
    â”œâ”€â”€ Deployment.md            # éƒ¨ç½²æŒ‡å—
    â””â”€â”€ mcp-endpoint-integration.md
```

## 1.7 éƒ¨ç½²æ–¹å¼

### éƒ¨ç½²æ–¹å¼ 1ï¼šDocker å®¹å™¨

```bash
# ä¸€é”®å¯åŠ¨æœåŠ¡å™¨
docker compose up -d

# éªŒè¯æœåŠ¡
curl http://localhost:8003/xiaozhi/ota/
```

**æœåŠ¡åœ°å€ï¼š**
- WebSocket: `ws://192.168.1.13:8000/xiaozhi/v1/`
- HTTP (OTA/Vision): `http://192.168.1.13:8003/xiaozhi/ota/`

### éƒ¨ç½²æ–¹å¼ 2ï¼šæœ¬åœ°æºç è¿è¡Œ

```bash
# åˆ›å»º conda ç¯å¢ƒ
conda create -n xiaozhi-esp32-server python=3.10 -y
conda activate xiaozhi-esp32-server
conda install libopus ffmpeg -y

# å®‰è£…ä¾èµ–
cd main/xiaozhi-server
pip install -r requirements.txt

# é…ç½®æ–‡ä»¶
# ç¼–è¾‘ data/.config.yaml (æˆ– config.yaml)

# è¿è¡ŒæœåŠ¡å™¨
python app.py
```

## 1.8 å…³é”®é…ç½®è¯´æ˜

### config.yaml æ ¸å¿ƒé…ç½®é¡¹

```yaml
# LLM é…ç½®ï¼ˆå¿…é¡»é…ç½® API Keyï¼‰
llm:
  provider: doubao        # æ”¯æŒ: doubao, openai, ollama, local
  api_key: "your-api-key"
  model: "gpt-4"

# ASR é…ç½®
asr:
  provider: funasr       # FunASR ç¦»çº¿è¯†åˆ«
  model_path: models/SenseVoiceSmall/model.pt
  
# VAD é…ç½®
vad:
  provider: silero       # SileroVAD ç¦»çº¿æ£€æµ‹
  
# TTS é…ç½®
tts:
  provider: cosyvoice    # CosyVoice æˆ–å…¶ä»–
  
# WebSocket é…ç½®
websocket:
  host: 0.0.0.0
  port: 8000
  path: /xiaozhi/v1/
```

## 1.9 å…¸å‹å¯¹è¯æµç¨‹

```
ESP32 ç”¨æˆ·è¯´è¯:
  "å¤©æ°”æ€ä¹ˆæ ·"
    â†“
[ESP32] æœ¬åœ° VAD æ£€æµ‹åˆ°è¯­éŸ³ â†’ æ‰“å¼€éŸ³é¢‘é€šé“
    â†“
[ESP32] æœ¬åœ° Multinet æ£€æµ‹åˆ°å”¤é†’è¯ "å°æ™º"
    â†“
[ESP32] å‘é€éŸ³é¢‘åˆ°æœåŠ¡å™¨ (WebSocket/MQTT)
    â†“
[æœåŠ¡å™¨] Audio Intake æ¥æ”¶éŸ³é¢‘
    â†“
[æœåŠ¡å™¨] VAD æ£€æµ‹è¯­éŸ³æ®µè½
    â†“
[æœåŠ¡å™¨] ASR (FunASR) è¯†åˆ«: "å¤©æ°”æ€ä¹ˆæ ·"
    â†“
[æœåŠ¡å™¨] LLM (DoubaoLLM) ç†è§£æ„å›¾ â†’ è°ƒç”¨ MCP å·¥å…·
    â†“
[æœåŠ¡å™¨] MCP å·¥å…·æ‰§è¡Œ: get_weather()
    â†“
[æœåŠ¡å™¨] è·å–ç»“æœ: "åŒ—äº¬ä»Šå¤©æ™´å¤© 5Â°C"
    â†“
[æœåŠ¡å™¨] LLM ç”Ÿæˆè‡ªç„¶è¯­è¨€å›å¤
    â†“
[æœåŠ¡å™¨] TTS (CosyVoice) ç”Ÿæˆè¯­éŸ³
    â†“
[æœåŠ¡å™¨] è¿”å›è¯­éŸ³åˆ° ESP32 (WebSocket/MQTT)
    â†“
[ESP32] æ’­æ”¾è¯­éŸ³åˆ°æ‰¬å£°å™¨
    â†“
å¯¹è¯å®Œæˆï¼Œå›åˆ°å¾…æœºçŠ¶æ€
```

---

# ç¬¬äºŒéƒ¨åˆ†ï¼šMR-MCP-Server è¯¦ç»†è®¾è®¡

## 2.1 è®¾è®¡ç›®æ ‡ä¸åŸåˆ™

### è®¾è®¡ç›®æ ‡
1. âœ… **è¿œç¨‹éŸ³é¢‘è¾“å…¥** - Streamlit Web UI é€šè¿‡ Opus ç¼–ç ä¼ è¾“éŸ³é¢‘
2. âœ… **å†…éƒ¨é€šä¿¡** - åŸºäº Socket/MQTT æ¶æ„çš„æœåŠ¡é—´é€šä¿¡
3. âœ… **å®æ—¶å¤„ç†** - å¤šçº¿ç¨‹å¹¶å‘å¤„ç†è¯­éŸ³æµ
4. âœ… **MCPå·¥å…·é›†æˆ** - çµæ´»çš„å·¥å…·è°ƒç”¨æ¡†æ¶
5. âœ… **æœ¬åœ°éƒ¨ç½²** - å®Œå…¨åŸºäºå±€åŸŸç½‘ï¼Œæ— äº’è”ç½‘ä¾èµ–
6. âœ… **çŠ¶æ€ç®¡ç†** - åˆ†å¸ƒå¼çŠ¶æ€åŒæ­¥

### è®¾è®¡åŸåˆ™
- **æ¨¡å—åŒ–** - å„æœåŠ¡ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
- **äº‹ä»¶é©±åŠ¨** - åŸºäºMQTTçš„æ¾è€¦åˆæ¶æ„
- **é«˜å¯ç”¨** - è‡ªåŠ¨æ¢å¤å’Œé‡è¯•æœºåˆ¶
- **æ˜“æ‰©å±•** - å·¥å…·æ¡†æ¶ç®€åŒ–æ·»åŠ æ–°åŠŸèƒ½
- **å¯è§‚æµ‹** - å®Œæ•´çš„æ—¥å¿—å’Œç›‘æ§

## 2.2 ç³»ç»Ÿçº§æ¶æ„æ¡†å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚ (User Client 192.168.0.10)"
        Browser["ğŸŒ Streamlit Web UI"]
        Opus["ğŸ™ï¸ Opusç¼–ç å™¨<br/>è´¨é‡: 128kbps<br/>é‡‡æ ·ç‡: 16kHz"]
    end
    
    subgraph "ç½‘ç»œä¼ è¾“å±‚"
        WS["ğŸ”Œ WebSocket<br/>éŸ³é¢‘æµé€šé“<br/>ws://192.168.1.13:8000"]
        MQTT["ğŸ“¡ MQTT Broker<br/>äº‹ä»¶æ€»çº¿<br/>192.168.1.13:1883"]
    end
    
    subgraph "æœåŠ¡å¤„ç†å±‚ (192.168.1.13)"
        Intake["ğŸ“¥ éŸ³é¢‘IntakeæœåŠ¡<br/>- Opusè§£ç <br/>- ç¼“å†²ç®¡ç†<br/>- æµæ§åˆ¶"]
        
        VAD["ğŸ” VADæœåŠ¡<br/>- è¯­éŸ³æ£€æµ‹<br/>- ç«¯ç‚¹æ£€æµ‹<br/>- äº‹ä»¶å‘å¸ƒ"]
        
        ASR["ğŸ—£ï¸ ASRæœåŠ¡<br/>- FunASRå¼•æ“<br/>- å®æ—¶è½¬å†™<br/>- ç½®ä¿¡åº¦è¯„ä¼°"]
        
        Intent["ğŸ§  æ„å›¾è¯†åˆ«æœåŠ¡<br/>- å¤§æ¨¡å‹æ¨ç†<br/>- ä¸Šä¸‹æ–‡ç®¡ç†<br/>- æ§½ä½å¡«å……"]
        
        MCP["ğŸ”§ MCPæ‰§è¡Œå¼•æ“<br/>- å·¥å…·è·¯ç”±<br/>- å‚æ•°éªŒè¯<br/>- å¼‚å¸¸å¤„ç†"]
        
        Reply["âœï¸ å›å¤ç”Ÿæˆ<br/>- æ–‡æœ¬ç”Ÿæˆ<br/>- æ ¼å¼åŒ–<br/>- ä¸Šä¸‹æ–‡æ•´åˆ"]
        
        TTS["ğŸµ TTSæœåŠ¡<br/>- CosyVoiceåˆæˆ<br/>- Opusç¼–ç <br/>- æƒ…æ„Ÿå¤„ç†"]
    end
    
    subgraph "å­˜å‚¨å±‚"
        History["ğŸ’¾ å¯¹è¯å†å²<br/>MongoDB<br/>- ç”¨æˆ·ä¼šè¯<br/>- ä¸Šä¸‹æ–‡è®°å½•"]
        Cache["âš¡ ç¼“å­˜å±‚<br/>Redis<br/>- ä¼šè¯çŠ¶æ€<br/>- é¢‘ç¹æŸ¥è¯¢"]
        Config["âš™ï¸ é…ç½®ä¸­å¿ƒ<br/>JSON/YAML<br/>- MCPå®šä¹‰<br/>- å·¥å…·å‚æ•°"]
    end
    
    Browser -->|"Opusç¼–ç <br/>WebSocket"| WS
    WS --> Intake
    
    Intake -->|"PCMéŸ³é¢‘"| VAD
    VAD -->|"è¯­éŸ³äº‹ä»¶"| MQTT
    
    VAD -->|"éŸ³é¢‘æ®µ"| ASR
    ASR -->|"æ–‡æœ¬"| MQTT
    
    ASR -->|"è¯†åˆ«æ–‡æœ¬"| Intent
    Intent -->|"æ„å›¾"| MQTT
    Intent <-->|"è¯»å†™"| History
    Intent <-->|"æŸ¥è¯¢"| Cache
    
    Intent -->|"MCPè¯·æ±‚"| MCP
    MCP -->|"æ“ä½œç»“æœ"| Reply
    MCP <-->|"å·¥å…·å®šä¹‰"| Config
    
    Reply -->|"ç”Ÿæˆæ–‡æœ¬"| TTS
    TTS -->|"è¯­éŸ³æ•°æ®<br/>WebSocket"| WS
    WS -->|"Opusç¼–ç "| Browser
```


## 2.3 Opus éŸ³é¢‘ç¼–ç è§„èŒƒ

### ç¼–ç å‚æ•°

```yaml
opus_config:
  é‡‡æ ·ç‡: 16kHz           # è¯­éŸ³ä¼˜åŒ–é¢‘ç‡
  æ¯”ç‰¹ç‡: 128kbps        # å¹³è¡¡è´¨é‡å’Œå¸¦å®½
  å£°é“: 1               # å•å£°é“ (Mono)
  å¸§æ—¶é•¿: 60ms          # 960æ ·æœ¬ @ 16kHz
  å¤æ‚åº¦: 10            # æœ€é«˜è´¨é‡
  VBR: true            # å¯å˜æ¯”ç‰¹ç‡
  bandwidth: wideband  # 16kHzå¸¦å®½

æ€§èƒ½æŒ‡æ ‡:
  ç¼–ç å»¶è¿Ÿ: < 10ms
  ä¼ è¾“å»¶è¿Ÿ: < 50ms
  æ€»å¾€è¿”å»¶è¿Ÿ: < 100ms
  
ç½‘ç»œä¼˜åŠ¿:
  2åˆ†é’ŸéŸ³é¢‘æ•°æ®: â‰ˆ 1.92 MB
  1å°æ—¶è¿ç»­éŸ³é¢‘: â‰ˆ 57.6 MB
  å®æ—¶å¸¦å®½æ¶ˆè€—: â‰ˆ 128 kbps
```

## 2.4 é€šä¿¡åè®®è®¾è®¡

### WebSocket éŸ³é¢‘å¸§æ ¼å¼

**å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ (éŸ³é¢‘ä¸Šä¼ )**:
```json
{
    "type": "audio",
    "frame_type": "audio",
    "session_id": "uuid-string",
    "timestamp": 1705420225.123,
    "sequence": 1234,
    "codec": "opus",
    "sample_rate": 16000,
    "channels": 1,
    "data": "base64_encoded_opus_data"
}
```

**æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ (å®æ—¶å­—å¹•)**:
```json
{
    "type": "transcript",
    "session_id": "uuid-string",
    "timestamp": 1705420225.234,
    "text": "ä½ å¥½ï¼Œè¿™æ˜¯è¯†åˆ«ç»“æœ",
    "is_final": false,
    "confidence": 0.92
}
```

### MQTT äº‹ä»¶æ€»çº¿è®¾è®¡

**ä¸»é¢˜ç»“æ„** (å‰ç¼€: `mr-mcp/`):

```
mr-mcp/
â”œâ”€â”€ audio/
â”‚   â”œâ”€â”€ intake/chunk       # éŸ³é¢‘chunkäº‹ä»¶
â”‚   â”œâ”€â”€ vad/start          # VADè¯­éŸ³å¼€å§‹
â”‚   â””â”€â”€ vad/end            # VADè¯­éŸ³ç»“æŸ
â”œâ”€â”€ asr/
â”‚   â”œâ”€â”€ interim            # ASRä¸­é—´è¯†åˆ«ç»“æœ
â”‚   â””â”€â”€ final              # ASRæœ€ç»ˆè¯†åˆ«ç»“æœ
â”œâ”€â”€ intent/
â”‚   â”œâ”€â”€ detected           # æ„å›¾æ£€æµ‹å®Œæˆ
â”‚   â””â”€â”€ error              # æ„å›¾è¯†åˆ«é”™è¯¯
â”œâ”€â”€ mcp/
â”‚   â”œâ”€â”€ tool/call          # MCPå·¥å…·è°ƒç”¨è¯·æ±‚
â”‚   â”œâ”€â”€ tool/result        # MCPå·¥å…·æ‰§è¡Œç»“æœ
â”‚   â””â”€â”€ tool/error         # MCPå·¥å…·æ‰§è¡Œé”™è¯¯
â””â”€â”€ tts/
    â””â”€â”€ ready              # TTSåˆæˆå®Œæˆ
```

## 2.5 é¡¹ç›®ä»£ç ç»“æ„è§„åˆ’

```
mr-mcp-server/
â”œâ”€â”€ README.md
â”œâ”€â”€ è®¾è®¡è¯´æ˜.md (æœ¬æ–‡æ¡£)
â”‚
â”œâ”€â”€ client/                          # Streamlitå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ app.py                      # ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ audio_manager.py            # éŸ³é¢‘é‡‡é›†+Opusç¼–ç 
â”‚   â”œâ”€â”€ websocket_client.py         # WebSocketå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ ui_components.py            # UIç»„ä»¶
â”‚   â”œâ”€â”€ session_state.py            # ä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ config.yaml
â”‚   â””â”€â”€ requirements.txt
â”‚
â”œâ”€â”€ services/                        # å¾®æœåŠ¡å®ç°
â”‚   â”œâ”€â”€ audio_intake/
â”‚   â”‚   â”œâ”€â”€ server.py               # WebSocketæœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ opus_decoder.py         # Opusè§£ç å™¨
â”‚   â”‚   â”œâ”€â”€ buffer_manager.py       # ç¼“å†²ç®¡ç†
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”‚
â”‚   â”œâ”€â”€ vad/
â”‚   â”‚   â”œâ”€â”€ service.py              # VADä¸»æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ detector.py             # VADæ£€æµ‹å™¨
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”‚
â”‚   â”œâ”€â”€ asr/
â”‚   â”‚   â”œâ”€â”€ service.py              # ASRä¸»æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ recognizer.py           # è¯†åˆ«å™¨
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”‚
â”‚   â”œâ”€â”€ intent/
â”‚   â”‚   â”œâ”€â”€ service.py              # ä¸»æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ context_manager.py      # ä¸Šä¸‹æ–‡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ llm_client.py           # LLMè°ƒç”¨
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”‚
â”‚   â”œâ”€â”€ mcp/
â”‚   â”‚   â”œâ”€â”€ service.py              # ä¸»æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ engine.py               # æ‰§è¡Œå¼•æ“
â”‚   â”‚   â”œâ”€â”€ tool_loader.py          # å·¥å…·åŠ è½½
â”‚   â”‚   â”œâ”€â”€ tools/                  # å·¥å…·å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ base.py             # åŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ reminder.py         # æé†’å·¥å…·
â”‚   â”‚   â”‚   â””â”€â”€ messaging.py        # æ¶ˆæ¯å·¥å…·
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”‚
â”‚   â””â”€â”€ tts/
â”‚       â”œâ”€â”€ service.py              # TTSä¸»æœåŠ¡
â”‚       â”œâ”€â”€ synthesizer.py          # åˆæˆå™¨
â”‚       â””â”€â”€ config.py
â”‚
â”œâ”€â”€ shared/                          # å…±äº«æ¨¡å—
â”‚   â”œâ”€â”€ mqtt_bus.py                 # MQTTäº‹ä»¶æ€»çº¿
â”‚   â”œâ”€â”€ models.py                   # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ constants.py                # å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ logger.py                   # æ—¥å¿—é…ç½®
â”‚
â”œâ”€â”€ config/                          # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ config.yaml                 # ä¸»é…ç½®
â”‚   â”œâ”€â”€ tools_definition.json       # MCPå·¥å…·å®šä¹‰
â”‚   â””â”€â”€ prompts.yaml                # LLM Prompts
â”‚
â”œâ”€â”€ docker/
â”‚   â””â”€â”€ docker-compose.yml          # æœåŠ¡ç¼–æ’
â”‚
â””â”€â”€ tests/                           # æµ‹è¯•
    â”œâ”€â”€ test_audio.py
    â”œâ”€â”€ test_websocket.py
    â””â”€â”€ test_mqtt.py
```


## 2.6 å®ç°è·¯çº¿å›¾ (10å‘¨)

### Phase 1: åŸºç¡€æ¡†æ¶ (ç¬¬1-2å‘¨)
**ç›®æ ‡**: å»ºç«‹é¡¹ç›®åŸºç¡€æ¶æ„å’Œé€šä¿¡æœºåˆ¶

- [x] é¡¹ç›®åˆå§‹åŒ–å’Œç›®å½•ç»“æ„
- [ ] WebSocketæœåŠ¡å™¨å®ç° + Opusç¼–è§£ç åº“é›†æˆ
- [ ] MQTT Brokeréƒ¨ç½²å’Œäº‹ä»¶æ€»çº¿å®ç°
- [ ] åŸºæœ¬çš„Streamlitå®¢æˆ·ç«¯æ¡†æ¶
- [ ] Docker ComposeåŸºç¡€é…ç½®
- [ ] **éªŒè¯**: éŸ³é¢‘å®æ—¶ä¼ è¾“æˆåŠŸ

### Phase 2: æ ¸å¿ƒéŸ³é¢‘æœåŠ¡ (ç¬¬3-4å‘¨)
**ç›®æ ‡**: å®ç°éŸ³é¢‘é‡‡é›†ã€å¤„ç†ã€è¯†åˆ«çš„å®Œæ•´é“¾è·¯

- [ ] Audio IntakeæœåŠ¡ï¼ˆOpusè§£ç ã€ç¼“å†²ï¼‰
- [ ] VADæœåŠ¡é›†æˆï¼ˆå®æ—¶è¯­éŸ³æ£€æµ‹ï¼‰
- [ ] ASRæœåŠ¡é›†æˆï¼ˆFunASRå¼•æ“ï¼‰
- [ ] å®æ—¶å­—å¹•æ¨é€åˆ°å®¢æˆ·ç«¯
- [ ] MQTTäº‹ä»¶æµè”è°ƒ
- [ ] **éªŒè¯**: éŸ³é¢‘è¯†åˆ«å…¨æµç¨‹å¯ç”¨

### Phase 3: æ™ºèƒ½å¤„ç†å±‚ (ç¬¬5-6å‘¨)
**ç›®æ ‡**: å®ç°æ„å›¾è¯†åˆ«å’Œå¯¹è¯ç®¡ç†

- [ ] æ„å›¾è¯†åˆ«æœåŠ¡ï¼ˆå¤§æ¨¡å‹æ¨ç†ï¼‰
- [ ] å¯¹è¯å†å²ç®¡ç†ï¼ˆMongoDBï¼‰
- [ ] å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡æ”¯æŒ
- [ ] Redisç¼“å­˜å±‚é›†æˆ
- [ ] Promptä¼˜åŒ–å’Œæµ‹è¯•
- [ ] **éªŒè¯**: æ„å›¾è¯†åˆ«å‡†ç¡®ç‡>85%

### Phase 4: MCPå·¥å…·é›†æˆ (ç¬¬7-8å‘¨)
**ç›®æ ‡**: å®ç°MCPæ‰§è¡Œå¼•æ“å’Œå·¥å…·ç®¡ç†

- [ ] MCPæ‰§è¡Œå¼•æ“æ ¸å¿ƒå®ç°
- [ ] å·¥å…·åŠ¨æ€åŠ è½½æ¡†æ¶
- [ ] å‚æ•°éªŒè¯å’Œè½¬æ¢
- [ ] å¼‚å¸¸å¤„ç†å’Œé‡è¯•é€»è¾‘
- [ ] 3-5ä¸ªç¤ºä¾‹å·¥å…·å®ç°
- [ ] **éªŒè¯**: å·¥å…·è°ƒç”¨æˆåŠŸç‡>95%

### Phase 5: ä¼˜åŒ–å’Œå®Œå–„ (ç¬¬9-10å‘¨)
**ç›®æ ‡**: æ€§èƒ½ä¼˜åŒ–ã€æ–‡æ¡£ã€éƒ¨ç½²

- [ ] ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å†²åŒºè°ƒä¼˜ã€æ¨¡å‹åŠ é€Ÿï¼‰
- [ ] é”™è¯¯æ¢å¤æœºåˆ¶å®Œå–„
- [ ] ç³»ç»Ÿç›‘æ§å’Œæ—¥å¿—é…ç½®
- [ ] å®Œæ•´çš„å¼€å‘å’Œéƒ¨ç½²æ–‡æ¡£
- [ ] é›†æˆæµ‹è¯•å’Œå‹åŠ›æµ‹è¯•
- [ ] **éªŒè¯**: ç³»ç»Ÿå¯é è¿è¡Œ>99%

## 2.7 å…³é”®æŠ€æœ¯è¦ç‚¹

### Opusç¼–ç å…³é”®å‚æ•°

```python
import opuslib

# å®¢æˆ·ç«¯ç¼–ç å™¨é…ç½®
encoder = opuslib.Encoder(
    16000,                      # é‡‡æ ·ç‡ 16kHz
    1,                          # å•å£°é“
    opuslib.APPLICATION_VOIP    # VoIPåº”ç”¨
)
encoder.bitrate = 128000        # 128 kbps
encoder.bandwidth = opuslib.BANDWIDTH_WIDEBAND
encoder.complexity = 10         # æœ€é«˜è´¨é‡
encoder.use_vbr = True         # å¯å˜æ¯”ç‰¹ç‡
encoder.vbr_constraint = False

# æœåŠ¡ç«¯è§£ç å™¨é…ç½®
decoder = opuslib.Decoder(16000, 1)
```

### MQTTäº‹ä»¶é©±åŠ¨æ¡†æ¶

```python
from shared.mqtt_bus import get_mqtt_bus, init_mqtt_bus

# åˆå§‹åŒ–MQTTæ€»çº¿
mqtt_bus = init_mqtt_bus()

# è®¢é˜…äº‹ä»¶
async def handle_vad_start(payload):
    print(f"VAD detected speech start: {payload}")

mqtt_bus.subscribe("mr-mcp/audio/vad/start", handle_vad_start)

# å‘å¸ƒäº‹ä»¶
mqtt_bus.publish("mr-mcp/audio/vad/start", {
    "session_id": "uuid",
    "timestamp": 1705420225.123,
    "audio_level": 0.65
})
```

---

## æ–‡æ¡£ä¿¡æ¯

**ä½œè€…**: Jiheng Zhang  
**é‚®ç®±**: jiheng.zhang@gehealthcare.com  
**SSO ID**: 212597558  
**ç‰ˆæƒ**: Â© 2026 GE Healthcare. All rights reserved.  
**æœ€åä¿®æ”¹**: 2026-01-17

---

---

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¿«é€Ÿå…¥é—¨æŒ‡å—

## 3.1 30ç§’å¿«é€Ÿå¼€å§‹

```bash
# 1. æ¿€æ´»ç¯å¢ƒ
conda activate audio_env

# 2. è¿›å…¥é¡¹ç›®
cd /home/tester/AI_Tools/mr-mcp-server

# 3. åˆå§‹åŒ–é¡¹ç›®
bash setup.sh

# 4. å¯åŠ¨æœåŠ¡ï¼ˆæ–°ç»ˆç«¯ï¼‰
bash scripts/start_audio_intake.sh &
bash scripts/start_streamlit.sh

# 5. æ‰“å¼€æµè§ˆå™¨
# http://localhost:8501
```

## 3.2 Condaç¯å¢ƒé…ç½®

### æŸ¥çœ‹æ‰€æœ‰ Conda ç¯å¢ƒ

```bash
# æŸ¥çœ‹æ‰€æœ‰ conda ç¯å¢ƒ
conda env list

# é¢„æœŸè¾“å‡ºï¼š
# base                  /home/tester/miniconda3
# audio_env          *  /home/tester/miniconda3/envs/audio_env
```

### æ¿€æ´»ç¯å¢ƒ

**æ–¹å¼1ï¼šç›´æ¥æ¿€æ´»ï¼ˆæ¨èï¼‰**

```bash
# æ¿€æ´» audio_env ç¯å¢ƒ
conda activate audio_env

# éªŒè¯æ¿€æ´»ï¼ˆæç¤ºç¬¦ä¼šæ˜¾ç¤º (audio_env)ï¼‰
# (audio_env) $ 
```

**æ–¹å¼2ï¼šåœ¨è„šæœ¬ä¸­æ¿€æ´»**

```bash
#!/bin/bash
eval "$(conda shell.bash hook)"
conda activate audio_env

# åç»­å‘½ä»¤è‡ªåŠ¨åœ¨ audio_env ä¸­è¿è¡Œ
python --version
```

### ç¯å¢ƒä¿¡æ¯

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate audio_env

# æŸ¥çœ‹ Python ç‰ˆæœ¬
python --version

# æŸ¥çœ‹ pip ç‰ˆæœ¬
pip --version

# æŸ¥çœ‹æ‰€æœ‰å·²å®‰è£…çš„åŒ…
pip list

# æŸ¥çœ‹ç¯å¢ƒè·¯å¾„
python -c "import sys; print(sys.prefix)"
```

### é¢„æœŸè¾“å‡º

```
(audio_env) $ python --version
Python 3.10.x

(audio_env) $ pip --version
pip x.x.x from /home/tester/miniconda3/envs/audio_env/lib/python3.10/site-packages/pip ...

(audio_env) $ python -c "import sys; print(sys.prefix)"
/home/tester/miniconda3/envs/audio_env
```

### åŒ…ç®¡ç†

**æŸ¥çœ‹å·²å®‰è£…åŒ…**

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate audio_env

# æ˜¾ç¤ºæ‰€æœ‰åŒ…
pip list

# æ˜¾ç¤ºç‰¹å®šåŒ…çš„ç‰ˆæœ¬
pip show fastapi
pip show uvicorn
```

**å®‰è£…æ–°åŒ…**

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate audio_env

# é€šè¿‡ conda å®‰è£…
conda install package_name

# é€šè¿‡ pip å®‰è£…
pip install package_name

# å®‰è£…æŒ‡å®šç‰ˆæœ¬
pip install package_name==1.0.0
```

**æ›´æ–°åŒ…**

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate audio_env

# æ›´æ–° pip
pip install --upgrade pip

# æ›´æ–°ç‰¹å®šåŒ…
pip install --upgrade package_name

# ä» requirements.txt æ›´æ–°æ‰€æœ‰åŒ…
pip install -r requirements.txt --upgrade
```

---

# ç¬¬å››éƒ¨åˆ†ï¼šStreamlitå®¢æˆ·ç«¯æ–‡æ¡£

## 4.1 å®¢æˆ·ç«¯æ¦‚è¿°

è¯¥å®¢æˆ·ç«¯æä¾›ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„ Web ç•Œé¢ï¼Œæ”¯æŒï¼š
- ğŸ¤ å®æ—¶éŸ³é¢‘é‡‡é›†ï¼ˆé€šè¿‡éº¦å…‹é£ï¼‰
- ğŸ”Š Opus é«˜æ•ˆç¼–ç ï¼ˆ128kbpsï¼Œ16kHzï¼‰
- ğŸ’¬ WebSocket å®æ—¶ä¼ è¾“åˆ°æœåŠ¡å™¨
- ğŸ“Š å®æ—¶éŸ³é‡ç›‘æ§
- ğŸ’­ å¯¹è¯å†å²æ˜¾ç¤º
- ğŸ”Œ è‡ªåŠ¨è¿æ¥ç®¡ç†

## 4.2 å®‰è£…å’Œå¯åŠ¨

### å®‰è£…ä¾èµ–

```bash
# å®‰è£… Python ä¾èµ–
pip install -r client/requirements.txt

# æˆ–ä½¿ç”¨ conda
conda install --file client/requirements.txt
```

**æ³¨æ„**: æŸäº›ä¾èµ–ï¼ˆpyaudio, opuslibï¼‰å¯èƒ½éœ€è¦ç³»ç»Ÿåº“æ”¯æŒï¼š

```bash
# Ubuntu/Debian
sudo apt-get install python3-dev portaudio19-dev libopus-dev

# macOS
brew install portaudio opus

# Windows
# ä½¿ç”¨é¢„ç¼–è¯‘çš„ wheelsï¼ˆpip ä¼šè‡ªåŠ¨ä¸‹è½½ï¼‰
```

### å¯åŠ¨æœåŠ¡å™¨

ç¡®ä¿ WebSocket æœåŠ¡å™¨å·²å¯åŠ¨ï¼š

```bash
# ç»ˆç«¯ 1: å¯åŠ¨ MQTT broker
sudo systemctl start mosquitto

# ç»ˆç«¯ 2: å¯åŠ¨ WebSocket éŸ³é¢‘æœåŠ¡å™¨
./scripts/start_audio_intake.sh

# è¾“å‡ºåº”æ˜¾ç¤º:
# INFO     - Server started: ws://0.0.0.0:8000/ws/audio
```

### å¯åŠ¨ Streamlit å®¢æˆ·ç«¯

```bash
# ç»ˆç«¯ 3: å¯åŠ¨ Streamlit åº”ç”¨
./scripts/start_streamlit.sh

# æˆ–ç›´æ¥ä½¿ç”¨ streamlit å‘½ä»¤
streamlit run client/app.py
```

åº”ç”¨å°†åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œé€šå¸¸æ˜¯ `http://localhost:8501`

## 4.3 ä½¿ç”¨æŒ‡å—

### åŸºæœ¬æµç¨‹

1. **è¿æ¥**: ç‚¹å‡» "ğŸ”Œ è¿æ¥" æŒ‰é’®è¿æ¥åˆ° WebSocket æœåŠ¡å™¨
2. **å½•éŸ³**: ç‚¹å‡» "ğŸ¤ å¼€å§‹å½•éŸ³" å¼€å§‹é‡‡é›†éŸ³é¢‘
3. **è¯´è¯**: å¯¹ç€éº¦å…‹é£è¯´è¯
4. **åœæ­¢**: ç‚¹å‡» "â¹ åœæ­¢å½•éŸ³" ç»“æŸæœ¬è½®äº¤äº’
5. **æŸ¥çœ‹ç»“æœ**: åœ¨å¯¹è¯æ¡†ä¸­æŸ¥çœ‹è½¬å½•å’Œå“åº”

### ç•Œé¢ç»„ä»¶

#### æ§åˆ¶é¢æ¿
- **ğŸ”Œ è¿æ¥**: è¿æ¥/æ–­å¼€ WebSocket æœåŠ¡å™¨
- **ğŸ¤ å¼€å§‹å½•éŸ³**: å¯åŠ¨éŸ³é¢‘é‡‡é›†æµ
- **â¹ åœæ­¢å½•éŸ³**: ç»“æŸéŸ³é¢‘ä¼ è¾“

#### å®æ—¶ç›‘æ§ï¼ˆå³ä¾§è¾¹æ ï¼‰
- **è¿æ¥çŠ¶æ€**: æ˜¾ç¤ºæœåŠ¡å™¨è¿æ¥çŠ¶æ€
- **å½•éŸ³çŠ¶æ€**: æ˜¾ç¤ºå½“å‰æ˜¯å¦åœ¨å½•éŸ³
- **éŸ³é‡æ°´å¹³**: å®æ—¶éŸ³é¢‘çº§åˆ«æŒ‡ç¤º
- **ç»Ÿè®¡ä¿¡æ¯**: 
  - å·²å‘é€å¸§æ•°
  - å·²æ¥æ”¶å¸§æ•°
  - è¿æ¥æ—¶é•¿
  - ä¼šè¯ ID

#### å¯¹è¯åŒºåŸŸï¼ˆå·¦ä¾§ä¸»åŒºåŸŸï¼‰
- **ğŸ’¬ å¯¹è¯**: æ˜¾ç¤ºå®Œæ•´çš„å¯¹è¯å†å²
- **ğŸ“ å®æ—¶è½¬å½•**: æ˜¾ç¤ºå®æ—¶è½¬å½•æ–‡æœ¬
- **ğŸ“Š å¯¹è¯**: æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯å’ŒåŠ©æ‰‹å“åº”

### è®¾ç½®é¢æ¿

ç‚¹å‡»å·¦ä¾§è¾¹æ çš„ "âš™ï¸ è®¾ç½®" å±•å¼€é«˜çº§é€‰é¡¹ï¼š

- **Server URI**: WebSocket æœåŠ¡å™¨åœ°å€
  - é»˜è®¤: `ws://localhost:8000/ws/audio`
  - ç¤ºä¾‹: `ws://192.168.1.100:8000/ws/audio`
- **Auto Reconnect**: è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡æ–°è¿æ¥
- **Debug Mode**: å¯ç”¨è°ƒè¯•æ—¥å¿—è¾“å‡º

## 4.4 é…ç½®

### ç¯å¢ƒå˜é‡

```bash
# WebSocket æœåŠ¡å™¨åœ°å€
export WEBSOCKET_SERVER=ws://localhost:8000/ws/audio

# è°ƒè¯•æ¨¡å¼
export DEBUG_MODE=true

# å¯åŠ¨å®¢æˆ·ç«¯
./scripts/start_streamlit.sh
```

### éŸ³é¢‘å‚æ•° (client/config.py)

```python
sample_rate: int = 16000        # é‡‡æ ·ç‡ (Hz)
chunk_duration_ms: int = 60     # æ¯ä¸ªå—çš„æŒç»­æ—¶é—´ (ms)
bitrate: int = 128000           # Opus æ¯”ç‰¹ç‡ (bps)
```

ä¿®æ”¹è¿™äº›å€¼éœ€è¦é‡å¯åº”ç”¨ã€‚

## 4.5 WebSocket é€šè®¯åè®®

### å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨

#### å¯åŠ¨æµ (START Frame)
```json
{
  "type": "audio",
  "frame_type": "start",
  "session_id": "uuid-string",
  "timestamp": 1705420225.123
}
```

#### éŸ³é¢‘å¸§ (AUDIO Frame)
```json
{
  "type": "audio",
  "frame_type": "audio",
  "session_id": "uuid-string",
  "timestamp": 1705420225.123,
  "sequence": 1,
  "codec": "opus",
  "sample_rate": 16000,
  "channels": 1,
  "data": "hex_encoded_opus_bytes"
}
```

#### ç»“æŸæµ (END Frame)
```json
{
  "type": "audio",
  "frame_type": "end",
  "session_id": "uuid-string",
  "timestamp": 1705420225.123
}
```

### æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯

#### çŠ¶æ€æ¶ˆæ¯
```json
{
  "type": "status",
  "session_id": "uuid-string",
  "message": "Audio received",
  "frames_received": 10
}
```

#### è½¬å½•ç»“æœ
```json
{
  "type": "transcript",
  "session_id": "uuid-string",
  "text": "ä½ å¥½",
  "is_final": false,
  "confidence": 0.95
}
```

#### æœ€ç»ˆç»“æœ
```json
{
  "type": "result",
  "session_id": "uuid-string",
  "text": "è¯†åˆ«å®Œæˆçš„æ–‡æœ¬",
  "is_final": true
}
```

---

# ç¬¬äº”éƒ¨åˆ†ï¼šDockeréƒ¨ç½²æŒ‡å—

## 5.1 å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Docker 20.10+
- Docker Compose 2.0+
- 4GB+ å†…å­˜
- 100MB ç£ç›˜ç©ºé—´

### ä¸€é”®å¯åŠ¨

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/tester/AI_Tools/mr-mcp-server

# ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
./docker-up.sh

# æˆ–ä½¿ç”¨ docker-compose å‘½ä»¤
docker-compose up -d
```

### è®¿é—®æœåŠ¡

- **Streamlit å®¢æˆ·ç«¯**: http://localhost:8501
- **WebSocket æœåŠ¡å™¨**: ws://localhost:8000/ws/audio
- **MQTT Broker**: mqtt://localhost:1883

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f audio-server
docker-compose logs -f streamlit-client
docker-compose logs -f mqtt
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢ä½†ä¿ç•™å®¹å™¨
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
./docker-down.sh

# æˆ–ä½¿ç”¨ docker-compose
docker-compose down
```

## 5.2 Dockeræ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Docker Compose                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  MQTT Broker   â”‚  â”‚ WebSocket      â”‚  â”‚  Streamlit     â”‚ â”‚
â”‚  â”‚                â”‚  â”‚ Server         â”‚  â”‚  Client        â”‚ â”‚
â”‚  â”‚ mosquitto:1883 â”‚  â”‚ :8000/ws/audio â”‚  â”‚  :8501         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                    â†“                    â†“           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ mosquitto_data â”‚  â”‚     logs       â”‚  â”‚     logs       â”‚ â”‚
â”‚  â”‚ mosquitto_logs â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                               â”‚
â”‚            Network: mr-mcp-network (bridge)                 â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5.3 Docker Compose é…ç½®è¯¦è§£

### docker-compose.yml æ–‡ä»¶ç»“æ„

```yaml
services:
  mqtt:              # MQTT æ¶ˆæ¯ä»£ç†
    image: eclipse-mosquitto:latest
    ports: ["1883:1883", "9001:9001"]
    
  audio-server:      # WebSocket éŸ³é¢‘æœåŠ¡å™¨
    build: Dockerfile.audio-server
    ports: ["8000:8000"]
    depends_on: [mqtt]
    
  streamlit-client:  # Streamlit å‰ç«¯å®¢æˆ·ç«¯
    build: Dockerfile.streamlit-client
    ports: ["8501:8501"]
    depends_on: [audio-server]

networks:
  mr-mcp-network:    # è‡ªå®šä¹‰ç½‘ç»œ
    driver: bridge

volumes:
  mosquitto_data:    # MQTT æ•°æ®å·
  mosquitto_logs:    # MQTT æ—¥å¿—å·
```

### ç¯å¢ƒå˜é‡

#### audio-server (WebSocket æœåŠ¡å™¨)

```bash
MQTT_HOST=mqtt                      # MQTT ä¸»æœºåï¼ˆå®¹å™¨ç½‘ç»œå†…ï¼‰
MQTT_PORT=1883                      # MQTT ç«¯å£
MQTT_USER=guest                     # MQTT ç”¨æˆ·å
MQTT_PASSWORD=guest                 # MQTT å¯†ç 
LOG_LEVEL=INFO                      # æ—¥å¿—çº§åˆ«
WEBSOCKET_PORT=8000                 # WebSocket ç«¯å£
WEBSOCKET_HOST=0.0.0.0              # WebSocket ç›‘å¬åœ°å€
```

#### streamlit-client (Streamlit å®¢æˆ·ç«¯)

```bash
WEBSOCKET_SERVER=ws://audio-server:8000/ws/audio  # WebSocket æœåŠ¡å™¨åœ°å€
DEBUG_MODE=false                    # è°ƒè¯•æ¨¡å¼
STREAMLIT_SERVER_PORT=8501          # Streamlit ç«¯å£
STREAMLIT_SERVER_ADDRESS=0.0.0.0    # Streamlit ç›‘å¬åœ°å€
```

## 5.4 ç®¡ç†è„šæœ¬

### ./docker.sh - å®Œæ•´ç®¡ç†å·¥å…·

```bash
# å¯åŠ¨æœåŠ¡
./docker.sh up

# åœæ­¢æœåŠ¡
./docker.sh down

# é‡å¯æœåŠ¡
./docker.sh restart

# æŸ¥çœ‹æ—¥å¿—
./docker.sh logs        # æ‰€æœ‰æœåŠ¡
./docker.sh logs-mqtt   # MQTT
./docker.sh logs-audio  # WebSocket æœåŠ¡å™¨
./docker.sh logs-client # Streamlit å®¢æˆ·ç«¯

# æŸ¥çœ‹çŠ¶æ€
./docker.sh status

# æ„å»ºé•œåƒ
./docker.sh build
./docker.sh rebuild     # ä¸ç¼“å­˜é‡æ–°æ„å»º

# æ¸…ç†
./docker.sh clean

# å¼€å¯ Shell
./docker.sh shell-mqtt
./docker.sh shell-audio
./docker.sh shell-client

# å¸®åŠ©
./docker.sh help
```

### ./docker-up.sh - å¿«é€Ÿå¯åŠ¨

ä¸€é”®å¯åŠ¨ï¼Œè‡ªåŠ¨æ„å»ºå’Œå¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚

### ./docker-down.sh - å¿«é€Ÿåœæ­¢

åœæ­¢æ‰€æœ‰æœåŠ¡ï¼Œå¯é€‰åˆ é™¤å·ã€‚

## 5.5 å¸¸è§æ“ä½œ

### æŸ¥çœ‹æ—¥å¿—å¹¶å®æ—¶è·Ÿè¸ª

```bash
# æ‰€æœ‰æœåŠ¡
docker-compose logs -f

# ç‰¹å®šæœåŠ¡
docker-compose logs -f audio-server
docker-compose logs -f streamlit-client

# æœ€å 100 è¡Œ
docker-compose logs --tail=100

# ç‰¹å®šæ—¶é—´èŒƒå›´
docker-compose logs --since 10m
```

### è¿›å…¥å®¹å™¨ Shell

```bash
# WebSocket æœåŠ¡å™¨
docker exec -it mr-mcp-server-audio-server-1 /bin/bash

# Streamlit å®¢æˆ·ç«¯
docker exec -it mr-mcp-server-streamlit-client-1 /bin/bash

# MQTT Broker
docker exec -it mr-mcp-server-mqtt-1 /bin/sh
```

### é‡å¯ç‰¹å®šæœåŠ¡

```bash
# é‡å¯éŸ³é¢‘æœåŠ¡å™¨
docker-compose restart audio-server

# é‡å¯ Streamlit
docker-compose restart streamlit-client
```

---

## æ€»ç»“ä¸å»ºè®®

### ç³»ç»Ÿç‰¹ç‚¹æ€»ç»“

âœ… **å®Œå…¨æœ¬åœ°åŒ–** - æ‰€æœ‰é€šä¿¡åŸºäºå±€åŸŸç½‘  
âœ… **æ¨¡å—åŒ–æ¶æ„** - å„æœåŠ¡ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•  
âœ… **äº‹ä»¶é©±åŠ¨è®¾è®¡** - MQTTäº‹ä»¶æ€»çº¿è§£è€¦æœåŠ¡  
âœ… **å¤šè½®å¯¹è¯æ”¯æŒ** - å®Œæ•´çš„ä¸Šä¸‹æ–‡ç®¡ç†  
âœ… **çµæ´»çš„å·¥å…·æ¡†æ¶** - æ˜“äºæ·»åŠ æ–°å·¥å…·  
âœ… **é«˜è´¨é‡éŸ³é¢‘** - Opusç¼–ç ä¿è¯ä¼ è¾“æ•ˆç‡  

### åç»­æ¨èæ­¥éª¤

1. **ç¡®è®¤è®¾è®¡** - æ ¹æ®æ­¤æ–‡æ¡£ç¡®è®¤ç³»ç»Ÿéœ€æ±‚æ˜¯å¦å®Œæ•´
2. **ç»†åŒ–æ¥å£** - åœ¨å®æ–½å‰ç»†åŒ–å„æ¨¡å—çš„APIå®šä¹‰
3. **åŸå‹å¼€å‘** - Phase 1-2å®ç°åŸºç¡€æ¡†æ¶ï¼ŒéªŒè¯å¯è¡Œæ€§
4. **è¿­ä»£ä¼˜åŒ–** - æ ¹æ®å®é™…è¿è¡Œæƒ…å†µä¼˜åŒ–å‚æ•°å’Œæ€§èƒ½
5. **æ–‡æ¡£å®Œå–„** - æŒç»­æ›´æ–°å¼€å‘å’Œéƒ¨ç½²æ–‡æ¡£

---

**æ–‡æ¡£å®Œæˆæ—¥æœŸ**: 2026å¹´1æœˆ17æ—¥  
**ç‰ˆæœ¬**: 1.0  
**ä¸‹ä¸€æ­¥**: å¼€å§‹Phase 1å®ç°

## WebSocketã€MQTT Broker å’Œ Streamlit çš„åŒºåˆ«ä¸è”ç³»

### WebSocket
WebSocket æ˜¯ä¸€ç§å…¨åŒå·¥é€šä¿¡åè®®ï¼ŒåŸºäº TCP è¿æ¥ï¼Œå…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å®æ—¶äº¤æ¢æ•°æ®ã€‚å®ƒçš„ç‰¹ç‚¹åŒ…æ‹¬ï¼š
- **å®æ—¶æ€§å¼º**ï¼šæ”¯æŒåŒå‘é€šä¿¡ï¼Œå»¶è¿Ÿä½ã€‚
- **è½»é‡çº§**ï¼šç›¸æ¯” HTTPï¼Œå‡å°‘äº†è¯·æ±‚å¤´çš„å¼€é”€ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šé€‚åˆéœ€è¦å®æ—¶æ›´æ–°çš„åº”ç”¨ï¼Œå¦‚èŠå¤©ã€æ¸¸æˆã€å®æ—¶æ•°æ®æ¨é€ç­‰ã€‚

### MQTT Broker
MQTTï¼ˆMessage Queuing Telemetry Transportï¼‰æ˜¯ä¸€ç§è½»é‡çº§çš„å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯åè®®ï¼Œé€šå¸¸ç”¨äºç‰©è”ç½‘ï¼ˆIoTï¼‰åœºæ™¯ã€‚å…¶ç‰¹ç‚¹åŒ…æ‹¬ï¼š
- **ä½å¸¦å®½å ç”¨**ï¼šè®¾è®¡ä¸ºåœ¨ä½å¸¦å®½ã€é«˜å»¶è¿Ÿçš„ç½‘ç»œç¯å¢ƒä¸‹è¿è¡Œã€‚
- **å‘å¸ƒ/è®¢é˜…æ¨¡å¼**ï¼šæ”¯æŒå¤šå®¢æˆ·ç«¯ä¹‹é—´çš„æ¶ˆæ¯åˆ†å‘ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šé€‚åˆä¼ æ„Ÿå™¨æ•°æ®ä¼ è¾“ã€è®¾å¤‡çŠ¶æ€æ›´æ–°ç­‰ã€‚

### Streamlit
Streamlit æ˜¯ä¸€ä¸ªç”¨äºå¿«é€Ÿæ„å»ºæ•°æ®åº”ç”¨çš„ Python æ¡†æ¶ï¼Œä¸»è¦ç”¨äºæ•°æ®å¯è§†åŒ–å’Œäº¤äº’ã€‚å…¶ç‰¹ç‚¹åŒ…æ‹¬ï¼š
- **ç®€å•æ˜“ç”¨**ï¼šä¸“æ³¨äºæ•°æ®å±•ç¤ºå’Œäº¤äº’ã€‚
- **å•å‘é€šä¿¡**ï¼šä¸»è¦ç”¨äºä»æœåŠ¡å™¨å‘ç”¨æˆ·å±•ç¤ºæ•°æ®ï¼Œäº¤äº’æ€§è¾ƒå¼±ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šé€‚åˆæ„å»ºæ•°æ®åˆ†æä»ªè¡¨ç›˜ã€æœºå™¨å­¦ä¹ æ¨¡å‹å±•ç¤ºç­‰ã€‚

### åŒºåˆ«ä¸è”ç³»
| ç‰¹æ€§              | WebSocket         | MQTT Broker      | Streamlit        |
|-------------------|-------------------|------------------|------------------|
| é€šä¿¡æ¨¡å¼          | åŒå‘              | å‘å¸ƒ/è®¢é˜…        | å•å‘ï¼ˆä¸»è¦å±•ç¤ºï¼‰ |
| å®æ—¶æ€§            | é«˜                | é«˜               | ä½               |
| å¸¦å®½å ç”¨          | ä¸­ç­‰              | ä½               | é«˜               |
| é€‚ç”¨åœºæ™¯          | å®æ—¶åº”ç”¨          | IoT æ•°æ®ä¼ è¾“     | æ•°æ®å±•ç¤º         |
| æ˜“ç”¨æ€§            | ä¸­ç­‰              | è¾ƒå¤æ‚           | ç®€å•             |

### ç”¨äºä¼ è¾“éŸ³é¢‘æµçš„é€‰æ‹©
åœ¨ä¼ è¾“éŸ³é¢‘æµçš„åœºæ™¯ä¸­ï¼ŒWebSocket æ›´åŠ é€‚åˆï¼ŒåŸå› å¦‚ä¸‹ï¼š
- **å®æ—¶æ€§è¦æ±‚**ï¼šéŸ³é¢‘æµä¼ è¾“éœ€è¦ä½å»¶è¿Ÿï¼ŒWebSocket çš„å…¨åŒå·¥é€šä¿¡å¯ä»¥æ»¡è¶³è¿™ä¸€éœ€æ±‚ã€‚
- **æ•°æ®ä¼ è¾“æ•ˆç‡**ï¼šç›¸æ¯” MQTTï¼ŒWebSocket æ›´é€‚åˆä¼ è¾“å¤§å—æ•°æ®ï¼ˆå¦‚éŸ³é¢‘å¸§ï¼‰ã€‚
- **äº¤äº’æ€§**ï¼šWebSocket æ”¯æŒåŒå‘é€šä¿¡ï¼Œä¾¿äºå®ç°éŸ³é¢‘æµçš„æ§åˆ¶ï¼ˆå¦‚æš‚åœã€ç»§ç»­ï¼‰ã€‚

MQTT è™½ç„¶å¸¦å®½å ç”¨ä½ï¼Œä½†æ›´é€‚åˆå°å‹æ•°æ®åŒ…çš„ä¼ è¾“ï¼Œä¸é€‚åˆéŸ³é¢‘æµè¿™ç§å¤§æ•°æ®é‡çš„åœºæ™¯ã€‚è€Œ Streamlit ä¸»è¦ç”¨äºæ•°æ®å±•ç¤ºï¼Œä¸é€‚åˆå®æ—¶éŸ³é¢‘æµçš„ä¼ è¾“ã€‚

---

## è¡¥å……ï¼šStreamlit çš„äº¤äº’èƒ½åŠ›

è™½ç„¶ Streamlit ä¸»è¦ç”¨äºæ•°æ®å±•ç¤ºï¼Œä½†é€šè¿‡å…¶äº¤äº’å¼ç»„ä»¶ï¼ˆå¦‚ `st.text_input` å’Œ `st.button`ï¼‰ï¼Œå¯ä»¥å®ç°ç”¨æˆ·è¾“å…¥ä¸æœåŠ¡å™¨å¤„ç†çš„åŒå‘äº¤äº’ã€‚ä¾‹å¦‚ï¼Œåœ¨ LLMï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰åº”ç”¨ä¸­ï¼ŒStreamlit å¯ä»¥è½»æ¾åˆ›å»ºä¸€ä¸ªèŠå¤©çª—å£ï¼š
- ç”¨æˆ·é€šè¿‡è¾“å…¥æ¡†å‘é€æ¶ˆæ¯ã€‚
- æœåŠ¡å™¨å¤„ç†ç”¨æˆ·è¾“å…¥å¹¶è¿”å›å“åº”ã€‚
- ç•Œé¢å®æ—¶æ›´æ–°ï¼Œæ˜¾ç¤ºèŠå¤©è®°å½•ã€‚

è¿™ç§äº¤äº’æ¨¡å¼è™½ç„¶ä¸å¦‚ WebSocket çš„å®æ—¶æ€§å¼ºï¼Œä½†å¯¹äºæ„å»ºç®€å•çš„èŠå¤©åº”ç”¨æˆ– LLM å‰ç«¯æ˜¯å®Œå…¨å¯è¡Œçš„ã€‚

### HTTP Server å’Œ Web Server æ˜¯å¦é€‚åˆè¯­éŸ³æˆ–è§†é¢‘ä¼ è¾“

#### HTTP Server
HTTP æ˜¯ä¸€ç§è¯·æ±‚-å“åº”å¼åè®®ï¼Œé€šå¸¸ç”¨äºä¼ è¾“é™æ€æˆ–åŠ¨æ€å†…å®¹ã€‚å…¶ç‰¹ç‚¹åŒ…æ‹¬ï¼š
- **å•å‘é€šä¿¡**ï¼šå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›å“åº”ã€‚
- **é«˜å»¶è¿Ÿ**ï¼šæ¯æ¬¡ä¼ è¾“éƒ½éœ€è¦å»ºç«‹è¯·æ±‚ï¼Œé€‚åˆéå®æ—¶æ•°æ®ä¼ è¾“ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šæ–‡ä»¶ä¸‹è½½ã€ç½‘é¡µå†…å®¹åŠ è½½ç­‰ã€‚

å¯¹äºè¯­éŸ³æˆ–è§†é¢‘æµä¼ è¾“ï¼ŒHTTP å¹¶ä¸é€‚åˆï¼Œå› ä¸ºå…¶é«˜å»¶è¿Ÿå’Œå•å‘é€šä¿¡æ¨¡å¼æ— æ³•æ»¡è¶³å®æ—¶æ€§è¦æ±‚ã€‚

#### Web Server
Web Server æ˜¯åŸºäº HTTP åè®®çš„æœåŠ¡å™¨ï¼Œä¸»è¦ç”¨äºå¤„ç†ç½‘é¡µè¯·æ±‚ã€‚å…¶ç‰¹ç‚¹ä¸ HTTP Server ç±»ä¼¼ï¼š
- **éå®æ—¶æ€§**ï¼šé€‚åˆé™æ€èµ„æºæˆ–çŸ­æ—¶é—´çš„åŠ¨æ€å†…å®¹ä¼ è¾“ã€‚
- **æ‰©å±•æ€§**ï¼šé€šè¿‡ WebSocket ç­‰åè®®æ‰©å±•ï¼Œå¯ä»¥æ”¯æŒå®æ—¶é€šä¿¡ã€‚

#### è¯­éŸ³æˆ–è§†é¢‘ä¼ è¾“çš„é€‚ç”¨æ€§
- **ä¸é€‚åˆ**ï¼šHTTP Server å’Œä¼ ç»Ÿ Web Server ä¸é€‚åˆç›´æ¥ç”¨äºè¯­éŸ³æˆ–è§†é¢‘æµä¼ è¾“ã€‚
- **æ‰©å±•æ–¹æ¡ˆ**ï¼šé€šè¿‡é›†æˆ WebSocket æˆ–å…¶ä»–å®æ—¶åè®®ï¼Œå¯ä»¥å®ç°è¯­éŸ³æˆ–è§†é¢‘æµçš„ä¼ è¾“ã€‚

### æ€»ç»“
å¯¹äºè¯­éŸ³æˆ–è§†é¢‘æµä¼ è¾“ï¼Œå»ºè®®ä½¿ç”¨ WebSocket æˆ–ä¸“ç”¨çš„æµåª’ä½“åè®®ï¼ˆå¦‚ RTSPã€RTPï¼‰ã€‚HTTP Server å’Œ Web Server æ›´é€‚åˆéå®æ—¶æ•°æ®çš„ä¼ è¾“åœºæ™¯ã€‚
# app.py ä¸ Xiaozhi-Server æ¶æ„æ·±åº¦åˆ†æ

## æ ¸å¿ƒæ‰§è¡Œæµç¨‹

app.pyçš„main()å‡½æ•°æŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š
1. check_ffmpeg_installed() - FFmpegæ£€æŸ¥
2. load_config() - åŠ è½½é…ç½®ï¼ˆé»˜è®¤+è‡ªå®šä¹‰ï¼‰
3. auth_keyç”Ÿæˆ - ä¼˜å…ˆçº§ï¼šæ–‡ä»¶>API>UUID
4. monitor_stdin() - å¼‚æ­¥ç›‘æ§æ ‡å‡†è¾“å…¥
5. gc_manager.start() - å¯åŠ¨åƒåœ¾å›æ”¶ï¼ˆ5åˆ†é’Ÿ/æ¬¡ï¼‰
6. WebSocketServer.start() - ç›‘å¬ws://0.0.0.0:8000/xiaozhi/v1/
7. SimpleHttpServer.start() - ç›‘å¬http://0.0.0.0:8003/
8. wait_for_exit() - ç­‰å¾…Ctrl-Cæˆ–SIGTERMä¿¡å·
9. cleanup() - ä¼˜é›…å…³é—­æ‰€æœ‰ä»»åŠ¡

## ConnectionHandler ï¼ˆæ ¸å¿ƒå¤„ç†å™¨ï¼Œ1285è¡Œä»£ç ï¼‰

å¤„ç†å•ä¸ªWebSocketè¿æ¥çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼š
- åˆå§‹åŒ–ï¼šsession_idã€device_idã€AIæ¨¡å—ã€æ¶ˆæ¯é˜Ÿåˆ—
- æ¶ˆæ¯å¤„ç†ï¼šåˆ†å‘éŸ³é¢‘å’Œæ–‡æœ¬æ¶ˆæ¯
  - éŸ³é¢‘æµï¼šreceiveAudioHandle â†’ VAD â†’ ASR â†’ LLM â†’ TTS â†’ sendAudioHandle
  - æ–‡æœ¬æµï¼šhandleTextMessage â†’ TextProcessor â†’ å¤„ç†å™¨ â†’ å“åº”
- ä¼˜é›…å…³é—­ï¼šåœæ­¢å­ä»»åŠ¡ã€é‡Šæ”¾èµ„æº

## å®Œæ•´æ•°æ®æµ

### éŸ³é¢‘å¤„ç†é“¾è·¯è¯¦ç»†æµç¨‹å›¾

**ç¬¬ä¸€é˜¶æ®µï¼šè¾“å…¥â†’æ¥æ”¶â†’è§£ç **
```mermaid
graph LR
    A1["ğŸ“¥ å®¢æˆ·ç«¯<br/>OpuséŸ³é¢‘"]
    B1["ğŸŒ WebSocketæ¥æ”¶<br/>websocket_server.py"]
    B2["receiveAudioHandle<br/>connection.py"]
    C1["ğŸ”§ PCMè§£ç <br/>core/utils/audio.py"]
    
    A1 --> B1 --> B2 --> C1
    
    style A1 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px,color:#000000
    style B1 fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:#000000
    style B2 fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:#000000
    style C1 fill:#ffe0b2,stroke:#e65100,stroke-width:2px,color:#000000
```

**ç¬¬äºŒé˜¶æ®µï¼šVADâ†’ASRâ†’LLM**
```mermaid
graph LR
    D1["ğŸ” VADæ£€æµ‹<br/>core/providers/vad/"]
    D2["è¯­éŸ³æ®µæ£€æµ‹<br/>å†…å­˜ç¼“å†²é˜Ÿåˆ—"]
    E1["ğŸ—£ï¸ ASRè¯†åˆ«<br/>FunASR+SenseVoice"]
    E2["å®æ—¶è½¬å†™<br/>core/providers/asr/"]
    F1["ğŸ§  LLMå¤„ç†<br/>core/providers/llm/"]
    F2["ç†è§£+å¤šè½®å¯¹è¯<br/>context_manager.py"]
    
    D1 --> D2 --> E1 --> E2 --> F1 --> F2
    
    style D1 fill:#f8bbd0,stroke:#c2185b,stroke-width:2px,color:#000000
    style D2 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px,color:#000000
    style E1 fill:#f8bbd0,stroke:#c2185b,stroke-width:2px,color:#000000
    style E2 fill:#f8bbd0,stroke:#c2185b,stroke-width:2px,color:#000000
    style F1 fill:#d1c4e9,stroke:#512da8,stroke-width:2px,color:#000000
    style F2 fill:#d1c4e9,stroke:#512da8,stroke-width:2px,color:#000000
```

**ç¬¬ä¸‰é˜¶æ®µï¼šTTSâ†’ç¼–ç â†’å‘é€**
```mermaid
graph LR
    G1["ğŸµ TTSåˆæˆ<br/>CosyVoice"]
    G2["æ–‡æœ¬â†’è¯­éŸ³<br/>core/providers/tts/"]
    H1["ğŸ” Opusç¼–ç <br/>OpusEncoder"]
    I1["ğŸ“¤ sendAudioHandle<br/>connection.py"]
    I2["WebSocketè¿”å›<br/>websocket_server.py"]
    J1["ğŸ”Š å®¢æˆ·ç«¯æ’­æ”¾<br/>éŸ³é¢‘è¾“å‡º"]
    
    G1 --> G2 --> H1 --> I1 --> I2 --> J1
    
    style G1 fill:#d1c4e9,stroke:#512da8,stroke-width:2px,color:#000000
    style G2 fill:#d1c4e9,stroke:#512da8,stroke-width:2px,color:#000000
    style H1 fill:#ffe0b2,stroke:#e65100,stroke-width:2px,color:#000000
    style I1 fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:#000000
    style I2 fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:#000000
    style J1 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px,color:#000000
```

### éŸ³é¢‘å¤„ç†æ•°æ®ä¼ è¾“æ–¹å¼è¯¦è§£

#### VAD æ£€æµ‹åçš„éŸ³é¢‘å¦‚ä½•ä¼ è¾“ç»™ ASR è¯†åˆ«

ç³»ç»Ÿé‡‡ç”¨**å†…å­˜ä¸­çš„éŸ³é¢‘ç¼“å†²é˜Ÿåˆ—**æ–¹å¼è¿›è¡Œä¼ è¾“ï¼Œä¸ä¾èµ– MQTT æˆ–ç½‘ç»œï¼š

**ä¼ è¾“æµç¨‹**ï¼š
```
receiveAudioMessage(WebSocketæ¥æ”¶)
    â†“
handleAudioMessage (core/handle/receiveAudioHandle.py)
    â†“
conn.vad.is_vad(conn, opus_packet)  â† VADæ£€æµ‹æ˜¯å¦æœ‰è¯­éŸ³
    â”œâ”€ Opusè§£ç  â†’ PCM
    â”œâ”€ è¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼ˆSileroVADï¼‰
    â””â”€ è¿”å› have_voice æ ‡å¿—
    â†“
conn.asr.receive_audio(conn, audio, have_voice)  â† ASRæ¥æ”¶éŸ³é¢‘
    â”œâ”€ conn.asr_audio.append(audio)  â† éŸ³é¢‘ç‰‡æ®µåŠ å…¥ç¼“å†²é˜Ÿåˆ—ï¼ˆListï¼‰
    â””â”€ æ£€æµ‹è¯­éŸ³åœæ­¢ä¿¡å·ï¼ˆclient_voice_stopï¼‰
        â†“
conn.asr.handle_voice_stop(conn, asr_audio_task)  â† è§¦å‘ASRè¯†åˆ«
    â”œâ”€ asr_audio_task = conn.asr_audio.copy()  â† å¤åˆ¶æ•´ä¸ªç¼“å†²åŒº
    â”œâ”€ decode_opus(asr_audio_task)  â† è§£ç æ‰€æœ‰Opusç‰‡æ®µ
    â””â”€ speech_to_text(pcm_data)  â† æ‰§è¡ŒASRè¯†åˆ«
```

**å…³é”®ç‰¹æ€§**ï¼š
- **ç¼“å†²æœºåˆ¶**ï¼šæ¯ä¸ª WebSocket è¿æ¥å¯¹åº”ä¸€ä¸ª `ConnectionHandler` å¯¹è±¡ï¼Œå†…éƒ¨ç»´æŠ¤ `conn.asr_audio` åˆ—è¡¨
- **å†…å­˜ä¼ è¾“**ï¼šä½¿ç”¨å…±äº«å†…å­˜è€Œéç½‘ç»œä¼ è¾“ï¼Œé›¶æ‹·è´è®¾è®¡
- **åŒæ­¥ä¿è¯**ï¼šVAD æ£€æµ‹å’Œ ASR è¯†åˆ«åœ¨åŒä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œç¡®ä¿æ—¶åºæ­£ç¡®
- **ä¸¤ç§æ¨¡å¼**ï¼š
  - **è‡ªåŠ¨æ¨¡å¼**ï¼šVAD è‡ªåŠ¨æ£€æµ‹è¯­éŸ³æ´»åŠ¨ï¼Œæ£€æµ‹åˆ°åœæ­¢æ—¶è§¦å‘ ASR
  - **æ‰‹åŠ¨æ¨¡å¼**ï¼šå®¢æˆ·ç«¯ä¸»åŠ¨è§¦å‘ï¼Œç›´æ¥ç¼“å­˜éŸ³é¢‘ä¾› ASR ä½¿ç”¨

**ç›¸å…³ä»£ç ä½ç½®**ï¼š
- VAD æ£€æµ‹ï¼š[core/providers/vad/silero.py](core/providers/vad/silero.py#L53)
- éŸ³é¢‘ç¼“å†²ï¼š[core/handle/receiveAudioHandle.py](core/handle/receiveAudioHandle.py#L12)
- ASR ç¼“å†²æ¥æ”¶ï¼š[core/providers/asr/base.py](core/providers/asr/base.py#L54)
- ç¼“å†²åŒºçŠ¶æ€ç®¡ç†ï¼š[ConnectionHandler.asr_audio](core/connection.py#L120)

#### å†…éƒ¨é€šä¿¡æ¶æ„æ€»ç»“

| é€šä¿¡æ–¹å¼ | ç”¨é€” | å®ç°æ–¹å¼ | ä¼˜ç‚¹ |
|---------|------|--------|------|
| **å†…å­˜ç¼“å†²é˜Ÿåˆ—** | VAD â†’ ASR | `conn.asr_audio` List | é›¶æ‹·è´ã€ä½å»¶è¿Ÿ |
| **MQTT äº‹ä»¶æ€»çº¿** | æœåŠ¡é—´è§£è€¦ | Pub/Sub æ¨¡å¼ | æ¾è€¦åˆã€å¯æ‰©å±• |
| **WebSocket** | å®¢æˆ·ç«¯â†”æœåŠ¡å™¨ | åŒå‘å®æ—¶é€šä¿¡ | ä½å»¶è¿Ÿã€å®æ—¶æ€§å¼º |
| **å…±äº«å¯¹è±¡** | è¿æ¥çº§æ•°æ®å…±äº« | ConnectionHandler å®ä¾‹ | ä¸Šä¸‹æ–‡ä¿ç•™ã€çº¿ç¨‹å®‰å…¨ |

### æ–‡æœ¬å¤„ç†é“¾è·¯è¯¦ç»†æµç¨‹å›¾

**ç¬¬ä¸€é˜¶æ®µï¼šè¾“å…¥â†’æ¥æ”¶â†’å¤„ç†â†’åˆ†å‘**
```mermaid
graph LR
    A1["ğŸ“¥ å®¢æˆ·ç«¯<br/>æ–‡æœ¬æ¶ˆæ¯"]
    B1["ğŸŒ WebSocket<br/>æ¥æ”¶æ¶ˆæ¯<br/>websocket_server.py"]
    B2["handleTextMessage<br/>connection.py"]
    C1["âš™ï¸ æ¶ˆæ¯å¤„ç†<br/>TextMessageProcessor"]
    C2["ç±»å‹åˆ¤æ–­<br/>text/command/tool_call"]
    D1["ğŸ”€ å¤„ç†å™¨æŸ¥è¯¢<br/>handler_registry.py"]
    
    A1 --> B1 --> B2 --> C1 --> C2 --> D1
    
    style A1 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px,color:#000000
    style B1 fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:#000000
    style B2 fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:#000000
    style C1 fill:#fff9c4,stroke:#f57f17,stroke-width:2px,color:#000000
    style C2 fill:#fff9c4,stroke:#f57f17,stroke-width:2px,color:#000000
    style D1 fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000000
```

**ç¬¬äºŒé˜¶æ®µï¼šé€‰æ‹©å¤„ç†å™¨â†’æ‰§è¡Œå¤„ç†**
```mermaid
graph LR
    D2{"é€‰æ‹©å¤„ç†å™¨<br/>ç±»å‹"}
    D3["å†…ç½®Handler<br/>built_in_handlers.py"]
    D4["è‡ªå®šä¹‰Plugin<br/>plugins_func/*.py"]
    E1["ğŸ’¡ LLM Provider<br/>core/providers/llm/"]
    E2["ğŸ”§ MCPå·¥å…·<br/>core/providers/mcp/"]
    E3["ğŸ’¾ å¯¹è¯è®°å¿†<br/>core/providers/memory/"]
    
    D2 -->|å†…ç½®| D3 --> E1
    D2 -->|è‡ªå®šä¹‰| D4 --> E2
    E1 --> E3
    E2 --> E3
    
    style D2 fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000000
    style D3 fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000000
    style D4 fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000000
    style E1 fill:#d1c4e9,stroke:#512da8,stroke-width:2px,color:#000000
    style E2 fill:#d1c4e9,stroke:#512da8,stroke-width:2px,color:#000000
    style E3 fill:#d1c4e9,stroke:#512da8,stroke-width:2px,color:#000000
```

**ç¬¬ä¸‰é˜¶æ®µï¼šæ•´åˆâ†’ç”Ÿæˆâ†’è¿”å›**
```mermaid
graph LR
    F1["âœï¸ æ•´åˆç»“æœ<br/>handlers.py"]
    F2["ç”Ÿæˆå“åº”<br/>æ–‡æœ¬"]
    G1["ğŸ“¤ æ„å»ºJSON<br/>connection.py"]
    G2["WebSocketå‘é€<br/>websocket_server.py"]
    H1["ğŸ’¬ å®¢æˆ·ç«¯<br/>æ˜¾ç¤ºç»“æœ"]
    
    F1 --> F2 --> G1 --> G2 --> H1
    
    style F1 fill:#f8bbd0,stroke:#c2185b,stroke-width:2px,color:#000000
    style F2 fill:#f8bbd0,stroke:#c2185b,stroke-width:2px,color:#000000
    style G1 fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:#000000
    style G2 fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:#000000
    style H1 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px,color:#000000
```

### éŸ³é¢‘å¤„ç†é“¾è·¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
```
å®¢æˆ·ç«¯OpuséŸ³é¢‘ 
    â†’ WebSocketæ¥æ”¶ (websocket_server.py)
    â†’ receiveAudioHandle (connection.py)
    â†’ PCMè§£ç  (core/utils/audio.py)
    â†’ VADæ£€æµ‹ (core/providers/vad/)
    â†’ ASRè¯†åˆ« (core/providers/asr/)
    â†’ æ–‡æœ¬è¾“å‡º â†’ LLMå¤„ç† (core/providers/llm/)
    â†’ TTSåˆæˆ (core/providers/tts/)
    â†’ Opusç¼–ç  (core/utils/audio.py)
    â†’ sendAudioHandle (connection.py)
    â†’ WebSocketå‘é€ (websocket_server.py)
    â†’ å®¢æˆ·ç«¯æ’­æ”¾
```

### æ–‡æœ¬å¤„ç†é“¾è·¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
```
å®¢æˆ·ç«¯æ–‡æœ¬ 
    â†’ handleTextMessage (connection.py)
    â†’ TextMessageProcessor (core/handlers/)
    â†’ å¤„ç†å™¨æŸ¥è¯¢ (handler_registry.py)
    â†’ å†…ç½®Handler (built_in_handlers.py) æˆ–è‡ªå®šä¹‰Plugin (plugins_func/)
    â†’ å¯èƒ½è°ƒç”¨ LLM/MCP/Memory (core/providers/)
    â†’ ç”Ÿæˆå“åº” (handlers.py)
    â†’ å‘é€å®¢æˆ·ç«¯ (websocket_server.py)
```

## è®¤è¯ä¸å®‰å…¨æœºåˆ¶

ä½¿ç”¨HMAC-SHA256æ— çŠ¶æ€è®¤è¯ï¼š
- Tokenæ ¼å¼: signature.timestamp  
- éªŒè¯æµç¨‹: è§£ætoken â†’ æ£€æŸ¥è¿‡æœŸ â†’ é‡ç®—ç­¾å â†’ å¯¹æ¯”
- æ”¯æŒè®¾å¤‡ç™½åå•ç®¡ç†
- æ”¯æŒè‡ªå®šä¹‰è¿‡æœŸæ—¶é—´

## æ¨¡å—åˆå§‹åŒ–ç³»ç»Ÿ

initialize_modules()å‡½æ•°æ”¯æŒæŒ‰éœ€åŠ è½½AIæ¨¡å—ï¼š
```
selected_moduleé…ç½®:
  VAD: "silero-vad"    # è¯­éŸ³æ´»åŠ¨æ£€æµ‹
  ASR: "sense-voice"   # è¯­éŸ³è¯†åˆ«
  LLM: "openai"        # å¤§è¯­è¨€æ¨¡å‹
  TTS: "edge-tts"      # æ–‡æœ¬è½¬è¯­éŸ³
  Memory: "simple"     # å¯¹è¯è®°å¿†
  Intent: "regex"      # æ„å›¾è¯†åˆ«
```

å¥½å¤„ï¼šèŠ‚çœå†…å­˜ï¼ˆä¸åˆå§‹åŒ–ä¸ç”¨çš„æ¨¡å—ï¼‰ã€å¿«é€Ÿå¯åŠ¨ã€çµæ´»ç»„åˆ

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**åƒåœ¾å›æ”¶ç®¡ç†**ï¼šGlobalGCManagerå®šæ—¶æ‰§è¡Œgc.collect()ï¼Œé¿å…Python GILé¢‘ç¹äº‰ç”¨
**éŸ³é¢‘æµæ§**ï¼šAudioRateControlleræ§åˆ¶éŸ³é¢‘å‘é€é€Ÿç‡ï¼Œä¿è¯å¹³æ»‘æ’­æ”¾
**é…ç½®ç¼“å­˜**ï¼šå¤šå±‚ç¼“å­˜ç³»ç»Ÿå‡å°‘é‡å¤åŠ è½½å’Œè®¡ç®—
**å¼‚æ­¥æ¶æ„**ï¼šasyncioå…¨å¼‚æ­¥æ”¯æŒé«˜å¹¶å‘å¤šå®¢æˆ·ç«¯æ¥å…¥

## ç³»ç»Ÿæ¶æ„å…¨æ™¯å›¾

```mermaid
graph TB
    subgraph Main["ğŸ”´ app.py (asyncio Event Loop)<br/>ä¸»ç¨‹åºå…¥å£å’Œä»»åŠ¡è°ƒåº¦"]
        WS["ğŸ”Œ WebSocketæœåŠ¡(8000)<br/>ç›‘å¬å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚"]
        HTTP["ğŸŒ HTTPæœåŠ¡(8003)<br/>OTAå‡çº§ã€è§†è§‰åˆ†æã€ä¸‹è½½æœåŠ¡"]
        GC["ğŸ—‘ï¸ åƒåœ¾å›æ”¶ç®¡ç†<br/>å®šæ—¶æ‰§è¡ŒGCï¼ˆ5åˆ†é’Ÿ/æ¬¡ï¼‰"]
        CH["ğŸ“Š ConnectionHandler Ã— N<br/>å¤„ç†æ¯ä¸ªWebSocketè¿æ¥"]
        AI["ğŸ§  AIæœåŠ¡æ¨¡å—<br/>VAD/ASR/LLM/Intent/Memory/TTS"]
    end
    
    subgraph AudioFlow["ğŸ™ï¸ éŸ³é¢‘å¤„ç†é“¾"]
        A1["VAD<br/>è¯­éŸ³æ£€æµ‹"]
        A2["ASR<br/>è¯­éŸ³è¯†åˆ«"]
        A3["LLM<br/>æ–‡æœ¬å¤„ç†"]
        A4["TTS<br/>è¯­éŸ³åˆæˆ"]
    end
    
    subgraph TextFlow["ğŸ“ æ–‡æœ¬å¤„ç†é“¾"]
        T1["TextProcessor<br/>åˆ†å‘å¤„ç†"]
        T2["Handler/Plugin<br/>å…·ä½“å¤„ç†"]
    end
    
    WS --> CH
    HTTP --> CH
    GC -.-> Main
    CH --> AudioFlow
    CH --> TextFlow
    AudioFlow --> AI
    TextFlow --> AI
    
    A1 --> A2 --> A3 --> A4
    T1 --> T2
    
    style Main fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    style AudioFlow fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style TextFlow fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    style AI fill:#fff3e0,stroke:#f57c00,stroke-width:2px
```

## å…³é”®æŠ€æœ¯ç‚¹

| æŠ€æœ¯ | å®ç° | ä¼˜åŠ¿ |
|------|------|------|
| å¹¶å‘æ¨¡å‹ | asyncioå¼‚æ­¥ | å•çº¿ç¨‹å¤„ç†å¤šè¿æ¥ï¼Œå†…å­˜é«˜æ•ˆ |
| é€šä¿¡åè®® | WebSocketåŒå‘ | å®æ—¶ä¼ è¾“ï¼Œæ”¯æŒå¤§æ•°æ®æµ |
| è®¤è¯æ–¹æ¡ˆ | HMAC-SHA256 | æ— çŠ¶æ€ï¼Œå®‰å…¨ï¼Œå¯åˆ†å¸ƒå¼ |
| æ¨¡å—æ¶æ„ | ä¾èµ–æ³¨å…¥ | è§£è€¦ï¼Œçµæ´»ï¼Œæ˜“äºæµ‹è¯• |
| å†…å­˜ç®¡ç† | å®šæ—¶GC | é•¿æœŸç¨³å®šè¿è¡Œ |
| éŸ³é¢‘å¤„ç† | æµé‡æ§åˆ¶ | å¹³æ»‘æ’­æ”¾ï¼Œæ— å¡é¡¿ |

## æ€»ç»“

Xiaozhi Serveræ˜¯ä¸“ä¸šçš„AIå¯¹è¯æœåŠ¡ç³»ç»Ÿï¼Œé‡‡ç”¨é«˜åº¦æ¨¡å—åŒ–è®¾è®¡ï¼Œé›†æˆäº†è¯­éŸ³è¯†åˆ«ã€å¤§è¯­è¨€æ¨¡å‹ã€æ–‡æœ¬è½¬è¯­éŸ³ç­‰èƒ½åŠ›ï¼Œæ”¯æŒå®æ—¶éŸ³é¢‘å’Œæ–‡æœ¬äº¤äº’ï¼Œé€‚ç”¨äºæ™ºèƒ½å®¶å±…ã€è¯­éŸ³åŠ©æ‰‹ç­‰åœºæ™¯ï¼

---

# WebSocket æœåŠ¡è¯¦è§£

## 1. WebSocket æœåŠ¡æ¦‚è¿°

WebSocket æœåŠ¡ï¼ˆcore/websocket_server.pyï¼‰æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒé€šä¿¡æ¢çº½ï¼ŒåŸºäº Python çš„ `websockets` åº“å®ç°ã€‚å®ƒè´Ÿè´£ï¼š

- ğŸ”Œ **è¿æ¥ç®¡ç†** - æ¥å—æ¥è‡ª ESP32ã€Web å®¢æˆ·ç«¯çš„è¿æ¥
- ğŸ” **è®¤è¯æˆæƒ** - åŸºäº JWT çš„è®¾å¤‡è®¤è¯å’Œç™½åå•ç®¡ç†  
- ğŸ”„ **æ¶ˆæ¯è·¯ç”±** - å°† WebSocket æ¶ˆæ¯åˆ†å‘åˆ°å„ä¸ªå¤„ç†æ¨¡å—
- ğŸ“Š **æµé‡æ§åˆ¶** - ç®¡ç†å¤šè¿æ¥å¹¶å‘ã€ç¼“å†²åŒºé˜²æº¢å‡º
- ğŸ”§ **åŠ¨æ€é…ç½®** - æ”¯æŒè¿è¡Œæ—¶æ›´æ–° LLMã€ASR ç­‰æ¨¡å—é…ç½®

## 2. æ ¸å¿ƒæœåŠ¡ç›‘å¬åœ°å€

```
WebSocket: ws://0.0.0.0:8000/xiaozhi/v1/
HTTP (OTA/Vision): http://0.0.0.0:8003/
```

## 3. å·¥ä½œæµç¨‹

### 3.1 è¿æ¥å»ºç«‹æµç¨‹

```
å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚
    â†“
æå– device-idï¼ˆä» HTTP å¤´æˆ– URL å‚æ•°ï¼‰
    â†“
è®¤è¯æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
    â”œâ”€ ç™½åå•è®¾å¤‡ â†’ ç›´æ¥æ”¾è¡Œ
    â”œâ”€ JWT Token æœ‰æ•ˆ â†’ æ”¾è¡Œ
    â””â”€ è®¤è¯å¤±è´¥ â†’ æ‹’ç»è¿æ¥
    â†“
åˆ›å»º ConnectionHandler å®ä¾‹
    â”œâ”€ session_idï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
    â”œâ”€ åˆå§‹åŒ–éŸ³é¢‘ç¼“å†²åŒº
    â”œâ”€ åˆå§‹åŒ–å¼‚æ­¥ä»»åŠ¡
    â””â”€ åŠ è½½ AI æ¨¡å—å¼•ç”¨
    â†“
è¿›å…¥æ¶ˆæ¯æ¥æ”¶å¾ªç¯
```

### 3.2 éŸ³é¢‘å¤„ç†é“¾è·¯

```
WebSocket æ¥æ”¶ Opus éŸ³é¢‘
    â†“
PCM è§£ç ï¼ˆcore/utils/audio.pyï¼‰
    â†“
VAD æ£€æµ‹ï¼ˆSileroVADï¼‰
    â”œâ”€ æ£€æµ‹åˆ°è¯­éŸ³ â†’ åŠ å…¥ç¼“å†²åŒº
    â””â”€ æ— è¯­éŸ³ â†’ è·³è¿‡
    â†“
ASR è¯†åˆ«ï¼ˆFunASRï¼‰
    â”œâ”€ å®æ—¶è½¬å†™ï¼ˆå¯é€‰ï¼‰
    â””â”€ è¯†åˆ«å®Œæˆ â†’ è¾“å‡ºæ–‡æœ¬
    â†“
LLM å¤„ç†ï¼ˆç†è§£æ„å›¾ï¼‰
    â†“
TTS åˆæˆï¼ˆCosyVoiceï¼‰
    â†“
Opus ç¼–ç 
    â†“
WebSocket è¿”å›å®¢æˆ·ç«¯
```

### 3.3 æ–‡æœ¬å¤„ç†é“¾è·¯

```
WebSocket æ¥æ”¶æ–‡æœ¬æ¶ˆæ¯
    â†“
è§£ææ¶ˆæ¯ç±»å‹
    â”œâ”€ å‘½ä»¤ â†’ æ‰§è¡Œå‘½ä»¤
    â”œâ”€ é—®é¢˜ â†’ è°ƒç”¨ LLM
    â””â”€ å·¥å…·è°ƒç”¨ â†’ MCP æ‰§è¡Œ
    â†“
LLM ç”Ÿæˆå“åº”
    â†“
æ£€æŸ¥æ˜¯å¦éœ€è¦å·¥å…·è°ƒç”¨
    â”œâ”€ æ˜¯ â†’ æ‰§è¡Œ MCP å·¥å…·
    â””â”€ å¦ â†’ ç”Ÿæˆæ–‡æœ¬
    â†“
TTS åˆæˆï¼ˆå¯é€‰ï¼‰
    â†“
è¿”å›ç»™å®¢æˆ·ç«¯
```

## 4. è®¤è¯æœºåˆ¶

WebSocket æ”¯æŒä¸¤ç§è®¤è¯æ–¹å¼ï¼š

### 4.1 HTTP è¯·æ±‚å¤´è®¤è¯

```
GET /xiaozhi/v1/ HTTP/1.1
Host: 192.168.1.13:8000
device-id: esp32_001
authorization: Bearer eyJhbGc...
```

### 4.2 URL æŸ¥è¯¢å‚æ•°è®¤è¯

```
ws://192.168.1.13:8000/xiaozhi/v1/?device-id=esp32_001&authorization=Bearer+eyJhbGc...
```

### 4.3 ç™½åå•æ¨¡å¼

åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼š

```yaml
server:
  auth:
    enabled: true
    allowed_devices:
      - "11:22:33:44:55:66"    # MAC åœ°å€æˆ–è®¾å¤‡ ID
      - "esp32_device_001"
```

ç™½åå•è®¾å¤‡æ— éœ€ Tokenï¼Œç›´æ¥è¿æ¥ã€‚

## 5. é€šä¿¡åè®®è§„èŒƒ

### 5.1 éŸ³é¢‘æ¶ˆæ¯æ ¼å¼

**å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨**:

```json
{
    "type": "audio",
    "frame_type": "start",
    "session_id": "uuid-string",
    "timestamp": 1705420225.123
}
```

```json
{
    "type": "audio",
    "frame_type": "audio",
    "session_id": "uuid-string",
    "codec": "opus",
    "sample_rate": 16000,
    "channels": 1,
    "data": "base64_encoded_opus_bytes"
}
```

```json
{
    "type": "audio",
    "frame_type": "end",
    "session_id": "uuid-string"
}
```

**æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯**:

```json
{
    "type": "transcript",
    "session_id": "uuid-string",
    "text": "ä½ å¥½",
    "is_final": false,
    "confidence": 0.95
}
```

### 5.2 æ–‡æœ¬æ¶ˆæ¯æ ¼å¼

**å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨**:

```json
{
    "type": "text",
    "text": "å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
}
```

**æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯**:

```json
{
    "type": "text",
    "text": "ä»Šå¤©åŒ—äº¬æ™´å¤©ï¼Œæ¸©åº¦ 5Â°C"
}
```

```json
{
    "type": "audio",
    "data": "base64_encoded_opus_bytes"
}
```

## 6. å…³é”®é…ç½®é¡¹

```yaml
# config.yaml
server:
  ip: 0.0.0.0                    # ç›‘å¬ IP
  port: 8000                     # WebSocket ç«¯å£
  http_port: 8003                # HTTP ç«¯å£
  
  websocket: ws://ä½ çš„ip:8000/xiaozhi/v1/  # è¿”å›ç»™è®¾å¤‡çš„ WS åœ°å€
  
  auth:
    enabled: false               # æ˜¯å¦å¯ç”¨è®¤è¯
    allowed_devices:             # ç™½åå•è®¾å¤‡
      - "device_id_1"
    expire_seconds: 3600         # Token è¿‡æœŸæ—¶é—´
  
  auth_key: "your-secret-key"   # JWT å¯†é’¥
```

## 7. æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ |
|-----|-----|
| å¹¶å‘è¿æ¥æ•° | 1000+ |
| å•è¿æ¥å†…å­˜å ç”¨ | ~5-10MB |
| æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ | <100ms |
| ååé‡ | 100+ åŒæ—¶å¯¹è¯ |
| å¿ƒè·³é—´éš” | 30 ç§’ |
| è¿æ¥è¶…æ—¶ | 300 ç§’ |

## 8. æ•…éšœæ’æŸ¥

### 8.1 è¿æ¥é—®é¢˜

**ç—‡çŠ¶**: WebSocket è¿æ¥ç«‹å³æ–­å¼€

**å¯èƒ½åŸå› **:
- âŒ ç¼ºå°‘ device-id å¤´éƒ¨
- âŒ è®¤è¯å¤±è´¥ï¼ˆToken æ— æ•ˆæˆ–è¿‡æœŸï¼‰
- âŒ é˜²ç«å¢™é˜»æ­¢ 8000 ç«¯å£
- âŒ æœåŠ¡å™¨æœªå¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æŸ¥çœ‹æ—¥å¿—
tail -f logs/xiaozhi-server.log | grep -i websocket

# 2. æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
lsof -i :8000

# 3. æµ‹è¯•è¿æ¥
curl -i -H "device-id: test_device" \
  http://localhost:8000/xiaozhi/v1/
```

### 8.2 éŸ³é¢‘æ— è¾“å‡º

**ç—‡çŠ¶**: éŸ³é¢‘ä¼ è¾“ä½†æ— è½¬å½•ç»“æœ

**å¯èƒ½åŸå› **:
- âŒ VAD æœªå¯ç”¨æˆ–æ¨¡å‹æœªåŠ è½½
- âŒ ASR æ¨¡å‹æŸåæˆ–è·¯å¾„é”™è¯¯
- âŒ éŸ³é¢‘æ ¼å¼ä¸æ˜¯ Opus
- âŒ éŸ³é‡è¿‡å°ï¼ŒVAD æ£€æµ‹ä¸åˆ°

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥æ¨¡å‹æ–‡ä»¶
ls -la models/SenseVoiceSmall/

# 2. æŸ¥çœ‹ ASR/VAD æ—¥å¿—
grep -i "asr\|vad" logs/xiaozhi-server.log | tail -20

# 3. å¢å¤§éŸ³é‡æˆ–æ£€æŸ¥ Opus ç¼–ç å‚æ•°
```

### 8.3 é«˜å»¶è¿Ÿé—®é¢˜

**ç—‡çŠ¶**: å®æ—¶è½¬å†™æœ‰æ˜æ˜¾å»¶è¿Ÿ

**å¯èƒ½åŸå› **:
- âŒ ç½‘ç»œå»¶è¿Ÿé«˜
- âŒ éŸ³é¢‘å—å¤§å°è¿‡å¤§ï¼ˆ>60msï¼‰
- âŒ ASR æ¨ç†æ€§èƒ½ä¸è¶³
- âŒ ç³»ç»Ÿ CPU æ»¡è´Ÿè·

**è§£å†³æ–¹æ¡ˆ**:
```yaml
# å‡å°‘éŸ³é¢‘å—å¤§å°ï¼ˆchunk_duration_msï¼‰
audio:
  sample_rate: 16000
  chunk_duration_ms: 20          # å‡å°å—å¤§å°
  
# æˆ–æå‡ç¡¬ä»¶æ€§èƒ½
```

## 9. æ€»ç»“

WebSocket æœåŠ¡æ˜¯æ•´ä¸ªç³»ç»Ÿçš„é€šä¿¡éª¨å¹²ï¼Œæä¾›äº†ï¼š
- âœ… **å®Œå…¨å¼‚æ­¥** - åŸºäº asyncioï¼Œæ”¯æŒé«˜å¹¶å‘
- âœ… **çµæ´»çš„è®¤è¯** - JWT + ç™½åå•åŒé‡æ”¯æŒ
- âœ… **æµå¼éŸ³é¢‘å¤„ç†** - ä» Opus è§£ç åˆ° TTS ç¼–ç çš„å®Œæ•´é“¾è·¯
- âœ… **å®æ—¶è½¬å†™** - æ”¯æŒéŸ³é¢‘å’Œæ–‡æœ¬å®æ—¶å¤„ç†
- âœ… **ä¼˜é›…çš„é”™è¯¯å¤„ç†** - è¿æ¥æ–­çº¿æ¢å¤å’Œèµ„æºæ¸…ç†
- âœ… **åŠ¨æ€é…ç½®æ›´æ–°** - è¿è¡Œæ—¶æ— ç¼åˆ‡æ¢ AI æ¨¡å—


---

# app.py æ ¸å¿ƒæ¨¡å—è¯¦è§£

## æ¦‚è¿°

`app.py` æ˜¯ Xiaozhi Server çš„ä¸»å…¥å£æ–‡ä»¶ï¼ŒåŒ…å«ç³»ç»Ÿå¯åŠ¨ã€é…ç½®åŠ è½½ã€æœåŠ¡åˆå§‹åŒ–å’Œä¼˜é›…å…³é—­çš„å®Œæ•´é€»è¾‘ã€‚å…¶æ ¸å¿ƒæ¨¡å—å¯¼å…¥å¦‚ä¸‹ï¼š

```python
from config.settings import load_config           # â‘  é…ç½®ç®¡ç†
from config.logger import setup_logging           # â‘¡ æ—¥å¿—ç³»ç»Ÿ
from core.utils.util import get_local_ip, validate_mcp_endpoint  # â‘¢ å·¥å…·å‡½æ•°
from core.http_server import SimpleHttpServer     # â‘£ HTTP æœåŠ¡å™¨
from core.websocket_server import WebSocketServer # â‘¤ WebSocket æœåŠ¡å™¨
from core.utils.util import check_ffmpeg_installed # â‘¥ FFmpeg æ£€æŸ¥
from core.utils.gc_manager import get_gc_manager  # â‘¦ åƒåœ¾å›æ”¶ç®¡ç†
```

## 1. é…ç½®ç®¡ç†æ¨¡å— (config/settings.py)

### åŠŸèƒ½

- ğŸ“‚ **é…ç½®æ–‡ä»¶åŠ è½½** - è¯»å– `config.yaml` æˆ–è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
- âœ… **é…ç½®éªŒè¯** - æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨å’Œæœ‰æ•ˆ
- ğŸ”€ **é…ç½®ä¼˜å…ˆçº§** - æœ¬åœ°é…ç½® > API é…ç½® > é»˜è®¤é…ç½®
- ğŸ” **å¯†é’¥ç®¡ç†** - å¤„ç† auth_keyã€API å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯

### æ ¸å¿ƒåŠŸèƒ½

```python
from config.settings import load_config

# åŠ è½½é…ç½®æ–‡ä»¶
config = load_config()

# é…ç½®ç»“æ„
config = {
    "server": {
        "ip": "0.0.0.0",
        "port": 8000,
        "auth_key": "your-secret-key",
        ...
    },
    "selected_module": ["VAD", "ASR", "LLM", "TTS"],
    "vad": {...},           # VAD é…ç½®
    "asr": {...},           # ASR é…ç½®
    "llm": {...},           # LLM é…ç½®
    "tts": {...},           # TTS é…ç½®
}
```

### é…ç½®åŠ è½½é¡ºåº

```
1. æ£€æŸ¥ data/.config.yamlï¼ˆè‡ªå®šä¹‰æœ¬åœ°é…ç½®ï¼‰
   â”œâ”€ å­˜åœ¨ â†’ ä¼˜å…ˆä½¿ç”¨
   â””â”€ ä¸å­˜åœ¨ â†’ æ£€æŸ¥ API é…ç½®
   
2. æ£€æŸ¥ config_from_api.yamlï¼ˆAPI é…ç½®ï¼‰
   â”œâ”€ read_config_from_api=true â†’ ä»ç®¡ç† API è¯»å–
   â””â”€ å¦åˆ™ â†’ ä½¿ç”¨æœ¬åœ°é…ç½®
   
3. é»˜è®¤é…ç½®æ–‡ä»¶ config.yaml
   â””â”€ æœ€åçš„å¤‡é€‰æ–¹æ¡ˆ
```

## 2. æ—¥å¿—ç³»ç»Ÿæ¨¡å— (config/logger.py)

### åŠŸèƒ½

- ğŸ“ **å½©è‰²æ—¥å¿—è¾“å‡º** - ä½¿ç”¨ `loguru` åº“æä¾›ç¾è§‚çš„æ§åˆ¶å°è¾“å‡º
- ğŸ“Š **æ—¥å¿—åˆ†çº§** - æ”¯æŒ DEBUGã€INFOã€WARNINGã€ERRORã€CRITICAL
- ğŸ“ **æ–‡ä»¶æ—¥å¿—** - æŒä¹…åŒ–å­˜å‚¨åˆ°ç£ç›˜
- ğŸ·ï¸ **æ¨¡å—æ ‡ç­¾** - æ ‡è®°æ—¥å¿—æ¥æºæ¨¡å—
- ğŸ“ˆ **ç‰ˆæœ¬ç®¡ç†** - æ˜¾ç¤ºç³»ç»Ÿç‰ˆæœ¬å·ï¼ˆå½“å‰ï¼š0.8.10ï¼‰

### æ—¥å¿—æ ¼å¼

```
<æ—¶é—´> [ç‰ˆæœ¬_æ¨¡å—] [æ ‡ç­¾] - <çº§åˆ«> - <æ¶ˆæ¯>

ä¾‹å¦‚ï¼š
20260117 10:30:45 [0.8.10_SE_FU_DO_CO] [websocket_server] - INFO - WebSocket Server started: ws://0.0.0.0:8000/xiaozhi/v1/
```

### æ¨¡å—ç¼©å†™è¯´æ˜

```
æ¨¡å— | ç¼©å†™ | ç¤ºä¾‹
----|------|--------
VAD | å‰2å­— | silero_vad â†’ "si"
ASR | å‰2å­— | funasr â†’ "fu"
LLM | å‰2å­— | doubao â†’ "do"
TTS | å‰2å­— | cosyvoice â†’ "co"
```

### ä½¿ç”¨æ–¹æ³•

```python
from config.logger import setup_logging

logger = setup_logging()

# è¾“å‡ºæ—¥å¿—
logger.bind(tag="my_module").info("ä¿¡æ¯æ¶ˆæ¯")
logger.bind(tag="my_module").error("é”™è¯¯æ¶ˆæ¯")
logger.bind(tag="my_module").debug("è°ƒè¯•æ¶ˆæ¯")
```

## 3. å·¥å…·å‡½æ•°æ¨¡å— (core/utils/util.py)

### ä¸»è¦å‡½æ•°

#### 3.1 `get_local_ip()` - è·å–æœ¬åœ° IP åœ°å€

```python
from core.utils.util import get_local_ip

ip = get_local_ip()
# è¿”å›: "192.168.1.13"

# ç”¨é€”ï¼šç”Ÿæˆè¿”å›ç»™è®¾å¤‡çš„ WebSocket åœ°å€
# ws://192.168.1.13:8000/xiaozhi/v1/
```

#### 3.2 `check_ffmpeg_installed()` - æ£€æŸ¥ FFmpeg æ˜¯å¦å®‰è£…

```python
from core.utils.util import check_ffmpeg_installed

try:
    check_ffmpeg_installed()
    print("âœ… FFmpeg å·²å®‰è£…")
except ValueError as e:
    print(f"âŒ FFmpeg æœªå®‰è£…: {e}")
```

**æ£€æŸ¥å†…å®¹**:
- âœ… FFmpeg æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
- âœ… FFmpeg èƒ½å¦æ­£å¸¸è¿è¡Œ
- âœ… ä¾èµ–åº“ï¼ˆå¦‚ libiconvï¼‰æ˜¯å¦å®Œæ•´

**é”™è¯¯å¤„ç†**:
```
å¦‚æœ FFmpeg æœªæ‰¾åˆ°ï¼Œä¼šæŠ›å‡º ValueError å¹¶å»ºè®®ç”¨æˆ·å®‰è£…ï¼š
conda install -c conda-forge ffmpeg
```

#### 3.3 `validate_mcp_endpoint()` - éªŒè¯ MCP æ¥å…¥ç‚¹æ ¼å¼

```python
from core.utils.util import validate_mcp_endpoint

# æœ‰æ•ˆæ ¼å¼
endpoint = "http://192.168.1.100:8000/mcp/"
if validate_mcp_endpoint(endpoint):
    print("âœ… MCP æ¥å…¥ç‚¹æ ¼å¼æ­£ç¡®")

# æ— æ•ˆæ ¼å¼
endpoint = "192.168.1.100/mcp"  # ç¼ºå°‘åè®®
if not validate_mcp_endpoint(endpoint):
    print("âŒ MCP æ¥å…¥ç‚¹æ ¼å¼ä¸æ­£ç¡®")
```

**éªŒè¯è§„åˆ™**:
- âœ… å¿…é¡»åŒ…å«åè®® (http:// æˆ– https://)
- âœ… å¿…é¡»åŒ…å« `/mcp/` è·¯å¾„
- âœ… å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL æ ¼å¼

## 4. HTTP æœåŠ¡å™¨æ¨¡å— (core/http_server.py)

### åŠŸèƒ½

- ğŸŒ **OTA æ¥å£** - ä¸ºè®¾å¤‡æä¾› OTAï¼ˆç©ºä¸­å‡çº§ï¼‰æœåŠ¡
- ğŸ‘ï¸ **è§†è§‰åˆ†ææ¥å£** - å¤„ç†å›¾åƒè¯†åˆ«è¯·æ±‚
- ğŸ“¡ **WebSocket åœ°å€åˆ†å‘** - å‘è®¾å¤‡è¿”å› WebSocket è¿æ¥åœ°å€

### ç›‘å¬åœ°å€

```
HTTP Server: http://0.0.0.0:8003/
```

### ä¸»è¦ç«¯ç‚¹

```
GET/POST /xiaozhi/ota/              â†’ OTA å‡çº§å¤„ç†
GET/POST /mcp/vision/explain        â†’ è§†è§‰åˆ†æå¤„ç†
GET/POST /xiaozhi/ota/version       â†’ è·å–ç‰ˆæœ¬ä¿¡æ¯
GET/POST /xiaozhi/ota/websocket     â†’ è·å– WebSocket åœ°å€
```

### OTA å¤„ç†æµç¨‹

```
è®¾å¤‡è¯·æ±‚ /xiaozhi/ota/
    â†“
SimpleHttpServer.handle_get()
    â†“
OTAHandler å¤„ç†
    â”œâ”€ è·å–è®¾å¤‡ä¿¡æ¯ï¼ˆMACã€ç‰ˆæœ¬ç­‰ï¼‰
    â”œâ”€ æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
    â”œâ”€ ç”Ÿæˆå‡çº§ä¿¡æ¯
    â””â”€ è¿”å› JSON å“åº”
    â†“
è®¾å¤‡æ¥æ”¶å¹¶æ‰§è¡Œå‡çº§
```

### å…¸å‹çš„ OTA å“åº”

```json
{
    "websocket_url": "ws://192.168.1.13:8000/xiaozhi/v1/",
    "version": "0.8.10",
    "has_update": false,
    "mqtt_gateway": null,
    "mqtt_signature_key": null,
    "device_name": "Xiaozhi ESP32"
}
```

## 5. WebSocket æœåŠ¡å™¨æ¨¡å— (core/websocket_server.py)

### åŠŸèƒ½

- ğŸ”Œ **è¿æ¥ç®¡ç†** - æ¥æ”¶å’Œç®¡ç† WebSocket è¿æ¥
- ğŸ” **è®¤è¯æˆæƒ** - JWT ä»¤ç‰Œå’Œç™½åå•è®¤è¯
- ğŸ™ï¸ **éŸ³é¢‘å¤„ç†** - Opus ç¼–è§£ç ã€VADã€ASRã€TTS
- ğŸ’¬ **æ–‡æœ¬å¤„ç†** - æ–‡æœ¬æ¶ˆæ¯ã€æ„å›¾è¯†åˆ«ã€LLM å“åº”
- ğŸ”§ **MCP å·¥å…·è°ƒç”¨** - æ‰§è¡Œå¤–éƒ¨å·¥å…·å’Œ API è°ƒç”¨

### ç›‘å¬åœ°å€

```
WebSocket: ws://0.0.0.0:8000/xiaozhi/v1/
```

### è¯¦ç»†è¯´æ˜

è¯¦è§å‰é¢çš„ **WebSocket æœåŠ¡è¯¦è§£** éƒ¨åˆ†ã€‚

## 6. FFmpeg æ£€æŸ¥æ¨¡å— (core/utils/util.py ä¸­çš„ check_ffmpeg_installed)

### åŠŸèƒ½

åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æ£€æŸ¥ FFmpeg ç¯å¢ƒï¼Œç¡®ä¿éŸ³é¢‘ç¼–è§£ç æ­£å¸¸ã€‚

### æ£€æŸ¥è¿‡ç¨‹

```
app.py å¯åŠ¨
    â†“
è°ƒç”¨ check_ffmpeg_installed()
    â†“
æ‰§è¡Œ ffmpeg -version
    â”œâ”€ æˆåŠŸ â†’ ç»§ç»­å¯åŠ¨
    â””â”€ å¤±è´¥ â†’ æŠ›å‡ºå¼‚å¸¸ï¼Œå»ºè®®ç”¨æˆ·å®‰è£…
    
å¼‚å¸¸æ¶ˆæ¯ç¤ºä¾‹ï¼š
âŒ æ£€æµ‹åˆ° ffmpeg æ— æ³•æ­£å¸¸è¿è¡Œã€‚

å»ºè®®æ‚¨ï¼š
1. ç¡®è®¤å·²æ­£ç¡®æ¿€æ´» conda ç¯å¢ƒï¼›
2. æŸ¥é˜…é¡¹ç›®å®‰è£…æ–‡æ¡£ï¼Œäº†è§£å¦‚ä½•åœ¨ conda ç¯å¢ƒä¸­å®‰è£… ffmpegã€‚

é”™è¯¯è¯¦æƒ…ï¼š
[Errno 2] No such file or directory: 'ffmpeg'
```

### è§£å†³æ–¹æ³•

```bash
# æ–¹å¼ 1ï¼šconda å®‰è£…ï¼ˆæ¨èï¼‰
conda install -c conda-forge ffmpeg -y

# æ–¹å¼ 2ï¼šapt å®‰è£…ï¼ˆUbuntu/Debianï¼‰
sudo apt-get install ffmpeg -y

# æ–¹å¼ 3ï¼šbrew å®‰è£…ï¼ˆmacOSï¼‰
brew install ffmpeg
```

## 7. åƒåœ¾å›æ”¶ç®¡ç†æ¨¡å— (core/utils/gc_manager.py)

### åŠŸèƒ½

- ğŸ§¹ **å®šæ—¶åƒåœ¾å›æ”¶** - å‘¨æœŸæ€§æ‰§è¡Œ Python GCï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- â° **é—´éš”æ§åˆ¶** - å¯é…ç½®çš„ GC æ‰§è¡Œé¢‘ç‡ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰
- ğŸ”’ **çº¿ç¨‹å®‰å…¨** - ä½¿ç”¨é”ç¡®ä¿å¹¶å‘å®‰å…¨
- ğŸ“Š **ç»Ÿè®¡ä¿¡æ¯** - è®°å½• GC æ‰§è¡Œæ¬¡æ•°å’Œå›æ”¶çš„å¯¹è±¡æ•°é‡

### å·¥ä½œåŸç†

```python
from core.utils.gc_manager import get_gc_manager

# è·å– GC ç®¡ç†å™¨å®ä¾‹ï¼ˆé—´éš” 300 ç§’ï¼‰
gc_manager = get_gc_manager(interval_seconds=300)

# å¯åŠ¨ GC å¾ªç¯
await gc_manager.start()

# å¾ªç¯æ‰§è¡Œ
â”œâ”€ ç­‰å¾… 300 ç§’
â”œâ”€ æ‰§è¡Œ gc.collect()ï¼ˆå¼ºåˆ¶åƒåœ¾å›æ”¶ï¼‰
â”œâ”€ è¾“å‡ºå›æ”¶ç»Ÿè®¡ä¿¡æ¯
â””â”€ é‡å¤ä¸Šè¿°æ­¥éª¤

# åœæ­¢ GC å¾ªç¯
await gc_manager.stop()
```

### å¥½å¤„

- âœ… **é˜²æ­¢å†…å­˜å³°å€¼** - ä¸»åŠ¨æ¸…ç†æ— ç”¨å¯¹è±¡
- âœ… **æé«˜ç¨³å®šæ€§** - é•¿æœŸè¿è¡Œä¸ä¼šå†…å­˜æº¢å‡º
- âœ… **å‡å°‘ GIL é”å®š** - é›†ä¸­å¼ GC è€Œéé¢‘ç¹è§¦å‘
- âœ… **æ€§èƒ½ä¼˜åŒ–** - é¿å…åœ¨å…³é”®æ—¶åˆ»è¿›è¡Œ GC

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
[INFO] å¯åŠ¨å…¨å±€GCç®¡ç†å™¨ï¼Œé—´éš”300ç§’
[INFO] [gc_manager] GC æ‰§è¡Œ: å›æ”¶ 1253 ä¸ªå¯¹è±¡
[INFO] [gc_manager] GC æ‰§è¡Œ: å›æ”¶ 987 ä¸ªå¯¹è±¡
[INFO] [gc_manager] GC æ‰§è¡Œ: å›æ”¶ 1456 ä¸ªå¯¹è±¡
...
[INFO] åœæ­¢å…¨å±€GCç®¡ç†å™¨
```

## 8. ç³»ç»Ÿå¯åŠ¨æµç¨‹

app.py çš„ `main()` å‡½æ•°æ‰§è¡Œé¡ºåºï¼š

```
1ï¸âƒ£  check_ffmpeg_installed()
    â””â”€ æ£€æŸ¥ FFmpeg æ˜¯å¦å®‰è£…
    
2ï¸âƒ£  load_config()
    â””â”€ åŠ è½½é…ç½®æ–‡ä»¶
    
3ï¸âƒ£  åˆå§‹åŒ– auth_key
    â”œâ”€ ä»é…ç½®æ–‡ä»¶è·å–
    â”œâ”€ ä» API è·å–
    â””â”€ ç”Ÿæˆéšæœºå¯†é’¥
    
4ï¸âƒ£  monitor_stdin()ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
    â””â”€ ç›‘å¬æ ‡å‡†è¾“å…¥ï¼Œæ¶ˆè´¹å›è½¦é”®
    
5ï¸âƒ£  gc_manager.start()ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
    â””â”€ å¯åŠ¨å®šæ—¶åƒåœ¾å›æ”¶ï¼ˆ5 åˆ†é’Ÿé—´éš”ï¼‰
    
6ï¸âƒ£  WebSocketServer.start()ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
    â””â”€ å¯åŠ¨ WebSocket æœåŠ¡ï¼ˆç›‘å¬ 8000 ç«¯å£ï¼‰
    
7ï¸âƒ£  SimpleHttpServer.start()ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
    â””â”€ å¯åŠ¨ HTTP æœåŠ¡ï¼ˆç›‘å¬ 8003 ç«¯å£ï¼‰
    
8ï¸âƒ£  è¾“å‡ºå¯åŠ¨ä¿¡æ¯
    â”œâ”€ OTA æ¥å£åœ°å€
    â”œâ”€ WebSocket åœ°å€
    â”œâ”€ è§†è§‰åˆ†ææ¥å£
    â””â”€ MCP æ¥å…¥ç‚¹
    
9ï¸âƒ£  wait_for_exit()
    â””â”€ é˜»å¡ç­‰å¾… Ctrl-C æˆ– SIGTERM ä¿¡å·
    
ğŸ”Ÿ ä¼˜é›…å…³é—­
    â”œâ”€ åœæ­¢ GC ç®¡ç†å™¨
    â”œâ”€ å–æ¶ˆæ‰€æœ‰å¼‚æ­¥ä»»åŠ¡
    â”œâ”€ ç­‰å¾…ä»»åŠ¡ç»ˆæ­¢ï¼ˆè¶…æ—¶ 3 ç§’ï¼‰
    â””â”€ æ‰“å°å…³é—­æ¶ˆæ¯
```

## 9. å¯åŠ¨æ—¥å¿—ç¤ºä¾‹

```
20260117 10:30:45 [0.8.10_SI_FU_DO_CO] [app] - INFO - OTAæ¥å£æ˜¯        http://192.168.1.13:8003/xiaozhi/ota/
20260117 10:30:45 [0.8.10_SI_FU_DO_CO] [app] - INFO - è§†è§‰åˆ†ææ¥å£æ˜¯    http://192.168.1.13:8003/mcp/vision/explain
20260117 10:30:45 [0.8.10_SI_FU_DO_CO] [app] - INFO - mcpæ¥å…¥ç‚¹æ˜¯       ws://192.168.1.13:8000/xiaozhi/v1/?from=mqtt_gateway
20260117 10:30:45 [0.8.10_SI_FU_DO_CO] [app] - INFO - Websocketåœ°å€æ˜¯   ws://192.168.1.13:8000/xiaozhi/v1/
20260117 10:30:45 [0.8.10_SI_FU_DO_CO] [app] - INFO - =======ä¸Šé¢çš„åœ°å€æ˜¯websocketåè®®åœ°å€ï¼Œè¯·å‹¿ç”¨æµè§ˆå™¨è®¿é—®=======
20260117 10:30:45 [0.8.10_SI_FU_DO_CO] [app] - INFO - å¦‚æƒ³æµ‹è¯•websocketè¯·ç”¨è°·æ­Œæµè§ˆå™¨æ‰“å¼€testç›®å½•ä¸‹çš„test_page.html
20260117 10:30:45 [0.8.10_SI_FU_DO_CO] [app] - INFO - =============================================================
```


## 10. å…³é”®é…ç½®å’Œç¯å¢ƒå˜é‡

```yaml
# config.yaml ä¸­çš„å…³é”®é…ç½®
server:
  ip: 0.0.0.0                    # ç›‘å¬ IP
  port: 8000                     # WebSocket ç«¯å£
  http_port: 8003                # HTTP ç«¯å£
  auth_key: "your-secret-key"   # JWT å¯†é’¥
  websocket: ws://192.168.1.13:8000/xiaozhi/v1/  # è¿”å›ç»™è®¾å¤‡çš„åœ°å€

selected_module:                  # é€‰æ‹©çš„ AI æ¨¡å—
  - VAD                          # è¯­éŸ³æ´»åŠ¨æ£€æµ‹
  - ASR                          # è¯­éŸ³è¯†åˆ«
  - LLM                          # å¤§è¯­è¨€æ¨¡å‹
  - TTS                          # æ–‡æœ¬è½¬è¯­éŸ³

read_config_from_api: false      # æ˜¯å¦ä» API è¯»å–é…ç½®
```

## 11. æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šå¯åŠ¨æ—¶æŠ¥é”™ "FFmpeg æ— æ³•æ­£å¸¸è¿è¡Œ"

**è§£å†³**ï¼š
```bash
conda activate audio_env
conda install -c conda-forge ffmpeg -y
```

### é—®é¢˜ï¼šWebSocket è¿æ¥å¤±è´¥

**æ£€æŸ¥**ï¼š
1. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ä¸­çš„ WebSocket åœ°å€
2. ç¡®è®¤é˜²ç«å¢™å…è®¸ 8000 ç«¯å£
3. æ£€æŸ¥ device-id æ˜¯å¦åœ¨è¯·æ±‚ä¸­

### é—®é¢˜ï¼šå†…å­˜æŒç»­å¢é•¿

**æ’æŸ¥**ï¼š
1. æ£€æŸ¥ GC ç®¡ç†å™¨æ˜¯å¦è¿è¡Œï¼ˆæ—¥å¿—ä¸­åº”æœ‰å®šæ—¶ GC è¾“å‡ºï¼‰
2. æŸ¥çœ‹æ˜¯å¦æœ‰é•¿æœŸæŒæœ‰å¤§å¯¹è±¡çš„ä»£ç 
3. è€ƒè™‘å¢åŠ  GC æ‰§è¡Œé¢‘ç‡ï¼š`get_gc_manager(interval_seconds=120)`



## é™„å½•ï¼šæŸ¥çœ‹ Docker å®¹å™¨å†…æ–‡ä»¶ç»“æ„

åœ¨å¼€å‘å’Œè°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æŸ¥çœ‹Dockerå®¹å™¨å†…çš„æ–‡ä»¶ç»“æ„å’Œé…ç½®ã€‚ä»¥ä¸‹æ˜¯æŸ¥çœ‹å·²æœ‰å®¹å™¨å†…æ–‡ä»¶çš„æ–¹æ³•ï¼š

### æ–¹æ³•1ï¼šå¯åŠ¨å®¹å™¨åè¿›å…¥æŸ¥çœ‹ï¼ˆæœ€ç®€å•ï¼‰

```bash
# å¯åŠ¨å®¹å™¨è¿›å…¥ shell
docker start -i xiaozhi-esp32-server

# åœ¨å®¹å™¨å†…æ‰§è¡Œå‘½ä»¤
ls -la /
find / -type f -o -type d | head -50
tree /app  # å¦‚æœè£…äº†tree
```

### æ–¹æ³•2ï¼šåœ¨è¿è¡Œä¸­çš„å®¹å™¨æ‰§è¡Œå‘½ä»¤ï¼ˆå®¹å™¨å·²å¯åŠ¨ï¼‰

```bash
# åå°å¯åŠ¨å®¹å™¨
docker start xiaozhi-esp32-server

# åœ¨å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤
docker exec xiaozhi-esp32-server ls -la /
docker exec xiaozhi-esp32-server find / -type f | head -20
docker exec xiaozhi-esp32-server find /app -type f
```

### æ–¹æ³•3ï¼šè¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨ï¼ˆäº¤äº’å¼ï¼‰è¿™ä¸ªæ–¹æ³•å¥½ç”¨

```bash
# å¯åŠ¨å®¹å™¨
docker start xiaozhi-esp32-server

# è¿›å…¥å®¹å™¨çš„shell
docker exec -it xiaozhi-esp32-server /bin/sh
# æˆ–
docker exec -it xiaozhi-esp32-server /bin/bash

# åœ¨å®¹å™¨å†…æŸ¥çœ‹
ls -la /
cd /app
find . -type f
tree -L 3
```

### æ–¹æ³•4ï¼šå¤åˆ¶å®¹å™¨å†…æ–‡ä»¶åˆ°æœ¬åœ°æŸ¥çœ‹

```bash
# æŸ¥çœ‹å®¹å™¨å†…çš„ç‰¹å®šæ–‡ä»¶
docker cp xiaozhi-esp32-server:/app/config.yaml ./

# å¤åˆ¶æ•´ä¸ªç›®å½•
docker cp xiaozhi-esp32-server:/app ./container_app

# æœ¬åœ°æŸ¥çœ‹
cat config.yaml
ls -R container_app
```

### æ–¹æ³•5ï¼šåŸºäºå®¹å™¨åˆ›å»ºé•œåƒåæŸ¥çœ‹

```bash
# åŸºäºç°æœ‰å®¹å™¨åˆ›å»ºé•œåƒ
docker commit xiaozhi-esp32-server xiaozhi-esp32-server:snapshot

# æŸ¥çœ‹é•œåƒå†…å®¹
docker run --rm xiaozhi-esp32-server:snapshot ls -R /
docker run --rm -it xiaozhi-esp32-server:snapshot /bin/bash
```

### é’ˆå¯¹é¡¹ç›®çš„å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹åº”ç”¨ç›®å½•ç»“æ„
docker exec xiaozhi-esp32-server find /app -type f

# æŸ¥çœ‹é…ç½®æ–‡ä»¶å†…å®¹
docker exec xiaozhi-esp32-server cat /app/config.yaml

# è¿›å…¥å®¹å™¨è¯¦ç»†æµè§ˆ
docker exec -it xiaozhi-esp32-server /bin/sh

# åœ¨å®¹å™¨å†…æŸ¥çœ‹Pythonæ–‡ä»¶
docker exec xiaozhi-esp32-server find /app -name "*.py" | head -20

# æŸ¥çœ‹ä¾èµ–å®‰è£…æƒ…å†µ
docker exec xiaozhi-esp32-server pip list
```

### ç†è§£å®¹å™¨ vs é•œåƒ vs æœ¬åœ°æ–‡ä»¶

| æ¦‚å¿µ | è¯´æ˜ | åŒ…å«å†…å®¹ |
|------|------|--------|
| **Imageï¼ˆé•œåƒï¼‰** | åº”ç”¨ç¨‹åºçš„è“å›¾ | æ“ä½œç³»ç»Ÿ + ä¾èµ– + ä»£ç  |
| **Containerï¼ˆå®¹å™¨ï¼‰** | æ­£åœ¨è¿è¡Œçš„é•œåƒå®ä¾‹ | é•œåƒå†…å®¹ + è¿è¡Œæ—¶æ•°æ® |
| **docker start** | å¯åŠ¨å·²åœæ­¢çš„å®¹å™¨ | é‡ç”¨å®¹å™¨çš„æ‰€æœ‰æ•°æ® |
| **docker run** | ä»é•œåƒåˆ›å»ºå¹¶å¯åŠ¨æ–°å®¹å™¨ | éœ€è¦é•œåƒå­˜åœ¨ |
| **docker exec** | åœ¨è¿è¡Œä¸­çš„å®¹å™¨æ‰§è¡Œå‘½ä»¤ | ä¸å½±å“å®¹å™¨ç»§ç»­è¿è¡Œ |
| **docker cp** | å®¹å™¨ä¸æœ¬åœ°æ–‡ä»¶äº’ä¼  | æ”¯æŒåŒå‘å¤åˆ¶ |

---

## é™„å½•ï¼šæµ‹è¯•é¡µé¢ (test_page.html) ä¸åº”ç”¨å…¥å£ (app.js) é…åˆåˆ†æ

### é¡µé¢ç»“æ„ä¸æ¨¡å—åŠ è½½
- **test_page.html**ï¼šä¸»æµ‹è¯•é¡µé¢ï¼ŒåŒ…å«å®Œæ•´çš„ UI ç»“æ„ï¼ˆè®¾å¤‡é…ç½®ã€è¿æ¥ä¿¡æ¯ã€æ¶ˆæ¯è¾“å…¥ã€éŸ³é¢‘æ§åˆ¶ã€MCP å·¥å…·ç®¡ç†ç­‰ï¼‰ã€‚é¡µé¢ä½¿ç”¨ ES6 æ¨¡å—ç³»ç»ŸåŠ è½½è„šæœ¬ã€‚
- **app.js**ï¼šä¸»åº”ç”¨å…¥å£æ–‡ä»¶ï¼Œä½œä¸ºæ¨¡å—å¯¼å…¥ï¼Œè´Ÿè´£åˆå§‹åŒ–æ•´ä¸ªåº”ç”¨é€»è¾‘ã€‚

### è°ƒç”¨å…³ç³»
1. **HTML åŠ è½½é˜¶æ®µ**ï¼š
   - é¡µé¢åŠ è½½æ—¶ï¼Œå…ˆæ‰§è¡Œå†…è” `<script>` æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ `file://` åè®®ï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºè­¦å‘Šæç¤ºä½¿ç”¨ HTTP æœåŠ¡å™¨ã€‚
   - åŠ è½½å¤–éƒ¨è„šæœ¬ï¼š`libopus.js`ï¼ˆOpus è§£ç åº“ï¼‰å’Œ `app.js`ï¼ˆä¸»åº”ç”¨æ¨¡å—ï¼‰ã€‚

2. **åº”ç”¨åˆå§‹åŒ–é˜¶æ®µ**ï¼š
   - `app.js` åˆ›å»º `App` ç±»å®ä¾‹ã€‚
   - å¯¼å…¥å¹¶åˆå§‹åŒ–æ ¸å¿ƒæ¨¡å—ï¼š
     - `logger.js`ï¼šæ—¥å¿—å·¥å…·ã€‚
     - `opus-codec.js`ï¼šOpus ç¼–ç å™¨åˆå§‹åŒ–ã€‚
     - `ui/controller.js`ï¼šUI æ§åˆ¶å™¨ï¼Œç®¡ç†é¡µé¢äº¤äº’ã€‚
     - `audio/player.js`ï¼šéŸ³é¢‘æ’­æ”¾å™¨ï¼Œå¤„ç†éŸ³é¢‘è¾“å‡ºã€‚
     - `mcp/tools.js`ï¼šMCP å·¥å…·ç®¡ç†ã€‚
   - è°ƒç”¨ `app.init()` æ–¹æ³•ï¼Œä¾æ¬¡åˆå§‹åŒ– UIã€æ£€æŸ¥ Opus åº“ã€åˆå§‹åŒ–ç¼–ç å™¨ã€å¯åŠ¨éŸ³é¢‘æ’­æ”¾å™¨ã€åˆå§‹åŒ– MCP å·¥å…·ã€‚

3. **è¿è¡Œæ—¶äº¤äº’**ï¼š
   - UI æ§åˆ¶å™¨ç›‘å¬ç”¨æˆ·æ“ä½œï¼ˆå¦‚è¿æ¥æŒ‰é’®ã€å½•éŸ³æŒ‰é’®ï¼‰ï¼Œè°ƒç”¨ç›¸åº”æ¨¡å—å¤„ç†ã€‚
   - éŸ³é¢‘æ¨¡å—ä¸ WebSocket/MCP é›†æˆï¼Œå®ç°å®æ—¶è¯­éŸ³äº¤äº’ã€‚
   - æ—¥å¿—æ¨¡å—è´¯ç©¿å§‹ç»ˆï¼Œè®°å½•æ‰€æœ‰æ“ä½œçŠ¶æ€ã€‚

### HTTP æœåŠ¡å™¨è®¿é—®è¯´æ˜
- **ä¸ºä»€ä¹ˆéœ€è¦ HTTP æœåŠ¡å™¨**ï¼šé¡µé¢ä½¿ç”¨ ES6 æ¨¡å—ï¼ˆ`type="module"`ï¼‰ï¼Œåœ¨ `file://` åè®®ä¸‹ï¼Œæµè§ˆå™¨å®‰å…¨ç­–ç•¥é™åˆ¶æ¨¡å—åŠ è½½å’Œè·¨åŸŸè¯·æ±‚ï¼Œå¯¼è‡´åŠŸèƒ½å¼‚å¸¸ï¼ˆå¦‚ WebSocket è¿æ¥å¤±è´¥ï¼‰ã€‚
- **å¯åŠ¨æ–¹æ³•**ï¼š
  1. è¿›å…¥ `xiaozhi-server/test` ç›®å½•ã€‚
  2. è¿è¡Œ `python -m http.server 8006`ï¼ˆæˆ–ä½¿ç”¨ nginx ç­‰ï¼‰ã€‚
  3. åœ¨æµè§ˆå™¨è®¿é—® `http://localhost:8006/test_page.html`ã€‚
- **ä¼˜åŠ¿**ï¼šç¡®ä¿æ¨¡å—æ­£ç¡®åŠ è½½ã€WebSocket æ­£å¸¸è¿æ¥ã€éŸ³é¢‘åŠŸèƒ½å®Œæ•´ã€‚

### Python HTTP æœåŠ¡å™¨è¯¦è§£
`python -m http.server 8006` æ˜¯ Python å†…ç½®çš„ç®€å• HTTP æœåŠ¡å™¨å‘½ä»¤ï¼Œç”¨äºå¿«é€Ÿå¯åŠ¨æœ¬åœ° Web æœåŠ¡å™¨ã€‚

#### å‘½ä»¤è§£æ
- `python -m`ï¼šè¿è¡Œ Python æ¨¡å—ä½œä¸ºè„šæœ¬ã€‚
- `http.server`ï¼šPython æ ‡å‡†åº“ä¸­çš„ `http.server` æ¨¡å—ï¼Œæä¾›åŸºæœ¬çš„ HTTP æœåŠ¡å™¨åŠŸèƒ½ã€‚
- `8006`ï¼šæŒ‡å®šç›‘å¬ç«¯å£ï¼ˆé»˜è®¤ 8000ï¼Œå¯è‡ªå®šä¹‰ï¼‰ã€‚

#### ä¸»è¦ä½œç”¨
1. **æ–‡ä»¶æœåŠ¡**ï¼šå°†å½“å‰ç›®å½•ä½œä¸º Web æ ¹ç›®å½•ï¼Œæä¾›é™æ€æ–‡ä»¶è®¿é—®ï¼ˆå¦‚ HTMLã€JSã€CSSã€å›¾ç‰‡ï¼‰ã€‚
2. **HTTP åè®®æ”¯æŒ**ï¼šé€šè¿‡ `http://` åè®®è®¿é—®æ–‡ä»¶ï¼Œç»•è¿‡æµè§ˆå™¨å¯¹ `file://` åè®®çš„é™åˆ¶ï¼ˆå¦‚ CORSã€æ¨¡å—åŠ è½½ï¼‰ã€‚
3. **å¼€å‘æµ‹è¯•**ï¼šé€‚åˆæœ¬åœ°å¼€å‘å’Œæµ‹è¯•ï¼Œæ— éœ€å®‰è£…é¢å¤–æœåŠ¡å™¨è½¯ä»¶ã€‚
4. **ç›®å½•æµè§ˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆç›®å½•åˆ—è¡¨ï¼Œæ”¯æŒæ–‡ä»¶ä¸‹è½½ã€‚

#### ä½¿ç”¨åœºæ™¯
- **æµ‹è¯•é¡µé¢**ï¼šå¦‚ `test_page.html`ï¼Œä½¿ç”¨ ES6 æ¨¡å—æ—¶å¿…é¡»é€šè¿‡ HTTP è®¿é—®ï¼Œé¿å…å®‰å…¨ç­–ç•¥é˜»å¡ã€‚
- **é™æ€ç«™ç‚¹**ï¼šå¿«é€Ÿé¢„è§ˆé™æ€ç½‘ç«™æˆ–å•é¡µåº”ç”¨ã€‚
- **æ–‡ä»¶å…±äº«**ï¼šåœ¨å±€åŸŸç½‘å†…å…±äº«æ–‡ä»¶ï¼ˆå…¶ä»–è®¾å¤‡å¯é€šè¿‡ IP è®¿é—®ï¼‰ã€‚

#### ç¤ºä¾‹ç”¨æ³•
```bash
cd /path/to/directory  # è¿›å…¥ç›®æ ‡ç›®å½•
python -m http.server 8006  # å¯åŠ¨æœåŠ¡å™¨
```
ç„¶ååœ¨æµè§ˆå™¨è®¿é—® `http://localhost:8006` æˆ– `http://127.0.0.1:8006`ã€‚

#### æ³¨æ„äº‹é¡¹
- **å®‰å…¨æ€§**ï¼šä»…é™æœ¬åœ°/å±€åŸŸç½‘ä½¿ç”¨ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒï¼ˆæ— è®¤è¯ã€æ—¥å¿—ç­‰ï¼‰ã€‚
- **Python ç‰ˆæœ¬**ï¼šPython 3 é»˜è®¤æ”¯æŒï¼›Python 2 ä½¿ç”¨ `python -m SimpleHTTPServer`ã€‚
- **ç«¯å£å†²çª**ï¼šç¡®ä¿ 8006 ç«¯å£æœªè¢«å ç”¨ã€‚
- **é˜²ç«å¢™**ï¼šå¯èƒ½éœ€è¦å…è®¸ç«¯å£è®¿é—®ã€‚

##### test html with live server in vscode
Launch a development local Server with live reload feature for static & dynamic pages 

### ES6 (ECMAScript 2015) ç®€ä»‹
ES6 æ˜¯ JavaScript è¯­è¨€çš„ç¬¬å…­ä¸ªä¸»è¦ç‰ˆæœ¬ï¼ˆæ­£å¼åç§°ï¼šECMAScript 2015ï¼‰ï¼Œç”± ECMA å›½é™…æ ‡å‡†åŒ–ç»„ç»‡äº 2015 å¹´å‘å¸ƒã€‚å®ƒå¼•å…¥äº†å¤šé¡¹æ–°ç‰¹æ€§ï¼Œæ˜¾è‘—æå‡äº† JavaScript çš„è¡¨è¾¾åŠ›å’Œå¼€å‘æ•ˆç‡ã€‚

#### æ ¸å¿ƒç‰¹æ€§
- **æ¨¡å—ç³»ç»Ÿ** (`import`/`export`)ï¼šæ”¯æŒæ¨¡å—åŒ–å¼€å‘ï¼Œé¿å…å…¨å±€æ±¡æŸ“ï¼Œå¦‚ `import { log } from './utils/logger.js'`ã€‚
- **ç®­å¤´å‡½æ•°** (`=>`)ï¼šç®€æ´çš„å‡½æ•°è¯­æ³•ï¼Œå¦‚ `const add = (a, b) => a + b`ã€‚
- **ç±» (Classes)**ï¼šé¢å‘å¯¹è±¡ç¼–ç¨‹æ”¯æŒï¼Œå¦‚ `class AudioRecorder { ... }`ã€‚
- **æ¨¡æ¿å­—ç¬¦ä¸²**ï¼šä½¿ç”¨åå¼•å·æ”¯æŒæ’å€¼ï¼Œå¦‚ `` `Hello ${name}!` ``ã€‚
- **è§£æ„èµ‹å€¼**ï¼šç®€åŒ–å˜é‡èµ‹å€¼ï¼Œå¦‚ `const { a, b } = obj`ã€‚
- **Promise å’Œ async/await**ï¼šå¼‚æ­¥ç¼–ç¨‹æ”¹è¿›ã€‚
- **let/const**ï¼šå—çº§ä½œç”¨åŸŸå˜é‡å£°æ˜ã€‚
- **é»˜è®¤å‚æ•°**ï¼šå‡½æ•°å‚æ•°é»˜è®¤å€¼ã€‚
- **å±•å¼€è¿ç®—ç¬¦** (`...`)ï¼šæ•°ç»„/å¯¹è±¡å±•å¼€ã€‚

#### åœ¨é¡¹ç›®ä¸­çš„åº”ç”¨
- `test_page.html` ä½¿ç”¨ `<script type="module">` åŠ è½½ ES6 æ¨¡å—ã€‚
- `app.js` åˆ©ç”¨ `import` è¯­å¥å¯¼å…¥æ¨¡å—ï¼Œå®ç°ä»£ç ç»„ç»‡ã€‚
- æå‡äº†ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§ï¼Œå°¤å…¶åœ¨å¤æ‚åº”ç”¨ä¸­ã€‚

#### æµè§ˆå™¨æ”¯æŒ
ç°ä»£æµè§ˆå™¨ï¼ˆå¦‚ Chromeã€Firefoxï¼‰åŸç”Ÿæ”¯æŒ ES6ï¼›æ—§æµè§ˆå™¨éœ€ä½¿ç”¨ Babel ç­‰è½¬è¯‘å™¨è½¬æ¢ä¸º ES5ã€‚

### CSS æ–‡ä»¶ (test_page.css) ä½œç”¨ä¸è®¾è®¡
`test_page.css` æ˜¯æµ‹è¯•é¡µé¢çš„æ ·å¼è¡¨æ–‡ä»¶ï¼Œè´Ÿè´£å®šä¹‰ `test_page.html` çš„è§†è§‰å¤–è§‚ã€å¸ƒå±€å’Œäº¤äº’æ•ˆæœã€‚

#### ä¸»è¦ä½œç”¨
- **å¸ƒå±€æ§åˆ¶**ï¼šä½¿ç”¨ Flexbox å’Œ Grid å®ç°å“åº”å¼å¸ƒå±€ï¼Œå¦‚ä¸¤æ è®¾å¤‡é…ç½®é¢æ¿ã€‚
- **è§†è§‰ç¾åŒ–**ï¼šè®¾ç½®é¢œè‰²ã€å­—ä½“ã€é˜´å½±ã€åœ†è§’ç­‰ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
- **äº¤äº’åé¦ˆ**ï¼šå®šä¹‰æŒ‰é’®æ‚¬åœã€ç¦ç”¨çŠ¶æ€ã€è¿‡æ¸¡åŠ¨ç”»ã€‚
- **å“åº”å¼è®¾è®¡**ï¼šé€šè¿‡åª’ä½“æŸ¥è¯¢é€‚é…ä¸åŒå±å¹•å°ºå¯¸ã€‚
- **ç»„ä»¶æ ·å¼**ï¼šä¸º UI ç»„ä»¶ï¼ˆå¦‚æ ‡ç­¾é¡µã€æ¨¡æ€æ¡†ã€éŸ³é¢‘å¯è§†åŒ–ï¼‰æä¾›ä¸€è‡´æ ·å¼ã€‚

#### è®¾è®¡æ–¹å¼
- **æ¨¡å—åŒ–ç»“æ„**ï¼šæŒ‰åŠŸèƒ½åˆ†ç»„æ³¨é‡Šï¼ˆå¦‚å…¨å±€æ ·å¼ã€å®¹å™¨å¸ƒå±€ã€æŒ‰é’®æ ·å¼ï¼‰ï¼Œä¾¿äºç»´æŠ¤ã€‚
- **ç°ä»£ CSS æŠ€æœ¯**ï¼š
  - **Flexbox**ï¼šç”¨äºå¼¹æ€§å¸ƒå±€ï¼Œå¦‚ `.two-column-layout`ã€‚
  - **Box-sizing**ï¼šç»Ÿä¸€ç›’æ¨¡å‹ï¼Œé¿å…å¸ƒå±€é—®é¢˜ã€‚
  - **è¿‡æ¸¡åŠ¨ç”»**ï¼š`transition` å±æ€§å®ç°å¹³æ»‘äº¤äº’ã€‚
  - **åª’ä½“æŸ¥è¯¢**ï¼šå“åº”å¼æ–­ç‚¹ï¼ˆå¦‚ `@media (max-width: 768px)`ï¼‰ã€‚
- **è®¾è®¡åŸåˆ™**ï¼šç®€æ´ã€ç°ä»£é£æ ¼ï¼Œä½¿ç”¨é˜´å½±å’Œåœ†è§’å¢å¼ºå±‚æ¬¡æ„Ÿï¼›é¢œè‰²æ–¹æ¡ˆä¸€è‡´ï¼ˆè“è‰²ä¸»é¢˜ï¼‰ã€‚
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…è¿‡åº¦åµŒå¥—ï¼Œä½¿ç”¨é«˜æ•ˆé€‰æ‹©å™¨ã€‚

#### å¢åŠ æ–°åŠŸèƒ½çš„è®¾è®¡æ–¹æ³•
1. **è¯†åˆ«éœ€æ±‚**ï¼šåˆ†ææ–°åŠŸèƒ½ï¼ˆå¦‚æ–°å¢èŠå¤©æ°”æ³¡ã€å¤œé—´æ¨¡å¼ï¼‰ã€‚
2. **è§„åˆ’æ ·å¼ç»“æ„**ï¼š
   - åœ¨ CSS æ–‡ä»¶æœ«å°¾æ·»åŠ æ–°è§„åˆ™ç»„ï¼Œæ³¨é‡Šè¯´æ˜ã€‚
   - ä½¿ç”¨ç±»åçº¦å®šï¼ˆå¦‚ `.new-feature`ï¼‰ï¼Œé¿å…å…¨å±€æ±¡æŸ“ã€‚
3. **å®ç°æ­¥éª¤**ï¼š
   - **å¸ƒå±€**ï¼šä½¿ç”¨ Flexbox/Grid å®šä½æ–°å…ƒç´ ã€‚
   - **æ ·å¼**ï¼šå®šä¹‰é¢œè‰²ã€å­—ä½“ã€é—´è·ï¼Œä¸ç°æœ‰ä¸»é¢˜ä¸€è‡´ã€‚
   - **å“åº”å¼**ï¼šæ·»åŠ åª’ä½“æŸ¥è¯¢ï¼Œç¡®ä¿ç§»åŠ¨ç«¯å…¼å®¹ã€‚
   - **äº¤äº’**ï¼šæ·»åŠ  `:hover`ã€`:active` ç­‰ä¼ªç±»ã€‚
4. **æµ‹è¯•ä¸ä¼˜åŒ–**ï¼š
   - åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·é¢„è§ˆã€‚
   - æ£€æŸ¥å…¼å®¹æ€§ï¼Œä½¿ç”¨ Autoprefixer å¤„ç†å‚å•†å‰ç¼€ã€‚
   - å‹ç¼©æ–‡ä»¶å‡å°‘åŠ è½½æ—¶é—´ã€‚
5. **æ‰©å±•å»ºè®®**ï¼š
   - **ä¸»é¢˜ç³»ç»Ÿ**ï¼šä½¿ç”¨ CSS å˜é‡ï¼ˆå¦‚ `--primary-color`ï¼‰ä¾¿äºåˆ‡æ¢ä¸»é¢˜ã€‚
   - **ç»„ä»¶åº“**ï¼šè€ƒè™‘å¼•å…¥ CSS æ¡†æ¶ï¼ˆå¦‚ Tailwindï¼‰æ ‡å‡†åŒ–è®¾è®¡ã€‚
   - **åŠ¨ç”»å¢å¼º**ï¼šä½¿ç”¨ CSS åŠ¨ç”»åº“æˆ– keyframes æ·»åŠ å¤æ‚æ•ˆæœã€‚

### CSS è¯­æ³•ç®€ä»‹
CSS (Cascading Style Sheets) æ˜¯ä¸€ç§æ ·å¼è¡¨è¯­è¨€ï¼Œç”¨äºæè¿° HTML å…ƒç´ çš„è§†è§‰å¤–è§‚å’Œå¸ƒå±€ã€‚å®ƒä¸æ˜¯ç¼–ç¨‹è¯­è¨€ï¼Œè€Œæ˜¯å£°æ˜å¼è¯­è¨€ï¼Œä¸ JavaScript (JS) å®Œå…¨ä¸åŒã€‚

#### åŸºæœ¬è¯­æ³•
```css
é€‰æ‹©å™¨ {
    å±æ€§: å€¼;
    å±æ€§2: å€¼2;
}
```
- **é€‰æ‹©å™¨**ï¼šç›®æ ‡ HTML å…ƒç´ ï¼ˆå¦‚ `.class`ã€ `#id`ã€ `tag`ï¼‰ã€‚
- **å±æ€§**ï¼šæ ·å¼è§„åˆ™ï¼ˆå¦‚ `color`ã€`font-size`ï¼‰ã€‚
- **å€¼**ï¼šå±æ€§çš„å…·ä½“è®¾ç½®ï¼ˆå¦‚ `red`ã€`16px`ï¼‰ã€‚

#### ä¸ JS çš„åŒºåˆ«
- **CSS**ï¼šé™æ€å£°æ˜æ ·å¼ï¼Œä¸æ¶‰åŠé€»è¾‘æˆ–è®¡ç®—ã€‚æ§åˆ¶å¤–è§‚ï¼ˆå¦‚é¢œè‰²ã€å¸ƒå±€ï¼‰ã€‚
- **JS**ï¼šç¼–ç¨‹è¯­è¨€ï¼Œæ”¯æŒå˜é‡ã€å‡½æ•°ã€å¾ªç¯ã€äº‹ä»¶å¤„ç†ã€‚æ§åˆ¶è¡Œä¸ºå’Œäº¤äº’ã€‚
- **é…åˆä½¿ç”¨**ï¼šHTML æä¾›ç»“æ„ï¼ŒCSS æä¾›æ ·å¼ï¼ŒJS æä¾›åŠŸèƒ½ã€‚ä¸‰è€…å…±åŒæ„å»º Web é¡µé¢ã€‚
- **æ‰§è¡Œæ–¹å¼**ï¼šCSS ç”±æµè§ˆå™¨ç›´æ¥è§£ææ¸²æŸ“ï¼›JS é€šè¿‡ V8 ç­‰å¼•æ“æ‰§è¡Œã€‚

#### åœ¨é¡¹ç›®ä¸­çš„è§’è‰²
`test_page.css` ä½¿ç”¨ CSS è¯­æ³•å®šä¹‰é¡µé¢æ ·å¼ï¼Œä¸ `app.js` çš„ JS é€»è¾‘åˆ†ç¦»ï¼Œç¡®ä¿å…³æ³¨ç‚¹åˆ†ç¦»ã€‚

### CSS å‘ˆç°æœºåˆ¶
æ˜¯çš„ï¼ŒCSS çš„æœ€ç»ˆå‘ˆç°å®Œå…¨ä¾èµ–äºæµè§ˆå™¨çš„è§£é‡Šå’Œæ”¯æŒã€‚æµè§ˆå™¨æ˜¯ CSS çš„æ‰§è¡Œç¯å¢ƒã€‚

#### è§£æä¸æ¸²æŸ“è¿‡ç¨‹
1. **è§£æ**ï¼šæµè§ˆå™¨ä¸‹è½½ CSS æ–‡ä»¶ï¼Œè§£æé€‰æ‹©å™¨å’Œå±æ€§ã€‚
2. **è®¡ç®—æ ·å¼**ï¼šæ ¹æ® CSS è§„åˆ™å’Œ HTML ç»“æ„ï¼Œè®¡ç®—æ¯ä¸ªå…ƒç´ çš„æœ€ç»ˆæ ·å¼ï¼ˆå±‚å ã€ç»§æ‰¿ã€ä¼˜å…ˆçº§ï¼‰ã€‚
3. **å¸ƒå±€**ï¼šä½¿ç”¨å¸ƒå±€å¼•æ“ï¼ˆå¦‚ Flexboxã€Gridï¼‰è®¡ç®—å…ƒç´ ä½ç½®å’Œå°ºå¯¸ã€‚
4. **ç»˜åˆ¶**ï¼šæ¸²æŸ“å¼•æ“ç»˜åˆ¶åƒç´ åˆ°å±å¹•ã€‚

#### æµè§ˆå™¨æ”¯æŒ
- **å¼•æ“å·®å¼‚**ï¼šChrome (Blink)ã€Firefox (Gecko)ã€Safari (WebKit) å¯¹ CSS çš„æ”¯æŒç•¥æœ‰ä¸åŒã€‚
- **å…¼å®¹æ€§**ï¼šæ–°ç‰¹æ€§éœ€æ£€æŸ¥ Can I Useï¼Ÿæ—§æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒï¼ˆå¦‚ IEï¼‰ã€‚
- **ä¼˜åŒ–**ï¼šæµè§ˆå™¨ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿæå‡æ€§èƒ½ï¼›å¼€å‘è€…å·¥å…·å¯è°ƒè¯•æ ·å¼ã€‚

#### å®é™…å½±å“
åœ¨ `test_page.html` ä¸­ï¼ŒCSS ç¡®ä¿å¸ƒå±€ç¾è§‚ï¼Œä½†éœ€é€šè¿‡ HTTP æœåŠ¡å™¨è®¿é—®ä»¥é¿å…è§£æé™åˆ¶ã€‚

### CSS ä¿®æ”¹ç”Ÿæ•ˆæ–¹æ³•
CSS ä¿®æ”¹åï¼Œæµè§ˆå™¨ä¸ä¼šè‡ªåŠ¨æ›´æ–°é¡µé¢ï¼Œéœ€è¦æ‰‹åŠ¨åˆ·æ–°æˆ–ä½¿ç”¨å¼€å‘å·¥å…·ã€‚

#### åŸºæœ¬æ–¹æ³•
1. **åˆ·æ–°é¡µé¢**ï¼šæŒ‰ F5 æˆ– Ctrl+Rï¼ˆWindows/Linuxï¼‰/Cmd+Rï¼ˆMacï¼‰ï¼Œé‡æ–°åŠ è½½é¡µé¢å’Œ CSSã€‚
2. **ç¡¬åˆ·æ–°**ï¼šCtrl+Shift+Rï¼ˆå¼ºåˆ¶æ¸…é™¤ç¼“å­˜ï¼Œé‡æ–°ä¸‹è½½ CSS æ–‡ä»¶ï¼‰ã€‚
3. **å¼€å‘è€…å·¥å…·**ï¼šåœ¨æµè§ˆå™¨ DevTools ä¸­ï¼Œå³é”®åˆ·æ–°æŒ‰é’®é€‰æ‹©â€œæ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½â€ã€‚

#### å¼€å‘ç¯å¢ƒä¼˜åŒ–
- **çƒ­é‡è½½å·¥å…·**ï¼šä½¿ç”¨ Live Server (VS Code æ‰©å±•) æˆ– BrowserSyncï¼Œè‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å˜åŒ–å¹¶åˆ·æ–°é¡µé¢ã€‚
- **æœ¬åœ°æœåŠ¡å™¨**ï¼šå¦‚ `python -m http.server 8006`ï¼Œç¡®ä¿ CSS æ–‡ä»¶æ­£ç¡®åŠ è½½ã€‚
- **CSS é¢„å¤„ç†å™¨**ï¼šä½¿ç”¨ Sass/Less + æ„å»ºå·¥å…·ï¼ˆå¦‚ Webpackï¼‰ï¼Œè‡ªåŠ¨ç¼–è¯‘å’Œæ³¨å…¥ã€‚

#### åŠ¨æ€ä¿®æ”¹
- **JS æ³¨å…¥**ï¼šä½¿ç”¨ `document.styleSheets` æˆ–å†…è”æ ·å¼åŠ¨æ€æ›´æ”¹ï¼Œæ— éœ€åˆ·æ–°ã€‚
- **æ³¨æ„**ï¼šä¿®æ”¹åä¿å­˜æ–‡ä»¶ï¼ŒæœåŠ¡å™¨éœ€æ”¯æŒæ–‡ä»¶ç›‘å¬ï¼ˆå¦‚ Live Reloadï¼‰ã€‚

#### æ•…éšœæ’é™¤
- å¦‚æœä¸ç”Ÿæ•ˆï¼Œæ£€æŸ¥æ–‡ä»¶è·¯å¾„ã€ç¼“å­˜ï¼Œæˆ–ä½¿ç”¨ Incognito æ¨¡å¼æµ‹è¯•ã€‚

### CSS è®¾è®¡å·¥å…·
æ˜¯çš„ï¼Œæœ‰å¤šç§ä¸“ç”¨ CSS è®¾è®¡å·¥å…·ï¼Œå¯ä»¥å¤§å¹…æå‡æ•ˆç‡ï¼Œè€Œéçº¯æ‰‹å·¥ä¸€è¡Œä¸€è¡Œç¼–å†™ã€‚å·¥å…·åˆ†ä¸ºå¯è§†åŒ–ã€æ¡†æ¶å’Œè‡ªåŠ¨åŒ–ç±»å‹ã€‚

#### å¯è§†åŒ–è®¾è®¡å·¥å…·
- **Figma/Adobe XD/Sketch**ï¼šæ‹–æ‹½è®¾è®¡ç•Œé¢ï¼Œå¯¼å‡º CSS ä»£ç ã€‚é€‚åˆåŸå‹è®¾è®¡ã€‚
- **Webflow**ï¼šå¯è§†åŒ–æ„å»ºç½‘ç«™ï¼Œç›´æ¥ç”Ÿæˆ CSS/HTMLã€‚
- **CSS Grid/Flexbox Generators**ï¼šåœ¨çº¿å·¥å…·ç”Ÿæˆå¸ƒå±€ä»£ç ï¼Œå¦‚ CSS Grid Generatorã€‚

#### CSS æ¡†æ¶å’Œåº“
- **Bootstrap/Tailwind CSS**ï¼šé¢„å®šä¹‰ç±»ï¼Œå¦‚ `class="btn btn-primary"`ï¼Œå¿«é€Ÿåº”ç”¨æ ·å¼ã€‚
- **Material Design/Bulma**ï¼šç»„ä»¶åº“ï¼Œæä¾›æŒ‰é’®ã€å¡ç‰‡ç­‰ç°æˆæ ·å¼ã€‚

#### é¢„å¤„ç†å™¨å’Œæ„å»ºå·¥å…·
- **Sass/Less**ï¼šæ‰©å±• CSSï¼Œæ”¯æŒå˜é‡ã€åµŒå¥—ã€å‡½æ•°ï¼Œå¦‚ `$primary: blue; .btn { color: $primary; }`ã€‚
- **PostCSS**ï¼šè‡ªåŠ¨åŒ–æ·»åŠ å‚å•†å‰ç¼€ã€å‹ç¼©ã€‚
- **Webpack/Parcel**ï¼šé›†æˆé¢„å¤„ç†å™¨ï¼Œè‡ªåŠ¨ç¼–è¯‘ã€‚

#### IDE å’Œæ’ä»¶
- **VS Code æ‰©å±•**ï¼šå¦‚ CSS IntelliSenseã€Live Sass Compilerï¼Œæä¾›è‡ªåŠ¨è¡¥å…¨å’Œé¢„è§ˆã€‚
- **æµè§ˆå™¨ DevTools**ï¼šå®æ—¶ç¼–è¾‘ CSSï¼Œé¢„è§ˆæ•ˆæœã€‚

#### è®¾è®¡æµç¨‹
- **åŸºç¡€æ‰‹å·¥**ï¼šç†è§£è¯­æ³•å’ŒåŸç†ã€‚
- **å·¥å…·è¾…åŠ©**ï¼šä½¿ç”¨æ¡†æ¶åŠ é€Ÿå¼€å‘ï¼Œå¯è§†åŒ–å·¥å…·å¿«é€ŸåŸå‹ã€‚
- **æ··åˆä½¿ç”¨**ï¼šå¦‚åœ¨ `test_page.css` ä¸­ç»“åˆæ‰‹å·¥å’Œæ¡†æ¶ç±»ã€‚

è¿™äº›å·¥å…·è®© CSS è®¾è®¡æ›´é«˜æ•ˆï¼Œå°¤å…¶åœ¨å¤æ‚é¡¹ç›®ä¸­ã€‚






## 1.4 WebSocket æ¶ˆæ¯å¤„ç†æ¨¡å—è¯¦ç»†åŠŸèƒ½ä»‹ç»

### 1.4.1 æ¨¡å—æ¦‚è¿°

`websocket.js` æ–‡ä»¶ä½äº `main/xiaozhi-server/test/js/core/network/websocket.js`ï¼Œæ˜¯å®¢æˆ·ç«¯ WebSocket é€šä¿¡çš„æ ¸å¿ƒæ¨¡å—ã€‚è¯¥æ¨¡å—å®ç°äº†å®Œæ•´çš„ WebSocket è¿æ¥ç®¡ç†ã€æ¶ˆæ¯å¤„ç†å’Œ MCP å·¥å…·è°ƒç”¨åŠŸèƒ½ï¼Œä¸ºå‰ç«¯æµ‹è¯•é¡µé¢æä¾›ä¸æœåŠ¡å™¨çš„å®æ—¶é€šä¿¡èƒ½åŠ›ã€‚

### 1.4.2 WebSocketHandler ç±»æ¶æ„

#### æ ¸å¿ƒå±æ€§
- `websocket`: WebSocket å®ä¾‹
- `onConnectionStateChange`: è¿æ¥çŠ¶æ€å˜åŒ–å›è°ƒ
- `onRecordButtonStateChange`: å½•éŸ³æŒ‰é’®çŠ¶æ€å˜åŒ–å›è°ƒ
- `onSessionStateChange`: ä¼šè¯çŠ¶æ€å˜åŒ–å›è°ƒ
- `onSessionEmotionChange`: ä¼šè¯è¡¨æƒ…å˜åŒ–å›è°ƒ
- `currentSessionId`: å½“å‰ä¼šè¯ ID
- `isRemoteSpeaking`: è¿œç¨‹æ˜¯å¦æ­£åœ¨è¯´è¯

#### ä¸»è¦æ–¹æ³•

##### è¿æ¥ç®¡ç†
- `connect()`: å»ºç«‹ WebSocket è¿æ¥
  - æ£€æŸ¥ OTA çŠ¶æ€
  - è°ƒç”¨ OTA è¿æ¥å™¨å»ºç«‹è¿æ¥
  - è®¾ç½®äºŒè¿›åˆ¶æ•°æ®ç±»å‹ä¸º ArrayBuffer
  - åˆå§‹åŒ– MCP æ¨¡å—å’Œå½•éŸ³å™¨
  - è®¾ç½®äº‹ä»¶å¤„ç†å™¨

- `disconnect()`: æ–­å¼€è¿æ¥å¹¶åœæ­¢å½•éŸ³

- `isConnected()`: æ£€æŸ¥è¿æ¥çŠ¶æ€

##### æ¡æ‰‹åè®®
- `sendHelloMessage()`: å‘é€ hello æ¡æ‰‹æ¶ˆæ¯
  - åŒ…å«è®¾å¤‡ IDã€åç§°ã€MAC åœ°å€ã€ä»¤ç‰Œ
  - å£°æ˜æ”¯æŒ MCP åŠŸèƒ½
  - ç­‰å¾…æœåŠ¡å™¨å“åº”å¹¶è¿”å›ä¼šè¯ ID

##### æ¶ˆæ¯å¤„ç†

###### æ–‡æœ¬æ¶ˆæ¯å¤„ç† (`handleTextMessage`)
- **hello**: å¤„ç†æœåŠ¡å™¨æ¡æ‰‹å“åº”
- **tts**: å¤„ç† TTS æ¶ˆæ¯ï¼ˆè¯­éŸ³åˆæˆï¼‰
  - start: å¼€å§‹è¯­éŸ³ä¼ è¾“
  - sentence_start: è¯­éŸ³æ®µå¼€å§‹
  - sentence_end: è¯­éŸ³æ®µç»“æŸ
  - stop: åœæ­¢è¯­éŸ³ä¼ è¾“ï¼Œæ¸…ç©ºéŸ³é¢‘ç¼“å†²
- **audio**: å¤„ç†éŸ³é¢‘æ§åˆ¶æ¶ˆæ¯
- **stt**: å¤„ç†è¯­éŸ³è¯†åˆ«ç»“æœï¼Œæ·»åŠ åˆ°å¯¹è¯
- **llm**: å¤„ç†å¤§æ¨¡å‹å›å¤
  - æ£€æµ‹å¹¶æå–è¡¨æƒ…ç¬¦å·
  - æ›´æ–°ä¼šè¯è¡¨æƒ…çŠ¶æ€
  - æ·»åŠ æ–‡æœ¬æ¶ˆæ¯åˆ°å¯¹è¯ç•Œé¢
- **mcp**: å¤„ç† MCP å·¥å…·è°ƒç”¨æ¶ˆæ¯

###### äºŒè¿›åˆ¶æ¶ˆæ¯å¤„ç† (`handleBinaryMessage`)
- å¤„ç†éŸ³é¢‘æ•°æ®ï¼ˆOpus ç¼–ç ï¼‰
- æ”¯æŒ ArrayBuffer å’Œ Blob æ ¼å¼
- å°†éŸ³é¢‘æ•°æ®åŠ å…¥æ’­æ”¾é˜Ÿåˆ—

##### MCP å·¥å…·è°ƒç”¨ (`handleMCPMessage`)
- **tools/list**: è¿”å›å¯ç”¨ MCP å·¥å…·åˆ—è¡¨
- **tools/call**: æ‰§è¡ŒæŒ‡å®šå·¥å…·å¹¶è¿”å›ç»“æœ
- **initialize**: å¤„ç†å·¥å…·åˆå§‹åŒ–è¯·æ±‚

##### æ¶ˆæ¯å‘é€
- `sendTextMessage(text)`: å‘é€æ–‡æœ¬æ¶ˆæ¯
  - æ”¯æŒæ‰‹åŠ¨æ¨¡å¼
  - æ£€æµ‹åˆ°è¿œç¨‹è¯´è¯æ—¶å‘é€æ‰“æ–­æ¶ˆæ¯
  - åŒ…å«ä¼šè¯ ID å’Œæ‰“æ–­åŸå› 

### 1.4.3 äº‹ä»¶å¤„ç†å™¨è®¾ç½®

#### onopen äº‹ä»¶
- è®°å½•è¿æ¥æˆåŠŸæ—¥å¿—
- è§¦å‘è¿æ¥çŠ¶æ€å˜åŒ–å›è°ƒ
- è®¾ç½®åˆå§‹ä¼šè¯çŠ¶æ€ä¸ºè†å¬ä¸­
- è‡ªåŠ¨å‘é€ hello æ¡æ‰‹æ¶ˆæ¯

#### onclose äº‹ä»¶
- è®°å½•æ–­å¼€è¿æ¥æ—¥å¿—
- è§¦å‘è¿æ¥çŠ¶æ€å˜åŒ–å›è°ƒ
- åœæ­¢å½•éŸ³å™¨

#### onerror äº‹ä»¶
- è®°å½•é”™è¯¯ä¿¡æ¯
- è§¦å‘è¿æ¥çŠ¶æ€å˜åŒ–å›è°ƒ

#### onmessage äº‹ä»¶
- åŒºåˆ†æ–‡æœ¬æ¶ˆæ¯å’ŒäºŒè¿›åˆ¶æ¶ˆæ¯
- JSON è§£ææ–‡æœ¬æ¶ˆæ¯
- å¤„ç†äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®
- å¼‚å¸¸å¤„ç†å’Œé”™è¯¯æ—¥å¿—

### 1.4.4 å•ä¾‹æ¨¡å¼å®ç°

ä½¿ç”¨å•ä¾‹æ¨¡å¼ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ª WebSocketHandler å®ä¾‹ï¼š

```javascript
let wsHandlerInstance = null;

export function getWebSocketHandler() {
    if (!wsHandlerInstance) {
        wsHandlerInstance = new WebSocketHandler();
    }
    return wsHandlerInstance;
}
```

### 1.4.5 é›†æˆæ¨¡å—

è¯¥æ¨¡å—ä¸å…¶ä»–æ¨¡å—çš„é›†æˆå…³ç³»ï¼š
- **logger.js**: æ—¥å¿—è®°å½•
- **dom-helper.js**: UI æ¶ˆæ¯æ·»åŠ 
- **ota-connector.js**: OTA è¿æ¥å»ºç«‹
- **config/manager.js**: é…ç½®ç®¡ç†
- **audio/player.js**: éŸ³é¢‘æ’­æ”¾
- **audio/recorder.js**: éŸ³é¢‘å½•éŸ³
- **mcp/tools.js**: MCP å·¥å…·ç®¡ç†

### 1.4.6 é€šä¿¡åè®®

#### å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨æ¶ˆæ¯ç±»å‹
- `hello`: æ¡æ‰‹æ¶ˆæ¯
- `listen`: æ–‡æœ¬æ¶ˆæ¯ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰
- `abort`: æ‰“æ–­æ¶ˆæ¯

#### æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ç±»å‹
- `hello`: æ¡æ‰‹å“åº”
- `tts`: è¯­éŸ³åˆæˆçŠ¶æ€
- `audio`: éŸ³é¢‘æ§åˆ¶
- `stt`: è¯­éŸ³è¯†åˆ«ç»“æœ
- `llm`: å¤§æ¨¡å‹å›å¤
- `mcp`: MCP å·¥å…·è°ƒç”¨
- äºŒè¿›åˆ¶æ•°æ®: Opus éŸ³é¢‘æµ

### 1.4.7 é”™è¯¯å¤„ç†å’Œæ—¥å¿—

- æ‰€æœ‰æ“ä½œéƒ½æœ‰ try-catch é”™è¯¯å¤„ç†
- ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—ç³»ç»Ÿè®°å½•æ“ä½œçŠ¶æ€
- æ¡æ‰‹è¶…æ—¶å¤„ç†ï¼ˆ5ç§’ï¼‰
- æ¶ˆæ¯è§£æå¼‚å¸¸å¤„ç†
- è¿æ¥å¤±è´¥çŠ¶æ€ç®¡ç†

### 1.4.8 æ€§èƒ½ä¼˜åŒ–

- å¼‚æ­¥æ¶ˆæ¯å¤„ç†
- éŸ³é¢‘æ•°æ®æµå¼å¤„ç†
- äº‹ä»¶é©±åŠ¨æ¶æ„
- å†…å­˜ç®¡ç†ï¼ˆæ¸…ç©ºéŸ³é¢‘ç¼“å†²ï¼‰

è¯¥æ¨¡å—ä¸ºå‰ç«¯æµ‹è¯•é¡µé¢æä¾›äº†å®Œæ•´çš„ WebSocket é€šä¿¡èƒ½åŠ›ï¼Œæ”¯æŒå®æ—¶è¯­éŸ³å¯¹è¯ã€MCP å·¥å…·è°ƒç”¨å’ŒçŠ¶æ€ç®¡ç†ï¼Œæ˜¯è¿æ¥ç”¨æˆ·ç•Œé¢ä¸åç«¯æœåŠ¡çš„å…³é”®æ¡¥æ¢ã€‚

## 1.5 åº”ç”¨ä¸»å…¥å£ (app.js) è¯¦ç»†è®¾è®¡

### 1.5.1 æ–‡ä»¶æ¦‚è¿°

`app.js` æ–‡ä»¶ä½äº `main/xiaozhi-server/test/js/app.js`ï¼Œæ˜¯æ•´ä¸ªå‰ç«¯æµ‹è¯•åº”ç”¨çš„ä¸»å…¥å£ã€‚è¯¥æ–‡ä»¶è´Ÿè´£ï¼š
- åº”ç”¨çš„åˆå§‹åŒ–é¡ºåºç®¡ç†
- å„ä¸ªæ¨¡å—çš„åè°ƒå¯åŠ¨
- ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å…¨å±€åº”ç”¨çŠ¶æ€ç»´æŠ¤

### 1.5.2 æ¨¡å—å±‚çº§å…³ç³»

```mermaid
graph TB
    subgraph Browser["ğŸŒ æµè§ˆå™¨ç¯å¢ƒ"]
        DOM["DOM æ–‡æ¡£æ ‘"]
        DOMEvent["DOMContentLoaded äº‹ä»¶"]
    end
    
    subgraph App["ğŸ“± App ä¸»åº”ç”¨"]
        AppClass["App ç±»"]
        Init["init() æ–¹æ³•"]
    end
    
    subgraph UILayer["ğŸ¨ UI å±‚"]
        UIController["UIController<br/>UI æ§åˆ¶å™¨"]
        DOMHelper["dom-helper.js<br/>DOM è¾…åŠ©"]
        Logger["logger.js<br/>æ—¥å¿—ç³»ç»Ÿ"]
    end
    
    subgraph CoreLayer["ğŸ”§ æ ¸å¿ƒå±‚"]
        AudioPlayer["AudioPlayer<br/>éŸ³é¢‘æ’­æ”¾"]
        Recorder["AudioRecorder<br/>éŸ³é¢‘å½•åˆ¶"]
        OpusCodec["Opus ç¼–ç è§£ç "]
    end
    
    subgraph NetworkLayer["ğŸŒ ç½‘ç»œå±‚"]
        WebSocketHandler["WebSocketHandler<br/>WebSocket å¤„ç†"]
        OTAConnector["OTA è¿æ¥å™¨"]
    end
    
    subgraph ToolLayer["ğŸ”§ å·¥å…·å±‚"]
        MCPTools["MCP å·¥å…·"]
        ConfigManager["ConfigManager<br/>é…ç½®ç®¡ç†"]
    end
    
    DOM --> DOMEvent
    DOMEvent --> AppClass
    AppClass --> Init
    
    Init --> UIController
    Init --> OpusCodec
    Init --> AudioPlayer
    Init --> MCPTools
    
    UIController --> DOMHelper
    UIController --> Logger
    UIController --> WebSocketHandler
    
    AudioPlayer --> OpusCodec
    Recorder --> OpusCodec
    
    WebSocketHandler --> ConfigManager
    WebSocketHandler --> AudioPlayer
    WebSocketHandler --> Recorder
    WebSocketHandler --> MCPTools
```

### 1.5.3 åº”ç”¨åˆå§‹åŒ–æµç¨‹

```mermaid
flowchart TD
    Start["ğŸš€ æµè§ˆå™¨åŠ è½½ app.js"] --> CheckDOM{"DOM æ˜¯å¦<br/>åŠ è½½å®Œæˆ?"}
    
    CheckDOM -->|å¦| ListenDOM["ç›‘å¬ DOMContentLoaded<br/>äº‹ä»¶"]
    CheckDOM -->|æ˜¯| CreateApp["åˆ›å»º App å®ä¾‹"]
    ListenDOM --> CreateApp
    
    CreateApp --> CallInit["è°ƒç”¨ app.init()"]
    
    CallInit --> InitStep1["â‘  åˆå§‹åŒ– UIController<br/>- è·å– UI æ§åˆ¶å™¨å•ä¾‹<br/>- è°ƒç”¨ init() æ–¹æ³•"]
    
    InitStep1 --> InitStep2["â‘¡ æ£€æŸ¥ Opus åº“<br/>- éªŒè¯ Opus WASM<br/>åº“æ˜¯å¦åŠ è½½"]
    
    InitStep2 --> InitStep3["â‘¢ åˆå§‹åŒ– Opus ç¼–ç å™¨<br/>- åˆå§‹åŒ–éŸ³é¢‘ç¼–ç å™¨<br/>- è®¾ç½®ç¼–ç å‚æ•°"]
    
    InitStep3 --> InitStep4["â‘£ åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾å™¨<br/>- åˆ›å»º AudioContext<br/>- å¯åŠ¨éŸ³é¢‘å¤„ç†ç®¡é“<br/>- ç›‘å¬éŸ³é¢‘äº‹ä»¶"]
    
    InitStep4 --> InitStep5["â‘¤ åˆå§‹åŒ– MCP å·¥å…·<br/>- åŠ è½½å·¥å…·æ¨¡å—<br/>- æ³¨å†Œå·¥å…·å®šä¹‰"]
    
    InitStep5 --> LogSuccess["æ—¥å¿—: 'åº”ç”¨åˆå§‹åŒ–å®Œæˆ'"]
    LogSuccess --> Ready["âœ… åº”ç”¨å°±ç»ª<br/>ç­‰å¾…ç”¨æˆ·äº¤äº’"]
    
    style Start fill:#90EE90
    style Ready fill:#FFB6C6
    style InitStep1 fill:#87CEEB
    style InitStep2 fill:#87CEEB
    style InitStep3 fill:#87CEEB
    style InitStep4 fill:#87CEEB
    style InitStep5 fill:#87CEEB
```

### 1.5.4 æ•°æ®æµæ¡†å›¾

```mermaid
graph LR
    subgraph Input["ğŸ“¥ è¾“å…¥æº"]
        Mic["ğŸ¤ éº¦å…‹é£"]
        Button["ğŸ”˜ æŒ‰é’®"]
        Server["ğŸ–¥ï¸ æœåŠ¡å™¨"]
    end
    
    subgraph Processing["âš™ï¸ å¤„ç†"]
        Recorder["å½•éŸ³å™¨<br/>Recorder"]
        WebSocket["WebSocket<br/>Handler"]
        Decoder["Opus è§£ç å™¨<br/>Decoder"]
        Encoder["Opus ç¼–ç å™¨<br/>Encoder"]
    end
    
    subgraph Playback["ğŸ”Š æ’­æ”¾/è¾“å‡º"]
        Player["éŸ³é¢‘æ’­æ”¾å™¨<br/>Player"]
        UI["UI æ›´æ–°<br/>Controller"]
        Speaker["ğŸ”Š æ‰¬å£°å™¨"]
        Screen["ğŸ“± å±å¹•"]
    end
    
    Mic -->|åŸå§‹éŸ³é¢‘<br/>PCM 16bit| Recorder
    Button -->|äº‹ä»¶| UI
    Server -->|WebSocket<br/>æ¶ˆæ¯| WebSocket
    
    Recorder -->|PCM æ•°æ®| Encoder
    Encoder -->|Opus æ•°æ®<br/>å‹ç¼©| WebSocket
    
    WebSocket -->|Opus æ•°æ®<br/>è§£å‹ç¼©| Decoder
    WebSocket -->|æ–‡æœ¬æ¶ˆæ¯<br/>STT/LLM/TTS| UI
    
    Decoder -->|PCM æ•°æ®<br/>ç¼“å†²| Player
    Player -->|éŸ³é¢‘å¸§| Speaker
    
    UI -->|DOM æ›´æ–°<br/>æ—¥å¿—è¾“å‡º| Screen
    
    style Input fill:#FFE4B5
    style Processing fill:#E6F3FF
    style Playback fill:#F0F8FF
```

### 1.5.5 App ç±»è®¾è®¡

#### æ ¸å¿ƒå±æ€§
```javascript
class App {
    uiController = null;      // UI æ§åˆ¶å™¨å®ä¾‹
    audioPlayer = null;       // éŸ³é¢‘æ’­æ”¾å™¨å®ä¾‹
}
```

#### åˆå§‹åŒ–é¡ºåº
åˆå§‹åŒ–é¡ºåºéµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
1. **UI æ¡†æ¶ä¼˜å…ˆ**: ç¡®ä¿ç”¨æˆ·ç•Œé¢å¯ç”¨
2. **éŸ³é¢‘åŸºç¡€è®¾æ–½**: è®¾ç½®ç¼–ç /è§£ç èƒ½åŠ›
3. **éŸ³é¢‘å¤„ç†**: å¯åŠ¨éŸ³é¢‘æ’­æ”¾ç®¡é“
4. **å·¥å…·ç³»ç»Ÿ**: åŠ è½½å¯ç”¨å·¥å…·

#### å•ä¾‹ç®¡ç†
```javascript
const app = new App();  // å…¨å±€å”¯ä¸€å®ä¾‹
export default app;     // å¯¼å‡ºä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
```

### 1.5.6 å¯åŠ¨äº‹ä»¶å¤„ç†

```javascript
if (document.readyState === 'loading') {
    // DOM ä»åœ¨åŠ è½½ï¼Œç­‰å¾…äº‹ä»¶
    document.addEventListener('DOMContentLoaded', () => app.init());
} else {
    // DOM å·²åŠ è½½ï¼Œç›´æ¥åˆå§‹åŒ–
    app.init();
}
```

è¿™ç§å¤„ç†æ–¹å¼ç¡®ä¿ï¼š
- å¦‚æœè„šæœ¬åœ¨ DOM è§£æè¿‡ç¨‹ä¸­åŠ è½½ï¼Œåˆ™ç­‰å¾…å®Œæˆ
- å¦‚æœè„šæœ¬åœ¨ DOM åŠ è½½å®ŒæˆååŠ è½½ï¼Œåˆ™ç«‹å³åˆå§‹åŒ–
- é¿å… DOM å…ƒç´ æœªå°±ç»ªå¯¼è‡´çš„é”™è¯¯

### 1.5.7 æ¨¡å—é—´çš„äº¤äº’æµç¨‹

```mermaid
sequenceDiagram
    participant Browser as æµè§ˆå™¨
    participant App as App<br/>ä¸»åº”ç”¨
    participant UI as UIController<br/>UI æ§åˆ¶å™¨
    participant Opus as OpusCodec<br/>Opus ç¼–ç å™¨
    participant Player as AudioPlayer<br/>éŸ³é¢‘æ’­æ”¾å™¨
    participant MCP as MCPTools<br/>MCP å·¥å…·
    
    Browser->>App: è§¦å‘ DOMContentLoaded
    App->>App: åˆ›å»º App å®ä¾‹
    App->>App: è°ƒç”¨ init()
    
    App->>UI: getUIController()
    UI->>UI: init() åˆå§‹åŒ–
    
    App->>Opus: checkOpusLoaded()
    Opus->>Opus: éªŒè¯ WASM åº“
    
    App->>Opus: initOpusEncoder()
    Opus->>Opus: åˆå§‹åŒ–ç¼–ç å™¨
    
    App->>Player: getAudioPlayer()
    Player->>Player: start() å¯åŠ¨
    Player->>Player: åˆ›å»º AudioContext
    
    App->>MCP: initMcpTools()
    MCP->>MCP: åŠ è½½å·¥å…·å®šä¹‰
    
    App->>App: æ—¥å¿—æˆåŠŸä¿¡æ¯
    App->>Browser: åº”ç”¨å°±ç»ª
```

### 1.5.8 é”™è¯¯å¤„ç†

- **DOM åŠ è½½æ£€æŸ¥**: æ ¹æ® `document.readyState` åŠ¨æ€å¤„ç†
- **Opus åº“éªŒè¯**: æ£€æŸ¥ WASM åº“æ˜¯å¦æ­£ç¡®åŠ è½½
- **å¼‚æ­¥åˆå§‹åŒ–**: éŸ³é¢‘æ’­æ”¾å™¨ä½¿ç”¨ `await` ç¡®ä¿å¼‚æ­¥æ“ä½œå®Œæˆ
- **æ—¥å¿—è®°å½•**: æ‰€æœ‰å…³é”®æ­¥éª¤è®°å½•æ—¥å¿—ä¾¿äºè°ƒè¯•

### 1.5.9 æ¶æ„ç‰¹ç‚¹

- **æ¨¡å—åŒ–è®¾è®¡**: å„æ¨¡å—ç‹¬ç«‹ï¼Œé€šè¿‡å•ä¾‹æ¨¡å¼ç®¡ç†
- **å»¶è¿Ÿåˆå§‹åŒ–**: æŒ‰éœ€åˆå§‹åŒ–ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
- **äº‹ä»¶é©±åŠ¨**: äº‹ä»¶é©±åŠ¨çš„åˆå§‹åŒ–æµç¨‹
- **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°æ¨¡å—åˆ°åˆå§‹åŒ–æµç¨‹
- **é”™è¯¯éš”ç¦»**: å„æ¨¡å—åˆå§‹åŒ–é”™è¯¯ä¸å½±å“å…¶ä»–æ¨¡å—

è¯¥å…¥å£æ–‡ä»¶æ˜¯æ•´ä¸ªåº”ç”¨çš„éª¨æ¶ï¼Œåè°ƒå„ä¸ªå­ç³»ç»Ÿçš„å¯åŠ¨ï¼Œä¸ºåç»­ç”¨æˆ·äº¤äº’å¥ å®šåŸºç¡€ã€‚




